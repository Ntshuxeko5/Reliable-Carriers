<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - Reliable Carriers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapsApiKey} + '&libraries=places&callback=initMap'" async defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'reliable-blue': {
                            50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
                            400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1e40af',
                            800: '#1e3a8a', 900: '#1e40af',
                        },
                        'reliable-yellow': {
                            50: '#fefce8', 100: '#fef9c3', 200: '#fef08a', 300: '#fde047',
                            400: '#facc15', 500: '#eab308', 600: '#ca8a04', 700: '#a16207',
                            800: '#854d0e', 900: '#713f12',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.95); }
        .hover-lift { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .gradient-text { background: linear-gradient(135deg, #3b82f6, #1e40af); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .payment-card { background: linear-gradient(145deg, #ffffff, #f8fafc); }
        .success-animation { animation: successPulse 2s ease-in-out infinite; }
        @keyframes successPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <div th:replace="~{fragments/navbar :: navbar(navLinks=${navLinks})}"></div>

    <!-- Hero Section -->
    <section class="bg-gradient-to-br from-reliable-blue-600 via-reliable-blue-700 to-reliable-blue-800 py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">
                <i class="fas fa-credit-card mr-3"></i>Complete Your Payment
            </h1>
            <p class="text-xl text-blue-100">Secure payment powered by Paystack</p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Progress Indicator -->
        <div class="mb-8">
            <div class="flex items-center justify-center space-x-4">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-check text-white text-sm"></i>
                    </div>
                    <span class="ml-2 text-gray-700 font-medium">Quote</span>
                </div>
                <div class="w-16 h-1 bg-gray-300"></div>
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-reliable-yellow-400 rounded-full flex items-center justify-center">
                        <i class="fas fa-credit-card text-white text-sm"></i>
                    </div>
                    <span class="ml-2 text-gray-700 font-medium">Payment</span>
                </div>
                <div class="w-16 h-1 bg-gray-300"></div>
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                        <i class="fas fa-check-circle text-gray-500 text-sm"></i>
                    </div>
                    <span class="ml-2 text-gray-500 font-medium">Confirmation</span>
                </div>
            </div>
        </div>

        <!-- Payment Card -->
        <div class="payment-card rounded-2xl shadow-2xl p-8 hover-lift">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-credit-card mr-3 gradient-text"></i>Complete Your Payment
                </h1>
                <p class="text-gray-600">Secure payment powered by Paystack</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Service Summary -->
                <div class="space-y-6">
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-box mr-2 text-blue-600"></i>Your Package
                        </h3>
                        
                        <!-- Package Details -->
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Service:</span>
                                <span class="font-semibold text-gray-800" id="serviceType">Express Delivery</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Distance:</span>
                                <span class="font-semibold text-gray-800" id="distance">25 km</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Weight:</span>
                                <span class="font-semibold text-gray-800" id="weight">2.5 kg</span>
                            </div>
                        </div>

                        <!-- Addresses -->
                        <div class="border-t pt-4">
                            <h4 class="font-semibold text-gray-800 mb-3">
                                <i class="fas fa-map-marker-alt mr-2 text-green-600"></i>Delivery Addresses
                            </h4>
                            <div class="space-y-2">
                                <div class="flex items-start">
                                    <i class="fas fa-hand-holding-box text-blue-500 mt-1 mr-2"></i>
                                    <div>
                                        <div class="text-sm text-gray-600">Pickup from:</div>
                                        <div class="font-medium text-gray-800" id="pickupAddressDisplay">Loading address...</div>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <i class="fas fa-truck text-green-500 mt-1 mr-2"></i>
                                    <div>
                                        <div class="text-sm text-gray-600">Deliver to:</div>
                                        <div class="font-medium text-gray-800" id="deliveryAddressDisplay">Loading address...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Info -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-user mr-2 text-blue-600"></i>Customer Information
                        </h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Name:</span>
                                <span class="font-semibold text-gray-800" id="customerName">
                                    <span th:if="${isAuthenticated}" th:text="${userFirstName + ' ' + userLastName}">Loading...</span>
                                    <span th:if="${!isAuthenticated}">Guest User</span>
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Email:</span>
                                <span class="font-semibold text-gray-800" id="customerEmail" th:text="${userEmail ?: 'Not provided'}">Not provided</span>
                            </div>
                            <div class="flex justify-between" id="customerPhoneRow" style="display: none;">
                                <span class="text-gray-600">Phone:</span>
                                <span class="font-semibold text-gray-800" id="customerPhone">Not provided</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Booking Details -->
                    <div class="bg-gray-50 rounded-xl p-6" id="additionalDetails" style="display: none;">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-info-circle mr-2 text-blue-600"></i>Additional Details
                        </h3>
                        <div class="space-y-2" id="additionalDetailsContent">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="space-y-6">
                    <!-- Total Amount -->
                    <div class="bg-gradient-to-r from-reliable-blue-600 to-reliable-blue-800 rounded-xl p-6 text-white">
                        <div class="text-center">
                            <h3 class="text-lg font-semibold mb-2">Total Amount</h3>
                            <div class="text-4xl font-bold" id="totalAmount">R0.00</div>
                            <p class="text-blue-100 mt-2">All fees included</p>
                        </div>
                    </div>

                    <!-- Payment Button -->
                    <div class="space-y-4">
                        <button id="paystackBtn" class="w-full bg-black hover:bg-gray-800 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 flex items-center justify-center shadow-lg hover:shadow-xl transform hover:scale-105">
                            <i class="fas fa-lock mr-3"></i>
                            <span id="payButtonText">Pay R0.00 Securely</span>
                        </button>
                        
                        <div class="text-center">
                            <div class="flex items-center justify-center space-x-4 text-sm text-gray-600">
                                <div class="flex items-center">
                                    <i class="fas fa-shield-alt text-green-500 mr-1"></i>
                                    <span>SSL Secured</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-credit-card text-blue-500 mr-1"></i>
                                    <span>All Cards Accepted</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-mobile-alt text-purple-500 mr-1"></i>
                                    <span>Mobile Friendly</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h4 class="font-semibold text-gray-800 mb-3">Accepted Payment Methods</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="flex items-center justify-center bg-white rounded-lg p-3">
                                <i class="fab fa-cc-visa text-2xl text-blue-600"></i>
                            </div>
                            <div class="flex items-center justify-center bg-white rounded-lg p-3">
                                <i class="fab fa-cc-mastercard text-2xl text-red-600"></i>
                            </div>
                            <div class="flex items-center justify-center bg-white rounded-lg p-3">
                                <i class="fas fa-university text-2xl text-green-600"></i>
                            </div>
                            <div class="flex items-center justify-center bg-white rounded-lg p-3">
                                <i class="fas fa-mobile-alt text-2xl text-purple-600"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Notice -->
        <div class="mt-8 text-center">
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-6">
                <div class="flex items-center justify-center space-x-4 text-white">
                    <i class="fas fa-shield-alt text-green-400 text-xl"></i>
                    <div>
                        <div class="font-semibold">Your payment is secure</div>
                        <div class="text-sm text-blue-100">Protected by 256-bit SSL encryption</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden fields for form data -->
    <input type="hidden" id="hiddenCustomerName" th:value="${userFirstName != null ? userFirstName + ' ' + (userLastName != null ? userLastName : '') : ''}">
    <input type="hidden" id="hiddenCustomerEmail" th:value="${userEmail != null ? userEmail : ''}">
    <input type="hidden" id="hiddenCustomerPhone" th:value="${userPhone != null ? userPhone : ''}">
    
    <!-- Hidden fields for coordinates -->
    <input type="hidden" id="pickupLatitude" name="pickupLatitude">
    <input type="hidden" id="pickupLongitude" name="pickupLongitude">
    <input type="hidden" id="pickupPlaceId" name="pickupPlaceId">
    <input type="hidden" id="deliveryLatitude" name="deliveryLatitude">
    <input type="hidden" id="deliveryLongitude" name="deliveryLongitude">
    <input type="hidden" id="deliveryPlaceId" name="deliveryPlaceId">

    <script>
        // Google Maps integration
        let pickupAutocomplete, deliveryAutocomplete;
        let pickupCoordinates = null;
        let deliveryCoordinates = null;

        function initMap() {
            // Initialize autocomplete for pickup address
            pickupAutocomplete = new google.maps.places.Autocomplete(
                document.getElementById('pickupAddress'),
                {
                    types: ['address'],
                    componentRestrictions: { country: 'za' }
                }
            );

            // Initialize autocomplete for delivery address
            deliveryAutocomplete = new google.maps.places.Autocomplete(
                document.getElementById('deliveryAddress'),
                {
                    types: ['address'],
                    componentRestrictions: { country: 'za' }
                }
            );

            // Add place changed listeners to capture coordinates
            pickupAutocomplete.addListener('place_changed', function() {
                const place = pickupAutocomplete.getPlace();
                if (place.geometry && place.geometry.location) {
                    pickupCoordinates = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng(),
                        formattedAddress: place.formatted_address,
                        placeId: place.place_id
                    };
                    
                    // Update display
                    document.getElementById('pickupAddressDisplay').textContent = pickupCoordinates.formattedAddress;
                    
                    // Store coordinates in hidden fields
                    document.getElementById('pickupLatitude').value = pickupCoordinates.lat;
                    document.getElementById('pickupLongitude').value = pickupCoordinates.lng;
                    document.getElementById('pickupPlaceId').value = pickupCoordinates.placeId;
                }
            });

            deliveryAutocomplete.addListener('place_changed', function() {
                const place = deliveryAutocomplete.getPlace();
                if (place.geometry && place.geometry.location) {
                    deliveryCoordinates = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng(),
                        formattedAddress: place.formatted_address,
                        placeId: place.place_id
                    };
                    
                    // Update display
                    document.getElementById('deliveryAddressDisplay').textContent = deliveryCoordinates.formattedAddress;
                    
                    // Store coordinates in hidden fields
                    document.getElementById('deliveryLatitude').value = deliveryCoordinates.lat;
                    document.getElementById('deliveryLongitude').value = deliveryCoordinates.lng;
                    document.getElementById('deliveryPlaceId').value = deliveryCoordinates.placeId;
                }
            });
        }

        // Store booking and payment data
        let currentBooking = null;
        let paymentInitialized = false;

        // Load booking data from URL parameters or session
        async function loadQuoteData() {
            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('bookingId') || sessionStorage.getItem('bookingId');
            const paymentReference = urlParams.get('reference') || sessionStorage.getItem('paymentReference');
            
            if (bookingId) {
                try {
                    // Load booking details from API
                    const response = await fetch(`/api/booking/${bookingId}`, {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        // Handle both wrapped response (result.booking) and direct booking object
                        const booking = result.booking || result;
                        currentBooking = booking;
                        
                        // Update display with booking data
                        if (booking.serviceType) {
                            // Handle enum object - get displayName if it's an object, otherwise use as string
                            let serviceTypeText = booking.serviceType;
                            if (typeof booking.serviceType === 'object' && booking.serviceType.displayName) {
                                serviceTypeText = booking.serviceType.displayName;
                            } else if (typeof booking.serviceType === 'object' && booking.serviceType.name) {
                                // Convert enum name to readable format
                                serviceTypeText = booking.serviceType.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            } else if (typeof booking.serviceType === 'string') {
                                serviceTypeText = booking.serviceType;
                            }
                            document.getElementById('serviceType').textContent = serviceTypeText;
                        }
                        // Try to get distance from booking, quote data, or calculate from coordinates
                        let distance = null;
                        if (booking.distanceKm) {
                            distance = booking.distanceKm;
                        } else if (booking.distance) {
                            distance = booking.distance;
                        } else if (sessionStorage.getItem('quoteDistance')) {
                            distance = parseFloat(sessionStorage.getItem('quoteDistance'));
                        } else if (booking.pickupLatitude && booking.pickupLongitude && 
                                   booking.deliveryLatitude && booking.deliveryLongitude) {
                            // Calculate distance from coordinates if available
                            distance = calculateDistanceFromCoords(
                                booking.pickupLatitude, booking.pickupLongitude,
                                booking.deliveryLatitude, booking.deliveryLongitude
                            );
                        }
                        if (distance) {
                            document.getElementById('distance').textContent = distance.toFixed(1) + ' km';
                        } else {
                            // Hide distance if not available
                            const distanceElement = document.getElementById('distance').parentElement;
                            if (distanceElement) distanceElement.style.display = 'none';
                        }
                        if (booking.weight || booking.weightKg) {
                            const weight = booking.weight || booking.weightKg;
                            document.getElementById('weight').textContent = weight + ' kg';
                        } else {
                            document.getElementById('weight').parentElement.style.display = 'none';
                        }
                        // Get total amount - try multiple fields
                        let amount = 0;
                        if (booking.totalAmount) {
                            amount = parseFloat(booking.totalAmount);
                        } else if (booking.totalPrice) {
                            amount = parseFloat(booking.totalPrice);
                        } else if (booking.basePrice) {
                            amount = parseFloat(booking.basePrice);
                            if (booking.insuranceFee) amount += parseFloat(booking.insuranceFee);
                            if (booking.serviceFee) amount += parseFloat(booking.serviceFee);
                            if (booking.fuelSurcharge) amount += parseFloat(booking.fuelSurcharge);
                        }
                        
                        if (amount > 0) {
                            document.getElementById('totalAmount').textContent = 'R' + amount.toFixed(2);
                            document.getElementById('payButtonText').textContent = 'Pay R' + amount.toFixed(2) + ' Securely';
                            // Store in sessionStorage for fallback
                            sessionStorage.setItem('bookingTotalAmount', amount.toString());
                        } else {
                            // Fallback to sessionStorage
                            const storedAmount = sessionStorage.getItem('quoteTotalAmount') || sessionStorage.getItem('bookingTotalAmount');
                            if (storedAmount) {
                                amount = parseFloat(storedAmount);
                                document.getElementById('totalAmount').textContent = 'R' + amount.toFixed(2);
                                document.getElementById('payButtonText').textContent = 'Pay R' + amount.toFixed(2) + ' Securely';
                            } else {
                                console.error('No amount found in booking or sessionStorage');
                            }
                        }
                        // Construct full addresses from components
                        let pickupAddr = '';
                        if (booking.pickupAddress) {
                            const parts = [booking.pickupAddress];
                            if (booking.pickupCity) parts.push(booking.pickupCity);
                            if (booking.pickupState) parts.push(booking.pickupState);
                            if (booking.pickupPostalCode) parts.push(booking.pickupPostalCode);
                            pickupAddr = parts.join(', ');
                        }
                        
                        let deliveryAddr = '';
                        if (booking.deliveryAddress) {
                            const parts = [booking.deliveryAddress];
                            if (booking.deliveryCity) parts.push(booking.deliveryCity);
                            if (booking.deliveryState) parts.push(booking.deliveryState);
                            if (booking.deliveryPostalCode) parts.push(booking.deliveryPostalCode);
                            deliveryAddr = parts.join(', ');
                        }
                        
                        if (pickupAddr) {
                            document.getElementById('pickupAddressDisplay').textContent = pickupAddr;
                        }
                        if (deliveryAddr) {
                            document.getElementById('deliveryAddressDisplay').textContent = deliveryAddr;
                        }
                        // Update customer name from booking
                        if (booking.customerName) {
                            document.getElementById('customerName').textContent = booking.customerName;
                        } else if (booking.customerFirstName || booking.customerLastName) {
                            const fullName = (booking.customerFirstName || '') + ' ' + (booking.customerLastName || '');
                            if (fullName.trim()) {
                                document.getElementById('customerName').textContent = fullName.trim();
                            }
                        }
                        // Update customer email from booking
                        if (booking.customerEmail) {
                            document.getElementById('customerEmail').textContent = booking.customerEmail;
                        }
                        if (booking.customerPhone || booking.phone) {
                            document.getElementById('customerPhone').textContent = booking.customerPhone || booking.phone;
                            document.getElementById('customerPhoneRow').style.display = 'flex';
                        }
                        
                        // Show additional details if available
                        const additionalDetails = [];
                        if (booking.description) {
                            additionalDetails.push({ label: 'Description', value: booking.description });
                        }
                        if (booking.packageType) {
                            additionalDetails.push({ label: 'Package Type', value: booking.packageType });
                        }
                        if (booking.dimensions) {
                            additionalDetails.push({ label: 'Dimensions', value: booking.dimensions });
                        }
                        if (booking.numberOfItems) {
                            additionalDetails.push({ label: 'Number of Items', value: booking.numberOfItems });
                        }
                        if (booking.numberOfLoads) {
                            additionalDetails.push({ label: 'Number of Loads', value: booking.numberOfLoads });
                        }
                        if (booking.truckSize) {
                            additionalDetails.push({ label: 'Truck Size', value: booking.truckSize });
                        }
                        if (booking.fullMoving !== undefined) {
                            additionalDetails.push({ label: 'Full Moving', value: booking.fullMoving ? 'Yes' : 'No' });
                        }
                        if (booking.specialInstructions) {
                            additionalDetails.push({ label: 'Special Instructions', value: booking.specialInstructions });
                        }
                        if (booking.requestedDate) {
                            additionalDetails.push({ label: 'Requested Date', value: new Date(booking.requestedDate).toLocaleDateString() });
                        }
                        if (booking.scheduledDate) {
                            additionalDetails.push({ label: 'Scheduled Date', value: new Date(booking.scheduledDate).toLocaleDateString() });
                        }
                        
                        if (additionalDetails.length > 0) {
                            const additionalContent = document.getElementById('additionalDetailsContent');
                            additionalContent.innerHTML = additionalDetails.map(detail => `
                                <div class="flex justify-between">
                                    <span class="text-gray-600">${detail.label}:</span>
                                    <span class="font-semibold text-gray-800">${detail.value}</span>
                                </div>
                            `).join('');
                            document.getElementById('additionalDetails').style.display = 'block';
                        }
                        
                        // Initialize payment if not already done
                        if (!paymentInitialized && paymentReference) {
                            // Payment already initialized, just show the button
                            paymentInitialized = true;
                        } else if (!paymentInitialized) {
                            // Initialize payment
                            await initializeBookingPayment(bookingId);
                        }
                    }
                } catch (error) {
                    console.error('Error loading booking:', error);
                    // Fallback to URL parameters
                    loadFromUrlParams();
                }
            } else {
                // Fallback to URL parameters or sessionStorage
                loadFromUrlParams();
            }
        }

        // Load data from URL parameters (fallback)
        function loadFromUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Load service details
            const serviceType = urlParams.get('serviceType') || sessionStorage.getItem('quoteServiceType') || 'Express Delivery';
            const distance = urlParams.get('distance') || '25';
            const weight = urlParams.get('weight') || '2.5';
            const totalAmount = urlParams.get('totalAmount') || sessionStorage.getItem('quoteTotalAmount') || '0';
            
            // Update display
            document.getElementById('serviceType').textContent = serviceType;
            document.getElementById('distance').textContent = distance + ' km';
            document.getElementById('weight').textContent = weight + ' kg';
            document.getElementById('totalAmount').textContent = 'R' + parseFloat(totalAmount).toFixed(2);
            document.getElementById('payButtonText').textContent = 'Pay R' + parseFloat(totalAmount).toFixed(2) + ' Securely';
            
            // Load addresses if provided
            // Construct full addresses from URL params if available
            const pickupAddrFromUrl = urlParams.get('pickupAddress');
            const deliveryAddrFromUrl = urlParams.get('deliveryAddress');
            
            if (pickupAddrFromUrl) {
                const parts = [pickupAddrFromUrl];
                if (urlParams.get('pickupCity')) parts.push(urlParams.get('pickupCity'));
                if (urlParams.get('pickupState')) parts.push(urlParams.get('pickupState'));
                if (urlParams.get('pickupPostalCode')) parts.push(urlParams.get('pickupPostalCode'));
                document.getElementById('pickupAddressDisplay').textContent = parts.join(', ');
            }
            
            if (deliveryAddrFromUrl) {
                const parts = [deliveryAddrFromUrl];
                if (urlParams.get('deliveryCity')) parts.push(urlParams.get('deliveryCity'));
                if (urlParams.get('deliveryState')) parts.push(urlParams.get('deliveryState'));
                if (urlParams.get('deliveryPostalCode')) parts.push(urlParams.get('deliveryPostalCode'));
                document.getElementById('deliveryAddressDisplay').textContent = parts.join(', ');
            }
        }

        // Initialize payment for booking
        // Calculate distance from coordinates using Haversine formula
        function calculateDistanceFromCoords(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function initializeBookingPayment(bookingId) {
            try {
                // Check if payment already exists for this booking
                const bookingResponse = await fetch(`/api/booking/${bookingId}`, {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (bookingResponse.ok) {
                    const bookingData = await bookingResponse.json();
                    const booking = bookingData.booking || bookingData;
                    
                    // Check if payment is already completed
                    if (booking.paymentStatus === 'COMPLETED') {
                        console.log('Payment already completed for this booking');
                        // Use existing payment reference if available
                        if (booking.paymentReference) {
                            sessionStorage.setItem('paymentReference', booking.paymentReference);
                            paymentInitialized = true;
                            return;
                        }
                    }
                    
                    // Check if payment reference already exists
                    if (booking.paymentReference) {
                        // Check if payment with this reference is already completed
                        try {
                            const paymentCheck = await fetch(`/api/payment/booking/${bookingId}`, {
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'include'
                            });
                            
                            if (paymentCheck.ok) {
                                const paymentData = await paymentCheck.json();
                                if (paymentData.status === 'COMPLETED') {
                                    console.log('Payment already exists and is completed');
                                    sessionStorage.setItem('paymentReference', booking.paymentReference);
                                    paymentInitialized = true;
                                    alert('This booking has already been paid. Redirecting to payment success page...');
                                    window.location.href = `/payment-success?bookingId=${bookingId}&reference=${booking.paymentReference}`;
                                    return;
                                }
                            }
                        } catch (e) {
                            console.log('Could not check existing payment, proceeding with initialization');
                        }
                    }
                }
                
                // Initialize new payment
                const response = await fetch(`/api/booking/${bookingId}/payment/initialize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.payment) {
                        // Store payment reference
                        sessionStorage.setItem('paymentReference', data.payment.data?.reference || '');
                        paymentInitialized = true;
                    } else if (data.error && data.error.toLowerCase().includes('duplicate')) {
                        // Handle duplicate payment error
                        alert('A payment for this booking already exists. Please check your payment status.');
                        // Try to redirect to payment success if booking exists
                        if (bookingId) {
                            window.location.href = `/payment-success?bookingId=${bookingId}`;
                        }
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.error && errorData.error.toLowerCase().includes('duplicate')) {
                        alert('A payment for this booking already exists. Please check your payment status.');
                        if (bookingId) {
                            window.location.href = `/payment-success?bookingId=${bookingId}`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error initializing payment:', error);
            }
        }

        // Get Paystack public key from backend
        let paystackPublicKey = null;
        async function getPaystackPublicKey() {
            try {
                const response = await fetch('/api/paystack/public-key', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    paystackPublicKey = data.publicKey || data.key;
                } else {
                    // Fallback to default test key
                    paystackPublicKey = 'pk_test_f0b259230b0894830add4ffac1d8075fa2e69286';
                }
            } catch (error) {
                console.error('Error getting Paystack key:', error);
                // Fallback to default test key
                paystackPublicKey = 'pk_test_f0b259230b0894830add4ffac1d8075fa2e69286';
            }
        }

        // Paystack payment integration
        async function initializePaystack() {
            // Get Paystack public key first
            if (!paystackPublicKey) {
                await getPaystackPublicKey();
            }
            
            const paystackBtn = document.getElementById('paystackBtn');
            if (!paystackBtn) return;
            
            paystackBtn.addEventListener('click', async function() {
                const urlParams = new URLSearchParams(window.location.search);
                const bookingId = urlParams.get('bookingId') || sessionStorage.getItem('bookingId');
                const paymentReference = sessionStorage.getItem('paymentReference');
                
                // Get customer email - prefer from booking, then hidden field, then logged-in user
                let customerEmail = 'guest@example.com';
                if (currentBooking && currentBooking.customerEmail) {
                    customerEmail = currentBooking.customerEmail;
                } else {
                    const hiddenEmail = document.getElementById('hiddenCustomerEmail');
                    if (hiddenEmail && hiddenEmail.value) {
                        customerEmail = hiddenEmail.value;
                    } else {
                        // Try to get from logged-in user
                        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                        if (token) {
                            try {
                                const userResponse = await fetch('/api/customer/profile', {
                                    headers: {
                                        'Authorization': 'Bearer ' + token,
                                        'Content-Type': 'application/json'
                                    },
                                    credentials: 'include'
                                });
                                if (userResponse.ok) {
                                    const userData = await userResponse.json();
                                    if (userData.email) customerEmail = userData.email;
                                }
                            } catch (e) {
                                console.error('Error getting user email:', e);
                            }
                        }
                    }
                }
                
                const totalAmountText = document.getElementById('totalAmount').textContent.replace('R', '').replace(',', '').trim();
                let totalAmount = parseFloat(totalAmountText);
                
                // If amount is 0 or invalid, try to get from sessionStorage
                if (!totalAmount || totalAmount <= 0 || isNaN(totalAmount)) {
                    const storedAmount = sessionStorage.getItem('quoteTotalAmount') || sessionStorage.getItem('bookingTotalAmount');
                    if (storedAmount) {
                        totalAmount = parseFloat(storedAmount);
                    }
                }
                
                // Validate amount
                if (!totalAmount || totalAmount <= 0 || isNaN(totalAmount)) {
                    showAlert('Invalid payment amount. Please contact support.', 'error');
                    console.error('Invalid payment amount:', totalAmountText, 'Parsed:', totalAmount);
                    return;
                }
                
                const amountInKobo = Math.round(totalAmount * 100);
                
                // Validate kobo amount (minimum 100 kobo = R1.00)
                if (amountInKobo < 100) {
                    showAlert('Payment amount must be at least R1.00. Please contact support.', 'error');
                    return;
                }
                
                // If we have a booking, use the payment reference from booking initialization
                let paymentRef = paymentReference;
                if (!paymentRef && bookingId) {
                    // Initialize payment if not already done
                    try {
                        const initResponse = await fetch(`/api/booking/${bookingId}/payment/initialize`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include'
                        });
                        if (initResponse.ok) {
                            const initData = await initResponse.json();
                            if (initData.success && initData.payment && initData.payment.data) {
                                paymentRef = initData.payment.data.reference;
                                sessionStorage.setItem('paymentReference', paymentRef);
                            }
                        }
                    } catch (error) {
                        console.error('Error initializing payment:', error);
                    }
                }
                
                // Fallback reference if none available
                if (!paymentRef) {
                    paymentRef = 'RC_' + Date.now();
                }
                
                const handler = PaystackPop.setup({
                    key: paystackPublicKey,
                    email: customerEmail,
                    amount: amountInKobo,
                    currency: 'ZAR',
                    ref: paymentRef,
                    metadata: {
                        booking_id: bookingId || '',
                        custom_fields: [
                            {
                                display_name: "Booking ID",
                                variable_name: "booking_id",
                                value: bookingId || 'N/A'
                            }
                        ]
                    },
                    callback: function(response) {
                        // Payment successful - verify with backend
                        verifyAndProcessPayment(response, bookingId);
                    },
                    onClose: function() {
                        // Payment cancelled
                        console.log('Payment cancelled by user');
                        showAlert('Payment was cancelled. You can try again when ready.', 'info');
                    }
                });
                
                handler.openIframe();
            });
        }

        // Verify payment and process
        async function verifyAndProcessPayment(response, bookingId) {
            try {
                showAlert('Verifying payment...', 'info');
                
                if (bookingId) {
                    // Verify payment for booking
                    const verifyResponse = await fetch(`/api/booking/${bookingId}/payment/verify?reference=${response.reference}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    
                    if (verifyResponse.ok) {
                        const verifyData = await verifyResponse.json();
                        if (verifyData.success) {
                            // Redirect to payment success page
                            window.location.href = `/payment-success?bookingId=${bookingId}&reference=${response.reference}`;
                            return;
                        }
                    }
                }
                
                // Fallback: use Paystack verify endpoint
                const verifyResponse = await fetch(`/api/paystack/verify?reference=${response.reference}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (verifyResponse.ok) {
                    const verifyData = await verifyResponse.json();
                    if (verifyData.status) {
                        // Redirect to payment success page
                        window.location.href = `/payment-success?reference=${response.reference}`;
                    } else {
                        showAlert('Payment verification failed. Please contact support.', 'error');
                    }
                } else {
                    showAlert('Payment successful but verification failed. Please contact support with reference: ' + response.reference, 'error');
                }
            } catch (error) {
                console.error('Error verifying payment:', error);
                showAlert('Payment successful but verification failed. Please contact support with reference: ' + response.reference, 'error');
            }
        }

        // Show alert function
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg ${
                type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            } text-white`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Get Paystack public key first
            await getPaystackPublicKey();
            
            // Load booking/quote data
            await loadQuoteData();
            
            // Initialize Paystack payment handler
            await initializePaystack();
        });
    </script>
</body>
</html>