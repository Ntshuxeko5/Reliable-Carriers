<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Registration - Reliable Carriers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            position: relative;
        }
        .step.active .step-number {
            background: #0ea5e9;
            color: white;
        }
        .step.completed .step-number {
            background: #10b981;
            color: white;
        }
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="mx-auto h-20 w-20 bg-gradient-to-r from-green-600 to-blue-600 rounded-full flex items-center justify-center mb-6">
                <i class="fas fa-car text-white text-3xl"></i>
            </div>
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Become a Driver</h1>
            <p class="text-xl text-gray-600">Join Reliable Carriers and start earning today!</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator mb-8">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="text-sm font-medium text-gray-700">Personal Info</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="text-sm font-medium text-gray-700">Vehicle Info</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="text-sm font-medium text-gray-700">Documents</div>
            </div>
        </div>

        <!-- Registration Form -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <form id="driverRegisterForm" class="space-y-6">
                
                <!-- Step 1: Personal Information -->
                <div id="personalInfoStep" class="step-content">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">
                        <i class="fas fa-user text-blue-600 mr-2"></i>Personal Information
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">
                                First Name *
                            </label>
                            <input id="firstName" name="firstName" type="text" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Enter your first name">
                        </div>
                        <div>
                            <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">
                                Last Name *
                            </label>
                            <input id="lastName" name="lastName" type="text" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Enter your last name">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                Email Address *
                            </label>
                            <input id="email" name="email" type="email" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="your.email@example.com">
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                                Phone Number *
                            </label>
                            <input id="phone" name="phone" type="tel" required pattern="[0-9+\s()-]+"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="+27123456789">
                        </div>
                    </div>
                    
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-2">
                            Address *
                        </label>
                        <input id="address" name="address" type="text" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Street address">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="city" class="block text-sm font-medium text-gray-700 mb-2">City *</label>
                            <input id="city" name="city" type="text" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="state" class="block text-sm font-medium text-gray-700 mb-2">Province *</label>
                            <input id="state" name="state" type="text" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="zipCode" class="block text-sm font-medium text-gray-700 mb-2">Postal Code *</label>
                            <input id="zipCode" name="zipCode" type="text" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-6">
                        <button type="button" onclick="nextStep()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors">
                            Next: Vehicle Information <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Vehicle Information -->
                <div id="vehicleInfoStep" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">
                        <i class="fas fa-car text-blue-600 mr-2"></i>Vehicle Information
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="vehicleMake" class="block text-sm font-medium text-gray-700 mb-2">
                                Vehicle Make * (e.g., Toyota, Ford)
                            </label>
                            <input id="vehicleMake" name="vehicleMake" type="text" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Toyota">
                        </div>
                        <div>
                            <label for="vehicleModel" class="block text-sm font-medium text-gray-700 mb-2">
                                Vehicle Model *
                            </label>
                            <input id="vehicleModel" name="vehicleModel" type="text" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Hilux">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="vehicleYear" class="block text-sm font-medium text-gray-700 mb-2">
                                Year
                            </label>
                            <input id="vehicleYear" name="vehicleYear" type="number" min="1900" max="2030"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="2020">
                        </div>
                        <div>
                            <label for="vehicleColor" class="block text-sm font-medium text-gray-700 mb-2">
                                Color
                            </label>
                            <input id="vehicleColor" name="vehicleColor" type="text"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="White">
                        </div>
                        <div>
                            <label for="vehicleCapacityKg" class="block text-sm font-medium text-gray-700 mb-2">
                                Capacity (kg)
                            </label>
                            <input id="vehicleCapacityKg" name="vehicleCapacityKg" type="number" min="0" step="0.01"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="500">
                        </div>
                    </div>
                    
                    <div>
                        <label for="vehicleRegistration" class="block text-sm font-medium text-gray-700 mb-2">
                            Vehicle Registration Number *
                        </label>
                        <input id="vehicleRegistration" name="vehicleRegistration" type="text" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="ABC 123 GP">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div>
                            <label for="driverLicenseNumber" class="block text-sm font-medium text-gray-700 mb-2">
                                Driver's License Number *
                            </label>
                            <input id="driverLicenseNumber" name="driverLicenseNumber" type="text" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="1234567890123">
                        </div>
                        <div>
                            <label for="licenseExpiryDate" class="block text-sm font-medium text-gray-700 mb-2">
                                License Expiry Date *
                            </label>
                            <input id="licenseExpiryDate" name="licenseExpiryDate" type="date" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button type="button" onclick="prevStep()" 
                                class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-medium transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>Previous
                        </button>
                        <button type="button" onclick="nextStep()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            Next: Documents <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Documents & Account Setup -->
                <div id="documentsStep" class="step-content hidden">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">
                        <i class="fas fa-file-upload text-blue-600 mr-2"></i>Documents & Account Setup
                    </h2>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Note:</strong> You can upload documents after registration. The following documents are required:
                        </p>
                        <ul class="list-disc list-inside mt-2 text-sm text-blue-700">
                            <li>Driver's License</li>
                            <li>ID Document</li>
                            <li>Vehicle Registration</li>
                            <li>Vehicle Insurance</li>
                        </ul>
                    </div>
                    
                    <!-- Password -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                                Password *
                            </label>
                            <input id="password" name="password" type="password" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Create a password">
                            <p class="text-xs text-gray-500 mt-1">Must be at least 8 characters</p>
                        </div>
                        <div>
                            <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">
                                Confirm Password *
                            </label>
                            <input id="confirmPassword" name="confirmPassword" type="password" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Confirm your password">
                        </div>
                    </div>
                    
                    <!-- Terms -->
                    <div class="space-y-4 mt-6">
                        <div class="flex items-start">
                            <input id="terms" name="terms" type="checkbox" required
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mt-1">
                            <label for="terms" class="ml-3 text-sm text-gray-700">
                                I agree to the <a href="/terms" class="text-blue-600 hover:underline">Terms of Service</a> 
                                and <a href="/privacy" class="text-blue-600 hover:underline">Privacy Policy</a> *
                            </label>
                        </div>
                        <div class="flex items-start">
                            <input id="waiver" name="waiver" type="checkbox" required
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mt-1">
                            <label for="waiver" class="ml-3 text-sm text-gray-700">
                                I acknowledge and accept the <a href="/docs/liability-waiver.pdf" target="_blank" class="text-blue-600 hover:underline">Liability Waiver</a> *
                            </label>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button type="button" onclick="prevStep()" 
                                class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-medium transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>Previous
                        </button>
                        <button type="submit" 
                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            <i class="fas fa-check mr-2"></i>Complete Registration
                        </button>
                    </div>
                </div>
            </form>

            <!-- 2FA Verification Stage -->
            <div id="otpStage" class="hidden mt-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Verify Your Driver Account</h2>
                    <p class="text-gray-600">We've sent a verification code to your email. Please enter it below.</p>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">Verification Code</label>
                    <input type="text" id="otpCode" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Enter 6-digit code" maxlength="6" required>
                </div>
                <div class="mb-6">
                    <button id="verifyOtpBtn" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                        Verify Driver Account
                    </button>
                </div>
                <div class="text-center">
                    <button id="resendCodeBtn" class="text-green-600 hover:text-green-700 font-medium">
                        Resend Code
                    </button>
                </div>
            </div>
        </div>

        <!-- Login Link -->
        <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
                Already a driver? 
                <a href="/login" class="font-medium text-blue-600 hover:text-blue-700">
                    Sign in here
                </a>
            </p>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" class="fixed top-4 right-4 z-50"></div>

    <script>
        let currentStep = 1;
        
        function nextStep() {
            if (currentStep < 3) {
                document.getElementById(`step${currentStep}`).classList.add('completed');
                document.getElementById(`step${currentStep}`).classList.remove('active');
                document.getElementById(`personalInfoStep`).classList.add('hidden');
                document.getElementById(`vehicleInfoStep`).classList.add('hidden');
                document.getElementById(`documentsStep`).classList.add('hidden');
                
                currentStep++;
                document.getElementById(`step${currentStep}`).classList.add('active');
                
                if (currentStep === 2) {
                    document.getElementById(`vehicleInfoStep`).classList.remove('hidden');
                } else if (currentStep === 3) {
                    document.getElementById(`documentsStep`).classList.remove('hidden');
                }
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                document.getElementById(`personalInfoStep`).classList.add('hidden');
                document.getElementById(`vehicleInfoStep`).classList.add('hidden');
                document.getElementById(`documentsStep`).classList.add('hidden');
                
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.add('active');
                document.getElementById(`step${currentStep}`).classList.remove('completed');
                
                if (currentStep === 1) {
                    document.getElementById(`personalInfoStep`).classList.remove('hidden');
                } else if (currentStep === 2) {
                    document.getElementById(`vehicleInfoStep`).classList.remove('hidden');
                }
            }
        }
        
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `p-4 rounded-lg shadow-lg mb-4 ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'} text-white`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }
        
        document.getElementById('driverRegisterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const data = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                password: formData.get('password'),
                confirmPassword: formData.get('confirmPassword'),
                address: formData.get('address'),
                city: formData.get('city'),
                state: formData.get('state'),
                zipCode: formData.get('zipCode'),
                country: 'South Africa', // Only South African addresses accepted
                role: 'DRIVER',
                driverLicenseNumber: formData.get('driverLicenseNumber'),
                licenseExpiryDate: formData.get('licenseExpiryDate'),
                vehicleMake: formData.get('vehicleMake'),
                vehicleModel: formData.get('vehicleModel'),
                vehicleYear: formData.get('vehicleYear') ? parseInt(formData.get('vehicleYear')) : null,
                vehicleRegistration: formData.get('vehicleRegistration'),
                vehicleColor: formData.get('vehicleColor'),
                vehicleCapacityKg: formData.get('vehicleCapacityKg') ? parseFloat(formData.get('vehicleCapacityKg')) : null,
                waiverAccepted: formData.get('waiver') === 'on'
            };
            
            if (data.password !== data.confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result && result.success) {
                    if (result.requires2fa) {
                        // Store user info for 2FA step
                        sessionStorage.setItem('pending2faEmail', result.email);
                        sessionStorage.setItem('pending2faRole', result.role || 'DRIVER');
                        
                        // Hide form and show 2FA step
                        document.getElementById('driverRegisterForm').style.display = 'none';
                        document.getElementById('otpStage').classList.remove('hidden');
                        
                        // Show success message
                        showAlert('Verification code sent to your email. Please check your inbox.', 'success');
                        
                        // Show demo code if available
                        if (result.demoCode) {
                            showAlert('Demo code: ' + result.demoCode, 'info');
                        }
                    } else {
                        // Direct registration success (no 2FA required)
                        showAlert(result.message || 'Driver registration successful! Redirecting to login...', 'success');
                        setTimeout(() => {
                            window.location.href = '/login?driver=true';
                        }, 2000);
                    }
                } else {
                    // Handle validation errors
                    if (result && result.errors) {
                        let errorMessage = 'Please fix the following errors:\n';
                        for (const [field, error] of Object.entries(result.errors)) {
                            errorMessage += `â€¢ ${error}\n`;
                        }
                        showAlert(errorMessage, 'error');
                    } else {
                        showAlert(result.message || result.error || 'Registration failed. Please try again.', 'error');
                    }
                }
            } catch (error) {
                showAlert('Registration failed. Please try again.', 'error');
            }
        });

        // OTP verification handler
        document.getElementById('verifyOtpBtn')?.addEventListener('click', function(e) {
            e.preventDefault();
            const code = document.getElementById('otpCode').value;
            const email = sessionStorage.getItem('pending2faEmail');
            if (!email || !code) {
                showAlert('Please enter the 6-digit code.', 'error');
                return;
            }

            fetch('/api/auth/register/verify?email=' + encodeURIComponent(email) + '&code=' + encodeURIComponent(code), {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'Verification failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    // Store the JWT token if provided
                    if (data.user && data.user.token) {
                        localStorage.setItem('token', data.user.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                    }
                    
                    showAlert(data.message || 'Driver registration completed successfully! Welcome to Reliable Carriers.', 'success');
                    setTimeout(() => {
                        // Redirect to driver dashboard
                        const role = data.user?.role || sessionStorage.getItem('pending2faRole') || 'DRIVER';
                        if (role === 'DRIVER') {
                            window.location.href = '/driver/dashboard';
                        } else {
                            window.location.href = '/driver/dashboard';
                        }
                    }, 2000);
                } else {
                    showAlert(data.message || 'Invalid verification code', 'error');
                }
            })
            .catch(error => {
                showAlert('Verification failed: ' + error.message, 'error');
            });
        });

        // Resend code handler
        document.getElementById('resendCodeBtn')?.addEventListener('click', function(e) {
            e.preventDefault();
            const email = sessionStorage.getItem('pending2faEmail');
            if (email) {
                fetch('/api/auth/register/resend?email=' + encodeURIComponent(email) + '&method=EMAIL', {
                    method: 'POST'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showAlert(data.message || 'Verification code sent via EMAIL. Check your email.', 'success');
                    } else {
                        showAlert(data.message || 'Failed to send verification code. Please try again.', 'error');
                    }
                })
                .catch(() => showAlert('Failed to send verification code. Network error.', 'error'));
            } else {
                showAlert('No email found. Please try registering again.', 'error');
            }
        });
    </script>
</body>
</html>

