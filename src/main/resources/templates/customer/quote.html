<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quote - Reliable Carriers</title>
    <link href="/css/tailwind-production.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Maps (loaded only if API key is configured) -->
    <script th:inline="javascript">
        (function(){
            var key = /*[[${@environment.getProperty('google.maps.api.key')}]]*/ null;
            console.log('Google Maps API key from server:', key);
            console.log('Key type:', typeof key);
            console.log('Key length:', key ? key.length : 'null');
            
            // Always try to load Google Maps with the configured key or fallback
            var apiKey = key && key !== 'your-google-maps-api-key' && key !== '' && key !== null ? key : 'AIzaSyDLgjJj0Ou8dO1CHzKzJWtbP59QlafVgBY';
            
            console.log('Using API key:', apiKey.substring(0, 10) + '...');
            
            var s = document.createElement('script');
            s.src = 'https://maps.googleapis.com/maps/api/js?key=' + encodeURIComponent(apiKey) + '&libraries=places&region=za&callback=initGoogleMaps';
            s.async = true;
            s.defer = true;
            s.onload = function() {
                console.log('Google Maps script loaded successfully');
                window.__MAPS_ENABLED__ = true;
            };
            s.onerror = function() {
                console.error('Failed to load Google Maps script');
                window.__MAPS_ENABLED__ = false;
            };
            document.head.appendChild(s);
        })();
    </script>
    <style>
        /* Enhanced Glass Effect */
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        /* Enhanced Hover Effects */
        .hover-lift {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .hover-lift:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        .hover-lift::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .hover-lift:hover::before {
            left: 100%;
        }
        
        /* Enhanced Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 3s ease-in-out infinite;
        }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Modern Card Styles */
        .modern-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .modern-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        /* Enhanced Form Styling */
        .form-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .form-input:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
            transform: translateY(-2px);
        }
        
        /* Service Option Cards */
        .service-card {
            background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%);
            border-radius: 16px;
            border: 2px solid transparent;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .service-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: #0ea5e9;
            box-shadow: 0 20px 40px rgba(14, 165, 233, 0.2);
        }
        
        .service-card.recommended {
            border-color: #10b981;
            background: linear-gradient(145deg, #ecfdf5 0%, #d1fae5 100%);
        }
        
        .service-card.recommended::before {
            content: 'RECOMMENDED';
            position: absolute;
            top: 10px;
            right: -30px;
            background: #10b981;
            color: white;
            padding: 4px 40px;
            font-size: 12px;
            font-weight: bold;
            transform: rotate(45deg);
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }
        
        /* Enhanced Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(14, 165, 233, 0.4);
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        /* Loading Animation */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Enhanced Map Container */
        .map-container {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Quote Result Animation */
        .quote-result {
            animation: slideInUp 0.6s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Enhanced Alert Styles */
        .alert {
            border-radius: 12px;
            padding: 16px 20px;
            margin: 10px 0;
            font-weight: 500;
            animation: slideInRight 0.4s ease-out;
        }
        
        .alert.success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .alert.error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .alert.info {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Responsive Design Enhancements */
        @media (max-width: 768px) {
            .hover-lift:hover {
                transform: translateY(-4px) scale(1.01);
            }
            
            .service-card:hover {
                transform: translateY(-4px) scale(1.01);
            }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #0284c7 0%, #075985 100%);
        }
    </style>

    </head>
    <body class="bg-gray-50 font-sans">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-brand-blue-900 to-brand-blue-800 text-white shadow-lg nav-header sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <a href="/" class="flex items-center space-x-2 text-2xl font-bold text-white hover:text-brand-300 transition-colors duration-300">
                    <span class="inline-flex items-center justify-center bg-white/10 rounded-full p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" class="h-8 w-8 text-white" fill="currentColor" aria-hidden="true">
                            <rect x="4" y="20" width="40" height="20" rx="2" />
                            <rect x="44" y="28" width="12" height="8" rx="1" />
                            <circle cx="18" cy="44" r="4" fill="white" />
                            <circle cx="46" cy="44" r="4" fill="white" />
                        </svg>
                    </span>
                    <span>Reliable Carriers</span>
                </a>
                <div class="hidden md:flex space-x-8">
                    <a href="/customer/dashboard" class="text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <a href="/customer/track" class="text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-search mr-2"></i>Track Package
                    </a>
                    <a href="/customer/quote" class="text-brand-300 hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-calculator mr-2"></i>Get Quote
                    </a>
                    <a href="/customer/packages" class="text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-boxes mr-2"></i>My Packages
                    </a>
                    <a href="/customer/store" class="text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-store mr-2"></i>Business
                    </a>
                    <a href="/customer/help" class="text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-question-circle mr-2"></i>Help
                    </a>
                    <a href="/customer/contact" class="text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-envelope mr-2"></i>Contact
                    </a>
                </div>
                <!-- Mobile menu button -->
                <button class="md:hidden text-white hover:text-brand-300 transition-colors duration-300" id="mobileMenuBtn">
                    <i class="fas fa-bars text-xl"></i>
            </button>
            </div>
            <!-- Mobile menu -->
            <div class="md:hidden hidden" id="mobileMenu">
                <div class="py-4 space-y-4">
                    <a href="/customer/dashboard" class="block text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <a href="/customer/track" class="block text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-search mr-2"></i>Track Package
                    </a>
                    <a href="/customer/quote" class="block text-brand-300 hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-calculator mr-2"></i>Get Quote
                    </a>
                    <a href="/customer/packages" class="block text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-boxes mr-2"></i>My Packages
                    </a>
                    <a href="/customer/store" class="block text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-store mr-2"></i>Business
                    </a>
                    <a href="/customer/help" class="block text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-question-circle mr-2"></i>Help
                    </a>
                    <a href="/customer/contact" class="block text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-envelope mr-2"></i>Contact
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="rounded-3xl p-8 hover-lift bg-white shadow-sm">
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-calculator mr-3 gradient-text"></i>Create Quote
                </h1>
                <p class="text-xl text-gray-700">Get instant shipping quotes for your packages</p>
                    </div>
            
                        <form id="quoteForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
               <label class="block text-gray-800 font-medium mb-2">Pickup Address</label>
               <input id="pickupAddress" type="text" 
                   class="w-full px-6 py-4 form-input text-gray-900 placeholder-gray-400 focus:outline-none transition-all duration-300" 
                               placeholder="Enter pickup address" required>
                                    <input type="hidden" id="pickupLat" />
                                    <input type="hidden" id="pickupLng" />
                                </div>
                    <div>
               <label class="block text-gray-800 font-medium mb-2">Delivery Address</label>
               <input id="deliveryAddress" type="text" 
                   class="w-full px-6 py-4 form-input text-gray-900 placeholder-gray-400 focus:outline-none transition-all duration-300" 
                               placeholder="Enter delivery address" required>
                                    <input type="hidden" id="deliveryLat" />
                                    <input type="hidden" id="deliveryLng" />
                    </div>
                </div>
                
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
         <label class="block text-gray-800 font-medium mb-2">Weight (kg)</label>
               <input id="weight" type="number" 
                   class="w-full px-6 py-4 rounded-full border-2 border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-brand-400 focus:outline-none transition-all duration-300" 
                               min="0" step="0.1" required>
                    </div>
                    <div>
               <label class="block text-gray-800 font-medium mb-2">Length (cm)</label>
               <input type="number" 
                   class="w-full px-6 py-4 rounded-full border-2 border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-brand-400 focus:outline-none transition-all duration-300" 
                   min="0" required>
                    </div>
                    <div>
               <label class="block text-gray-800 font-medium mb-2">Width (cm)</label>
               <input type="number" 
                   class="w-full px-6 py-4 rounded-full border-2 border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-brand-400 focus:outline-none transition-all duration-300" 
                   min="0" required>
                    </div>
                </div>
                
                <div class="mb-6">
              <label class="block text-gray-800 font-medium mb-2">Email</label>
              <input id="senderEmail" type="email" 
                  class="w-full px-6 py-4 rounded-full border-2 border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-brand-400 focus:outline-none transition-all duration-300" 
                           placeholder="you@example.com" required>
                </div>
                
                <!-- Insurance Options -->
                <div class="mb-6">
                    <label class="block text-gray-800 font-medium mb-3">Insurance Coverage (Optional)</label>
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-brand-400 transition-all duration-300">
                            <input type="radio" name="insurance" value="none" class="mr-3 text-brand-500" checked>
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">No Insurance</div>
                                <div class="text-sm text-gray-600">Standard coverage included</div>
                            </div>
                            <div class="text-lg font-bold text-gray-800">R0.00</div>
                        </label>
                        
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-brand-400 transition-all duration-300">
                            <input type="radio" name="insurance" value="basic" class="mr-3 text-brand-500">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">Basic Coverage</div>
                                <div class="text-sm text-gray-600">Up to R1,000 coverage</div>
                            </div>
                            <div class="text-lg font-bold text-gray-800">R15.00</div>
                        </label>
                        
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-brand-400 transition-all duration-300">
                            <input type="radio" name="insurance" value="standard" class="mr-3 text-brand-500">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">Standard Coverage</div>
                                <div class="text-sm text-gray-600">Up to R5,000 coverage</div>
                            </div>
                            <div class="text-lg font-bold text-gray-800">R35.00</div>
                        </label>
                        
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-brand-400 transition-all duration-300">
                            <input type="radio" name="insurance" value="premium" class="mr-3 text-brand-500">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">Premium Coverage</div>
                                <div class="text-sm text-gray-600">Up to R10,000 coverage</div>
                            </div>
                            <div class="text-lg font-bold text-gray-800">R65.00</div>
                        </label>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="flex items-center text-gray-800">
                        <input class="form-check-input mr-3" type="checkbox" value="1" id="useCurrentLocation">
                        <span>Use my current location as pickup</span>
                    </label>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <button type="button" onclick="previewRoute()" 
                class="btn-primary px-8 py-4 rounded-full font-bold flex items-center justify-center hover-lift">
                        <i class="fas fa-map mr-2"></i>Preview Route
                    </button>
            <button type="submit" 
                class="btn-primary px-8 py-4 rounded-full font-bold flex items-center justify-center hover-lift">
                        <i class="fas fa-magic mr-2"></i>Get Quote
                    </button>
                    <a href="/customer/dashboard" 
                       class="bg-gradient-to-r from-gray-600 to-gray-700 text-white px-8 py-4 rounded-full font-bold hover:from-gray-700 hover:to-gray-800 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </a>
                </div>
            </form>
                <div id="mapPreview" class="mt-8" style="display:none">
                <div class="bg-white rounded-2xl p-6 shadow-sm">
                    <h3 class="text-2xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-map mr-2 text-brand-400"></i>Route Preview
                    </h3>
                    <div id="map" class="rounded-xl overflow-hidden" style="height: 400px; width: 100%;"></div>
                    <div id="routeInfo" class="mt-4 text-center">
                        <div class="inline-flex items-center space-x-4 text-gray-700">
                            <span><i class="fas fa-route mr-2"></i>Distance: <span id="routeDistance" class="text-brand-600 font-bold">-</span> km</span>
                            <span><i class="fas fa-clock mr-2"></i>Duration: <span id="routeDuration" class="text-brand-600 font-bold">-</span></span>
                        </div>
                    </div>
                </div>
            </div>
            
                    <div id="quoteResult" class="mt-8" style="display:none">
                        <div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm">
                            <h3 class="text-2xl font-bold text-gray-900 mb-4">
                                <i class="fas fa-receipt mr-2 text-green-400"></i>Instant Quote Results
                            </h3>
                    
                    <!-- Service Options -->
                    <div id="serviceOptions" class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Choose Your Service:</h4>
                        <div id="serviceOptionsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Service options will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Selected Service Details -->
                    <div id="selectedServiceDetails" class="bg-white rounded-xl p-6 mb-6" style="display:none">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 text-gray-800">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-400 mb-2">
                                    <span id="resDistance">-</span> km
                                </div>
                                <div class="text-gray-300 text-sm">Distance</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-brand-400 mb-2">
                                    R<span id="resTotal">-</span>
                                </div>
                                <div class="text-gray-300 text-sm">Total Cost</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-400 mb-2">
                                    <span id="resService">-</span>
                                </div>
                                <div class="text-gray-300 text-sm">Service Type</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-purple-400 mb-2">
                                    <span id="resDelivery">-</span>
                                </div>
                                <div class="text-gray-300 text-sm">Delivery Time</div>
                            </div>
                        </div>
                        
                        <!-- Cost Breakdown -->
                        <div class="mt-4 bg-gray-50 rounded-lg p-4">
                            <h5 class="text-gray-800 font-semibold mb-3">Cost Breakdown:</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-300">Base Cost:</span>
                                    <span class="text-gray-900 font-semibold">R<span id="baseCost">-</span></span>
                                </div>
                                <div>
                                    <span class="text-gray-300">Service Fee:</span>
                                    <span class="text-gray-900 font-semibold">R<span id="serviceFee">-</span></span>
                                    </div>
                                <div>
                                    <span class="text-gray-300">Fuel Surcharge:</span>
                                    <span class="text-gray-900 font-semibold">R<span id="fuelSurcharge">-</span></span>
                                </div>
                                <div>
                                    <span class="text-gray-300">Insurance:</span>
                                    <span class="text-gray-900 font-semibold">R<span id="insuranceFee">-</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Section -->
                    <div id="paymentSection" class="bg-white border border-gray-100 rounded-2xl p-6" style="display:none">
                        <h4 class="text-xl font-bold text-gray-900 mb-4">
                            <i class="fas fa-credit-card mr-2 text-blue-400"></i>Complete Your Order
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Order Summary -->
                            <div class="bg-white rounded-xl p-4 shadow-sm">
                                <h5 class="text-gray-900 font-semibold mb-3">Order Summary:</h5>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between text-gray-700">
                                        <span>From:</span>
                                        <span class="text-gray-900" id="orderPickup">-</span>
                                    </div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>To:</span>
                                        <span class="text-gray-900" id="orderDelivery">-</span>
                                    </div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Weight:</span>
                                        <span class="text-gray-900" id="orderWeight">-</span>
                                    </div>
                                    <div class="flex justify-between text-gray-700">
                                        <span>Service:</span>
                                        <span class="text-gray-900" id="orderService">-</span>
                                    </div>
                                    <div class="border-t border-gray-200 pt-2 mt-2">
                                        <div class="flex justify-between text-lg font-bold text-brand-600">
                                            <span>Total:</span>
                                            <span>R<span id="orderTotal">-</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payment Options -->
                            <div class="bg-white rounded-xl p-4">
                                <h5 class="text-gray-900 font-semibold mb-3">Payment Method:</h5>
                                <div class="space-y-3">
                                    <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                                        <input type="radio" name="paymentMethod" value="paystack" class="mr-3" checked>
                                        <i class="fas fa-credit-card text-blue-400 mr-2"></i>
                                        <span class="text-gray-900">Credit/Debit Card (Paystack)</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                                        <input type="radio" name="paymentMethod" value="eft" class="mr-3">
                                        <i class="fas fa-university text-green-400 mr-2"></i>
                                        <span class="text-gray-900">EFT/Bank Transfer</span>
                                    </label>
                                </div>
                                
                                <button id="proceedToPayment" 
                                        class="w-full mt-4 bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-full font-bold hover:from-green-700 hover:to-green-800 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                                    <i class="fas fa-lock mr-2"></i>Proceed to Payment
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center text-gray-600 text-sm">
                        <i class="fas fa-info-circle mr-2"></i>Quote valid for 24 hours. Payment required to confirm shipment.
                    </div>
                </div>
            </div>
            
            <!-- Order Confirmation Modal -->
            <div id="orderConfirmationModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" style="display:none">
                <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
                    <div class="text-center">
                        <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-check text-green-600 text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Order Confirmed!</h3>
                        <p class="text-gray-600 mb-4">Your shipment has been created successfully.</p>
                        
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <div class="text-sm text-gray-600 mb-2">Tracking Number:</div>
                            <div class="text-2xl font-bold text-blue-600" id="confirmationTrackingNumber">-</div>
                        </div>
                        
                        <div class="space-y-2 text-sm text-gray-600 mb-6">
                            <div>Estimated Delivery: <span class="font-semibold" id="confirmationDelivery">-</span></div>
                            <div>Total Paid: <span class="font-semibold">R<span id="confirmationTotal">-</span></span></div>
                            </div>
                        
                        <div class="flex gap-3">
                            <button onclick="trackNewPackage()" 
                                    class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                Track Package
                            </button>
                            <button onclick="closeConfirmationModal()" 
                                    class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4 text-brand-400">Reliable Carriers</h3>
                    <p class="text-gray-300">Your trusted partner for reliable package delivery and tracking services.</p>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Quick Links</h4>
                    <ul class="space-y-2 text-gray-300">
                        <li><a href="/customer/track" class="hover:text-brand-400 transition-colors">Track Package</a></li>
                        <li><a href="/customer/quote" class="hover:text-brand-400 transition-colors">Get Quote</a></li>
                        <li><a href="/customer/packages" class="hover:text-brand-400 transition-colors">My Packages</a></li>
                        <li><a href="/customer/help" class="hover:text-brand-400 transition-colors">Help Center</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Services</h4>
                    <ul class="space-y-2 text-gray-300">
                        <li><a href="#" class="hover:text-brand-400 transition-colors">Express Delivery</a></li>
                        <li><a href="#" class="hover:text-brand-400 transition-colors">National Shipping</a></li>
                        <li><a href="#" class="hover:text-brand-400 transition-colors">Moving Services</a></li>
                        <li><a href="#" class="hover:text-brand-400 transition-colors">Load Transport</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Contact Info</h4>
                    <div class="space-y-2 text-gray-300">
                        <p><i class="fas fa-phone mr-2"></i>+27 11 123 4567</p>
                        <p><i class="fas fa-envelope mr-2"></i>support@reliablecarriers.com</p>
                        <p><i class="fas fa-map-marker-alt mr-2"></i>Johannesburg, South Africa</p>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-300">
                <p>&copy; 2024 Reliable Carriers. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Mobile menu toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('hidden');
        });

        let map, directionsService, directionsRenderer;
        let pickupAutocomplete, deliveryAutocomplete;
        let currentQuote = null;
        let selectedService = null;

        // Global callback function for Google Maps API
        function initGoogleMaps() {
            console.log('Google Maps API loaded successfully');
            initMap();
        }

        // Fallback function to load Google Maps with hardcoded key
        function loadGoogleMapsFallback() {
            console.log('Attempting to load Google Maps with fallback method...');
            const fallbackKey = 'AIzaSyDLgjJj0Ou8dO1CHzKzJWtbP59QlafVgBY';
            var s = document.createElement('script');
            s.src = 'https://maps.googleapis.com/maps/api/js?key=' + fallbackKey + '&libraries=places&region=za&callback=initGoogleMaps';
            s.async = true;
            s.defer = true;
            s.onload = function() {
                console.log('Google Maps fallback script loaded successfully');
                window.__MAPS_ENABLED__ = true;
            };
            s.onerror = function() {
                console.error('Failed to load Google Maps fallback script');
            };
            document.head.appendChild(s);
        }

        function initMap() {
            if (!window.__MAPS_ENABLED__ || typeof google === 'undefined' || !google.maps) {
                console.log('Google Maps not available, using fallback methods');
                // Maps not available; hide preview UI gracefully
                const preview = document.getElementById('mapPreview');
                if (preview) preview.style.display = 'none';
                return;
            }
            
            console.log('Initializing Google Maps...');
            
            // Initialize map centered on Johannesburg
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -26.2041, lng: 28.0473 },
                zoom: 10
            });
            
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            // Initialize autocomplete for pickup address
            pickupAutocomplete = new google.maps.places.Autocomplete(document.getElementById('pickupAddress'), {
                componentRestrictions: { country: 'za' },
                fields: ['formatted_address', 'geometry', 'name']
            });

            // Initialize autocomplete for delivery address
            deliveryAutocomplete = new google.maps.places.Autocomplete(document.getElementById('deliveryAddress'), {
                componentRestrictions: { country: 'za' },
                fields: ['formatted_address', 'geometry', 'name']
            });

            // Capture coordinates when place is selected
            pickupAutocomplete.addListener('place_changed', function() {
                const place = pickupAutocomplete.getPlace();
                if (place.geometry) {
                    document.getElementById('pickupLat').value = place.geometry.location.lat();
                    document.getElementById('pickupLng').value = place.geometry.location.lng();
                    console.log('Pickup coordinates set:', place.geometry.location.lat(), place.geometry.location.lng());
                }
            });

            deliveryAutocomplete.addListener('place_changed', function() {
                const place = deliveryAutocomplete.getPlace();
                if (place.geometry) {
                    document.getElementById('deliveryLat').value = place.geometry.location.lat();
                    document.getElementById('deliveryLng').value = place.geometry.location.lng();
                    console.log('Delivery coordinates set:', place.geometry.location.lat(), place.geometry.location.lng());
                }
            });
            
            console.log('Google Maps initialization completed');
        }

        function previewRoute() {
            const pickup = document.getElementById('pickupAddress').value;
            const delivery = document.getElementById('deliveryAddress').value;
            
            if (!pickup || !delivery) {
                showAlert('Please enter both pickup and delivery addresses', 'error');
                return;
            }
            
            console.log('Previewing route from', pickup, 'to', delivery);
            
            // Check if Google Maps is available
            if (window.__MAPS_ENABLED__ && typeof google !== 'undefined' && google.maps && directionsService && directionsRenderer) {
                console.log('Using Google Maps for route calculation');
                // Use Google Maps for accurate distance and route calculation
                calculateRouteWithGoogleMaps(pickup, delivery);
            } else {
                console.log('Google Maps not available, using fallback calculation');
                // Fallback to estimated distance calculation
                const estimatedDistance = calculateEstimatedDistance(pickup, delivery);
                
                // Show route information
                document.getElementById('routeDistance').textContent = estimatedDistance.toFixed(1);
                document.getElementById('routeDuration').textContent = estimateDuration(estimatedDistance);
                document.getElementById('mapPreview').style.display = 'block';
                
                showAlert(`Estimated distance: ${estimatedDistance.toFixed(1)} km. Duration: ${estimateDuration(estimatedDistance)} (Using fallback calculation)`, 'info');
            }
        }
        
        function calculateRouteWithGoogleMaps(pickup, delivery) {
            if (!directionsService || !directionsRenderer) {
                showAlert('Google Maps not properly initialized', 'error');
                return;
            }
            
            const request = {
                origin: pickup,
                destination: delivery,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false
            };
            
            directionsService.route(request, function(result, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    // Display the route on the map
                    directionsRenderer.setDirections(result);
                    
                    // Get distance and duration from the result
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    const distance = leg.distance.value / 1000; // Convert to km
                    const duration = leg.duration.value; // Duration in seconds
                    
                    // Update the display
                    document.getElementById('routeDistance').textContent = distance.toFixed(1);
                    document.getElementById('routeDuration').textContent = formatDuration(duration);
                    document.getElementById('mapPreview').style.display = 'block';
                    
                    // Show success message
                    showAlert(`Route calculated: ${distance.toFixed(1)} km. Duration: ${formatDuration(duration)}`, 'success');
                    
                    // Update hidden form fields with coordinates
                    if (leg.start_location) {
                        document.getElementById('pickupLat').value = leg.start_location.lat();
                        document.getElementById('pickupLng').value = leg.start_location.lng();
                    }
                    if (leg.end_location) {
                        document.getElementById('deliveryLat').value = leg.end_location.lat();
                        document.getElementById('deliveryLng').value = leg.end_location.lng();
                    }
                } else {
                    // Fallback to estimated calculation if Google Maps fails
                    console.error('Google Maps route calculation failed:', status);
                    const estimatedDistance = calculateEstimatedDistance(pickup, delivery);
                    
                    document.getElementById('routeDistance').textContent = estimatedDistance.toFixed(1);
                    document.getElementById('routeDuration').textContent = estimateDuration(estimatedDistance);
                    document.getElementById('mapPreview').style.display = 'block';
                    
                    showAlert(`Estimated distance: ${estimatedDistance.toFixed(1)} km. Duration: ${estimateDuration(estimatedDistance)} (Google Maps unavailable)`, 'info');
                }
            });
        }
        
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return hours + 'h ' + minutes + 'm';
            } else {
                return minutes + 'm';
            }
        }
        
        function calculateEstimatedDistance(address1, address2) {
            // Enhanced distance estimation with more South African locations
            const lower1 = address1.toLowerCase();
            const lower2 = address2.toLowerCase();
            
            // Major cities array for same-city detection
            const majorCities = [
                'johannesburg', 'jhb', 'pretoria', 'cape town', 'durban', 'sandton', 'midrand', 'soweto',
                'centurion', 'randburg', 'roodepoort', 'kempton park', 'boksburg', 'benoni', 'germiston',
                'alberton', 'krugersdorp', 'fourways', 'rosebank', 'melville', 'parktown', 'houghton',
                'bedfordview', 'edenvale', 'brakpan', 'springs', 'katlehong', 'vanderbijlpark', 'vereeniging',
                'port elizabeth', 'bloemfontein', 'nelspruit', 'polokwane', 'kimberley', 'richards bay',
                'east london', 'george'
            ];
            
            // Check for same city
            for (const city of majorCities) {
                if (lower1.includes(city) && lower2.includes(city)) {
                    return 10.0; // Intra-city distance
                }
            }
            
            // Specific inter-city distances (more accurate)
            if ((lower1.includes('johannesburg') || lower1.includes('jhb')) && lower2.includes('pretoria')) return 55.0;
            if (lower1.includes('pretoria') && (lower2.includes('johannesburg') || lower2.includes('jhb'))) return 55.0;
            
            if (lower1.includes('sandton') && lower2.includes('midrand')) return 20.0;
            if (lower1.includes('midrand') && lower2.includes('sandton')) return 20.0;
            
            if ((lower1.includes('johannesburg') || lower1.includes('jhb')) && lower2.includes('soweto')) return 25.0;
            if (lower1.includes('soweto') && (lower2.includes('johannesburg') || lower2.includes('jhb'))) return 25.0;
            
            if ((lower1.includes('johannesburg') || lower1.includes('jhb')) && lower2.includes('sandton')) return 15.0;
            if (lower1.includes('sandton') && (lower2.includes('johannesburg') || lower2.includes('jhb'))) return 15.0;
            
            if ((lower1.includes('johannesburg') || lower1.includes('jhb')) && lower2.includes('centurion')) return 45.0;
            if (lower1.includes('centurion') && (lower2.includes('johannesburg') || lower2.includes('jhb'))) return 45.0;
            
            if (lower1.includes('pretoria') && lower2.includes('centurion')) return 15.0;
            if (lower1.includes('centurion') && lower2.includes('pretoria')) return 15.0;
            
            // Cross-province distances
            if ((lower1.includes('johannesburg') || lower1.includes('jhb')) && lower2.includes('cape town')) return 1400.0;
            if ((lower2.includes('johannesburg') || lower2.includes('jhb')) && lower1.includes('cape town')) return 1400.0;
            
            if ((lower1.includes('johannesburg') || lower1.includes('jhb')) && lower2.includes('durban')) return 550.0;
            if ((lower2.includes('johannesburg') || lower2.includes('jhb')) && lower1.includes('durban')) return 550.0;
            
            // Default fallback based on region
            if (lower1.includes('gauteng') || lower2.includes('gauteng')) return 30.0;
            
            return 50.0; // Default for unknown routes
        }
        
        function estimateDuration(distanceKm) {
            // Estimate travel time based on distance
            // Assuming average speed of 40 km/h in city traffic
            const hours = distanceKm / 40;
            if (hours < 1) {
                return Math.round(hours * 60) + ' min';
            } else {
                const wholeHours = Math.floor(hours);
                const minutes = Math.round((hours - wholeHours) * 60);
                return wholeHours + 'h ' + minutes + 'm';
            }
        }

        // Alert system
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                type === 'info' ? 'bg-blue-500 text-white' : 'bg-gray-500 text-white'
            }`;
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function displayServiceOptions(services) {
            const container = document.getElementById('serviceOptionsList');
            container.innerHTML = '';
            
            // Check if services is defined and is an array
            if (!services || !Array.isArray(services)) {
                console.error('Services is not defined or not an array:', services);
                container.innerHTML = '<div class="text-center text-gray-500 p-4">No service options available</div>';
                return;
            }
            
            if (services.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 p-4">No service options available</div>';
                return;
            }
            
            console.log('Displaying', services.length, 'service options');
            
            services.forEach((service, index) => {
                const serviceCard = document.createElement('div');
                serviceCard.className = `service-card p-6 cursor-pointer hover-lift ${service.isRecommended ? 'recommended' : ''}`;
                serviceCard.innerHTML = `
                    <div class="text-center text-gray-900">
                        <div class="text-3xl font-bold text-gray-900 mb-3">R${service.cost}</div>
                        <div class="text-lg font-semibold text-gray-800 mb-2">${service.serviceType}</div>
                        <div class="text-sm text-gray-600 mb-4">${service.description}</div>
                        <div class="text-sm text-blue-600 font-medium">${service.estimatedDeliveryTime}</div>
                        ${service.isRecommended ? '<div class="text-xs text-green-600 font-bold mt-2 bg-green-100 px-2 py-1 rounded-full inline-block">RECOMMENDED</div>' : ''}
                    </div>
                `;
                
                serviceCard.addEventListener('click', () => selectService(service));
                container.appendChild(serviceCard);
            });
        }

        function selectService(service) {
            selectedService = service;
            
            // Update selected service details
            document.getElementById('resDistance').textContent = currentQuote.distanceKm.toFixed(1);
            document.getElementById('resTotal').textContent = service.cost;
            document.getElementById('resService').textContent = service.serviceType;
            document.getElementById('resDelivery').textContent = service.estimatedDeliveryTime;
            
            // Update cost breakdown
            document.getElementById('baseCost').textContent = currentQuote.baseCost;
            document.getElementById('serviceFee').textContent = currentQuote.serviceFee;
            document.getElementById('fuelSurcharge').textContent = currentQuote.fuelSurcharge;
            document.getElementById('insuranceFee').textContent = currentQuote.insuranceFee;
            
            // Show selected service details and payment section
            document.getElementById('selectedServiceDetails').style.display = 'block';
            document.getElementById('paymentSection').style.display = 'block';
            
            // Update order summary
            document.getElementById('orderPickup').textContent = currentQuote.pickupAddress;
            document.getElementById('orderDelivery').textContent = currentQuote.deliveryAddress;
            document.getElementById('orderWeight').textContent = currentQuote.weight + ' kg';
            document.getElementById('orderService').textContent = service.serviceType;
            document.getElementById('orderTotal').textContent = service.cost;
            
            // Scroll to payment section
            document.getElementById('paymentSection').scrollIntoView({ behavior: 'smooth' });
        }

        function processPayment() {
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            if (paymentMethod === 'paystack') {
                processPaystackPayment();
            } else if (paymentMethod === 'eft') {
                processEFTPayment();
            }
        }

        async function processPaystackPayment() {
            try {
                const selectedInsurance = document.querySelector('input[name="insurance"]:checked').value;
                const insuranceCosts = {
                    'none': 0,
                    'basic': 15,
                    'standard': 35,
                    'premium': 65
                };
                const insuranceCost = insuranceCosts[selectedInsurance] || 0;
                const totalAmount = selectedService.cost + insuranceCost;
                
                // Use authenticated user's email if available, otherwise use form email
                let userEmail = document.getElementById('senderEmail').value;
                const jwt = sessionStorage.getItem('jwtToken') || sessionStorage.getItem('token');
                if (jwt) {
                    // Try to get user email from JWT token or use a default
                    try {
                        const payload = JSON.parse(atob(jwt.split('.')[1]));
                        if (payload.sub || payload.email) {
                            userEmail = payload.sub || payload.email;
                        }
                    } catch (e) {
                        // Keep form email if JWT parsing fails
                    }
                }
                
                const paymentData = {
                    shipmentId: currentQuote.quoteId,
                    amount: totalAmount,
                    email: userEmail,
                    serviceType: selectedService.serviceType,
                    insuranceType: selectedInsurance,
                    insuranceCost: insuranceCost
                };

                // Attach Authorization header if JWT token present (logged-in user)
                const headers = { 'Content-Type': 'application/json' };
                if (jwt) headers['Authorization'] = 'Bearer ' + jwt;

                const response = await fetch('/api/paystack/initialize', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(paymentData)
                });
                
                if (!response.ok) throw new Error('Payment initialization failed');
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Redirect to Paystack payment page
                    window.location.href = result.authorizationUrl;
                } else {
                    throw new Error(result.message || 'Payment failed');
                }
            } catch (error) {
                alert('Payment failed: ' + error.message);
            }
        }

        async function processEFTPayment() {
            try {
                // Create shipment with EFT payment
                const shipmentData = {
                    senderName: 'Customer',
                    senderEmail: document.getElementById('senderEmail').value,
                    pickupAddress: document.getElementById('pickupAddress').value,
                    pickupCity: 'Johannesburg',
                    pickupState: 'Gauteng',
                    pickupZipCode: '2000',
                    pickupCountry: 'South Africa',
                    recipientName: 'Recipient',
                    recipientEmail: document.getElementById('senderEmail').value,
                    deliveryAddress: document.getElementById('deliveryAddress').value,
                    deliveryCity: 'Pretoria',
                    deliveryState: 'Gauteng',
                    deliveryZipCode: '0001',
                    deliveryCountry: 'South Africa',
                    weight: parseFloat(document.getElementById('weight').value),
                    serviceType: selectedService.serviceType,
                    paymentMethod: 'EFT'
                };
                
                // Include Authorization header for authenticated users
                const jwtForShipment = sessionStorage.getItem('jwtToken') || sessionStorage.getItem('token');
                const shipmentHeaders = { 'Content-Type': 'application/json' };
                if (jwtForShipment) shipmentHeaders['Authorization'] = 'Bearer ' + jwtForShipment;

                const response = await fetch(`/api/customer/quote/${currentQuote.quoteId}/create-shipment`, {
                    method: 'POST',
                    headers: shipmentHeaders,
                    body: JSON.stringify(shipmentData)
                });
                
                if (!response.ok) throw new Error('Shipment creation failed');
                
                const result = await response.json();
                
                // Show EFT payment instructions
                showEFTPaymentInstructions(result.trackingNumber, selectedService.cost);
                
            } catch (error) {
                alert('Order creation failed: ' + error.message);
            }
        }

        function showEFTPaymentInstructions(trackingNumber, amount) {
            const modal = document.getElementById('orderConfirmationModal');
            const content = modal.querySelector('.bg-white');
            
            content.innerHTML = `
                <div class="text-center">
                    <div class="mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-university text-blue-600 text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">EFT Payment Required</h3>
                    <p class="text-gray-600 mb-4">Your shipment has been created. Please complete payment via EFT.</p>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="text-sm text-gray-600 mb-2">Tracking Number:</div>
                        <div class="text-2xl font-bold text-blue-600">${trackingNumber}</div>
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-4 mb-6 text-left">
                        <h4 class="font-semibold text-gray-900 mb-2">Payment Details:</h4>
                        <div class="space-y-1 text-sm text-gray-600">
                            <div><strong>Amount:</strong> R${amount}</div>
                            <div><strong>Reference:</strong> ${trackingNumber}</div>
                            <div><strong>Bank:</strong> Standard Bank</div>
                            <div><strong>Account:</strong> 1234567890</div>
                            <div><strong>Branch:</strong> 051001</div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600 mb-6">
                        <p>Once payment is confirmed, your shipment will be processed and you'll receive tracking updates.</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="trackNewPackage()" 
                                class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Track Package
                        </button>
                        <button onclick="closeConfirmationModal()" 
                                class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function trackNewPackage() {
            window.location.href = '/customer/track';
        }

        function closeConfirmationModal() {
            document.getElementById('orderConfirmationModal').style.display = 'none';
        }

        document.getElementById('quoteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Getting Quote...';
            submitBtn.disabled = true;
            
            const useLoc = document.getElementById('useCurrentLocation').checked;
            // Get selected insurance
            const selectedInsurance = document.querySelector('input[name="insurance"]:checked').value;
            const insuranceCosts = {
                'none': 0,
                'basic': 15,
                'standard': 35,
                'premium': 65
            };
            
            const payload = {
                senderName: 'Customer',
                senderEmail: document.getElementById('senderEmail').value,
                pickupAddress: document.getElementById('pickupAddress').value,
                pickupCity: 'Johannesburg',
                pickupState: 'Gauteng',
                pickupZipCode: '2000',
                pickupCountry: 'South Africa',
                recipientName: 'Recipient',
                recipientEmail: document.getElementById('senderEmail').value,
                deliveryAddress: document.getElementById('deliveryAddress').value,
                deliveryCity: 'Pretoria',
                deliveryState: 'Gauteng',
                deliveryZipCode: '0001',
                deliveryCountry: 'South Africa',
                weight: parseFloat(document.getElementById('weight').value),
                serviceType: 'OVERNIGHT',
                insuranceType: selectedInsurance,
                insuranceCost: insuranceCosts[selectedInsurance]
            };
            
            // Add coordinates if available
            if (document.getElementById('pickupLat').value) {
                payload.pickupLatitude = parseFloat(document.getElementById('pickupLat').value);
                payload.pickupLongitude = parseFloat(document.getElementById('pickupLng').value);
            }
            if (document.getElementById('deliveryLat').value) {
                payload.deliveryLatitude = parseFloat(document.getElementById('deliveryLat').value);
                payload.deliveryLongitude = parseFloat(document.getElementById('deliveryLng').value);
            }
            
            if (useLoc && navigator.geolocation) {
                try {
                    const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
                    payload.pickupLatitude = pos.coords.latitude;
                    payload.pickupLongitude = pos.coords.longitude;
                } catch {}
            }

            try {
                const resp = await fetch('/api/customer/quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!resp.ok) throw new Error('Failed to get quote');
                
                const response = await resp.json();
                console.log('Quote response data:', response);
                
                // Handle different response structures
                let data, availableServices;
                if (response.success && response.data) {
                    // Wrapped response structure
                    data = response.data;
                    availableServices = data.availableServices;
                    console.log('Using wrapped response structure');
                } else {
                    // Direct response structure
                    data = response;
                    availableServices = data.availableServices;
                    console.log('Using direct response structure');
                }
                
                console.log('Final data object:', data);
                console.log('Final availableServices:', availableServices);
                console.log('AvailableServices type:', typeof availableServices);
                console.log('AvailableServices is array:', Array.isArray(availableServices));
                
                currentQuote = data;
                
                // Display service options
                displayServiceOptions(availableServices);
                
                // Show quote results
                document.getElementById('quoteResult').style.display = 'block';
                
                // Scroll to results
                document.getElementById('quoteResult').scrollIntoView({ behavior: 'smooth' });
                
            } catch (e) {
                console.error('Quote creation error:', e);
                console.error('Error details:', e.message, e.stack);
                alert('Could not create quote: ' + e.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Payment button event listener
        document.getElementById('proceedToPayment').addEventListener('click', processPayment);

        // Initialize when page loads
        window.onload = function() {
            console.log('Page loaded, checking Google Maps availability...');
            console.log('__MAPS_ENABLED__:', window.__MAPS_ENABLED__);
            console.log('google object:', typeof google);
            
            // Try to initialize immediately
            if (window.__MAPS_ENABLED__ && typeof google !== 'undefined' && google.maps) {
                console.log('Google Maps available immediately');
                initMap();
            } else {
                console.log('Google Maps not immediately available, waiting...');
                // Wait a bit for Google Maps to load
                setTimeout(function() {
                    console.log('After timeout - __MAPS_ENABLED__:', window.__MAPS_ENABLED__);
                    console.log('After timeout - google object:', typeof google);
                    if (window.__MAPS_ENABLED__ && typeof google !== 'undefined' && google.maps) {
                        console.log('Google Maps became available after timeout');
                        initMap();
                    } else {
                        console.log('Google Maps still not available after timeout');
                        // Try to load Google Maps with a hardcoded key as fallback
                        loadGoogleMapsFallback();
                    }
                }, 3000);
            }
            // Prefill sender email if user is logged in
            try {
                const userEmail = sessionStorage.getItem('userEmail') || sessionStorage.getItem('pending2faEmail');
                if (userEmail) document.getElementById('senderEmail').value = userEmail;
            } catch (e) {}
        };
    </script>
</body>
</html>


