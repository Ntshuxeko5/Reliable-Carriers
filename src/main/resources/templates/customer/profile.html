<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Reliable Carriers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand': {
                            50: '#fefce8',
                            100: '#fef9c3',
                            200: '#fef08a',
                            300: '#fde047',
                            400: '#facc15',
                            500: '#dbb714',
                            600: '#ca8a04',
                            700: '#a16207',
                            800: '#854d0e',
                            900: '#713f12',
                        },
                        'brand-blue': {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#071c91',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 font-sans">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-brand-blue-900 to-brand-blue-800 text-white shadow-lg nav-header sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <a href="/" class="flex items-center space-x-2 text-2xl font-bold text-white hover:text-brand-300 transition-colors duration-300">
                    <span class="inline-flex items-center justify-center bg-white/10 rounded-full p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" class="h-8 w-8 text-white" fill="currentColor" aria-hidden="true">
                            <rect x="4" y="20" width="40" height="20" rx="2" />
                            <rect x="44" y="28" width="12" height="8" rx="1" />
                            <circle cx="18" cy="44" r="4" fill="white" />
                            <circle cx="46" cy="44" r="4" fill="white" />
                        </svg>
                    </span>
                    <span>Reliable Carriers</span>
                </a>
                <div class="hidden md:flex space-x-8">
                    <a href="/customer" class="text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <a href="/customer/track" class="text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-search mr-2"></i>Track Package
                    </a>
                    <a href="/customer/quote" class="text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-calculator mr-2"></i>Get Quote
                    </a>
                    <a href="/customer/packages" class="text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-boxes mr-2"></i>My Packages
                    </a>
                    <a href="/customer/profile" class="text-brand-300 hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-user mr-2"></i>Profile
                    </a>
                    <a href="/logout" class="text-white hover:text-brand-300 transition-colors duration-300 font-medium flex items-center">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-user-circle mr-3 text-brand-600"></i>My Profile
                </h1>
                <p class="text-xl text-gray-700">Manage your personal information and preferences</p>
            </div>

            <!-- Profile Picture Section -->
            <div class="text-center mb-8">
                <div class="relative inline-block">
                    <div class="w-32 h-32 mx-auto mb-4 rounded-full overflow-hidden bg-gray-200 border-4 border-white shadow-lg">
                        <img id="profilePicture" src="/images/default-avatar.svg" alt="Profile Picture" 
                             class="w-full h-full object-cover">
                    </div>
                    <button type="button" onclick="document.getElementById('profileImageInput').click()" 
                            class="absolute bottom-0 right-0 bg-brand-500 text-white rounded-full p-2 hover:bg-brand-600 transition-colors duration-300 shadow-lg">
                        <i class="fas fa-camera text-sm"></i>
                    </button>
                </div>
                <input type="file" id="profileImageInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                <p class="text-sm text-gray-500">Click the camera icon to upload a profile picture</p>
            </div>

            <!-- Profile Form -->
            <form id="profileForm" class="space-y-6" enctype="multipart/form-data">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                        <input id="firstName" name="firstName" type="text" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-300">
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                        <input id="lastName" name="lastName" type="text" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-300">
                    </div>
                </div>

                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                    <input id="email" name="email" type="email" readonly
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                    <p class="text-sm text-gray-500 mt-1">Email cannot be changed</p>
                </div>

                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                    <input id="phone" name="phone" type="tel"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-300"
                           placeholder="+27 11 123 4567">
                </div>

                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                    <input id="address" name="address" type="text"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-300"
                           placeholder="123 Main Street">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700 mb-2">City</label>
                        <input id="city" name="city" type="text"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-300"
                               placeholder="Johannesburg">
                    </div>
                    <div>
                        <label for="state" class="block text-sm font-medium text-gray-700 mb-2">Province</label>
                        <input id="state" name="state" type="text"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-300"
                               placeholder="Gauteng">
                    </div>
                    <div>
                        <label for="zipCode" class="block text-sm font-medium text-gray-700 mb-2">Postal Code</label>
                        <input id="zipCode" name="zipCode" type="text"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-300"
                               placeholder="2000">
                    </div>
                </div>

                <div>
                    <label for="country" class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                    <input id="country" name="country" type="text"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-300"
                           placeholder="South Africa">
                </div>

                <div>
                    <label for="insurancePreference" class="block text-sm font-medium text-gray-700 mb-2">Insurance Preference</label>
                    <select id="insurancePreference" name="insurancePreference"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-300">
                        <option value="BUDGET">Budget</option>
                        <option value="BASIC">Basic</option>
                        <option value="STANDARD">Standard</option>
                        <option value="PREMIUM">Premium</option>
                    </select>
                </div>

                <div class="flex gap-4">
                    <button type="submit"
                            class="bg-gradient-to-r from-brand-500 to-brand-600 text-white px-8 py-3 rounded-lg font-bold hover:from-brand-600 hover:to-brand-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                    <button type="button" onclick="changePassword()"
                            class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:from-blue-600 hover:to-blue-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-key mr-2"></i>Change Password
                    </button>
                    <a href="/customer"
                       class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-3 rounded-lg font-bold hover:from-gray-600 hover:to-gray-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-gray-900 mb-6">Change Password</h3>
            <form id="passwordForm" class="space-y-4">
                <div>
                    <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                    <input id="currentPassword" name="currentPassword" type="password" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-300">
                </div>
                <div>
                    <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                    <input id="newPassword" name="newPassword" type="password" required minlength="6"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-300">
                </div>
                <div>
                    <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                    <input id="confirmPassword" name="confirmPassword" type="password" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-300">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit"
                            class="flex-1 bg-gradient-to-r from-brand-500 to-brand-600 text-white px-4 py-3 rounded-lg font-bold hover:from-brand-600 hover:to-brand-700 transition-all duration-300">
                        <i class="fas fa-save mr-2"></i>Change Password
                    </button>
                    <button type="button" onclick="closePasswordModal()"
                            class="flex-1 bg-gray-500 text-white px-4 py-3 rounded-lg font-bold hover:bg-gray-600 transition-all duration-300">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Load profile data
        async function loadProfile() {
            try {
                const token = sessionStorage.getItem('token') || sessionStorage.getItem('jwtToken');
                const response = await fetch('/api/customer/profile', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                
                if (response.ok) {
                    const profile = await response.json();
                    
                    // Fill form fields
                    document.getElementById('firstName').value = profile.firstName || '';
                    document.getElementById('lastName').value = profile.lastName || '';
                    document.getElementById('email').value = profile.email || '';
                    document.getElementById('phone').value = profile.phone || '';
                    document.getElementById('address').value = profile.address || '';
                    document.getElementById('city').value = profile.city || '';
                    document.getElementById('state').value = profile.state || '';
                    document.getElementById('zipCode').value = profile.zipCode || '';
                    document.getElementById('country').value = profile.country || '';
                    document.getElementById('insurancePreference').value = profile.insurancePreference || 'BUDGET';
                    
                    // Set profile picture if available
                    if (profile.profilePicture) {
                        document.getElementById('profilePicture').src = profile.profilePicture;
                    }
                } else {
                    showAlert('Failed to load profile data', 'error');
                }
            } catch (error) {
                showAlert('Error loading profile: ' + error.message, 'error');
            }
        }

        // Handle profile picture upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showAlert('Please select a valid image file', 'error');
                    return;
                }
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('Image size should be less than 5MB', 'error');
                    return;
                }
                
                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePicture').src = e.target.result;
                };
                reader.readAsDataURL(file);
                
                // Upload the image
                uploadProfilePicture(file);
            }
        }

        // Upload profile picture
        async function uploadProfilePicture(file) {
            try {
                const formData = new FormData();
                formData.append('profilePicture', file);
                
                const token = sessionStorage.getItem('token') || sessionStorage.getItem('jwtToken');
                const response = await fetch('/api/customer/profile/picture', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert('Profile picture updated successfully!', 'success');
                    // Update the profile picture URL
                    if (result.profilePictureUrl) {
                        document.getElementById('profilePicture').src = result.profilePictureUrl;
                    }
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to upload profile picture', 'error');
                }
            } catch (error) {
                showAlert('Error uploading profile picture: ' + error.message, 'error');
            }
        }

        // Save profile
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const profileData = {};
            
            for (let [key, value] of formData.entries()) {
                profileData[key] = value;
            }
            
            try {
                const token = sessionStorage.getItem('token') || sessionStorage.getItem('jwtToken');
                const response = await fetch('/api/customer/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(profileData)
                });
                
                if (response.ok) {
                    showAlert('Profile updated successfully!', 'success');
                    await loadProfile(); // Reload to get updated data
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                showAlert('Error updating profile: ' + error.message, 'error');
            }
        });

        // Change password
        function changePassword() {
            document.getElementById('passwordModal').classList.remove('hidden');
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('passwordForm').reset();
        }

        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const currentPassword = formData.get('currentPassword');
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');
            
            if (newPassword !== confirmPassword) {
                showAlert('New passwords do not match', 'error');
                return;
            }
            
            try {
                const token = sessionStorage.getItem('token') || sessionStorage.getItem('jwtToken');
                const response = await fetch('/api/customer/profile/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                if (response.ok) {
                    showAlert('Password changed successfully!', 'success');
                    closePasswordModal();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to change password', 'error');
                }
            } catch (error) {
                showAlert('Error changing password: ' + error.message, 'error');
            }
        });

        // Alert system
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Load profile on page load
        window.onload = loadProfile;
    </script>
</body>
</html>
