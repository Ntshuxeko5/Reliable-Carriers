<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Reliable Carriers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapsApiKey} + '&libraries=places'" async defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
        .hover-lift { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .success-animation { animation: successPulse 2s ease-in-out infinite; }
        .code-highlight { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        @keyframes successPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Confetti Animation -->
    <div id="confetti" class="confetti"></div>

    <!-- Header -->
    <header class="bg-white/10 backdrop-blur-md border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <a href="/" class="flex items-center">
                        <i class="fas fa-shipping-fast text-3xl text-yellow-400 mr-3"></i>
                        <span class="text-2xl font-bold text-white">Reliable Carriers</span>
                    </a>
                </div>
                <div class="text-white">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span class="font-medium">Payment Successful</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Success Message -->
        <div class="text-center mb-8">
            <div class="success-animation inline-block mb-4">
                <i class="fas fa-check-circle text-6xl text-white"></i>
            </div>
            <h1 class="text-4xl font-bold text-white mb-2">Payment Successful!</h1>
            <p class="text-xl text-blue-100">Your package is ready for pickup</p>
        </div>

        <!-- Booking Details Card -->
        <div class="bg-white rounded-2xl shadow-2xl p-8 mb-8 hover-lift">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-receipt mr-2 text-blue-600"></i>Booking Confirmation
                </h2>
                <p class="text-gray-600">Keep this information for your records</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Booking Information -->
                <div class="space-y-6">
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-info-circle mr-2 text-blue-600"></i>Booking Details
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Booking Number:</span>
                                <span class="font-bold text-gray-800" id="bookingNumber">RC1234567890</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Customer:</span>
                                <span class="font-semibold text-gray-800" id="customerName">John Doe</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Service:</span>
                                <span class="font-semibold text-gray-800" id="serviceType">Express Delivery</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total Amount:</span>
                                <span class="font-bold text-blue-600" id="totalAmount">R250.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status:</span>
                                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium" id="status">Pending Pickup</span>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Addresses with Google Maps -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-map-marker-alt mr-2 text-blue-600"></i>Delivery Addresses
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-start">
                                <i class="fas fa-hand-holding-box text-blue-500 mt-1 mr-3"></i>
                                <div class="flex-1">
                                    <div class="text-sm text-gray-600 font-medium mb-1">Pickup Address:</div>
                                    <div class="text-gray-800 mb-2" id="pickupAddress">Loading address...</div>
                                    <div id="pickupMap" class="w-full h-32 rounded-lg border border-gray-300 mb-2"></div>
                                    <a id="pickupDirections" href="#" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                                        <i class="fas fa-directions mr-1"></i>Get Directions
                                    </a>
                                </div>
                            </div>
                            <div class="flex items-start mt-4">
                                <i class="fas fa-truck text-blue-500 mt-1 mr-3"></i>
                                <div class="flex-1">
                                    <div class="text-sm text-gray-600 font-medium mb-1">Delivery Address:</div>
                                    <div class="text-gray-800 mb-2" id="deliveryAddress">Loading address...</div>
                                    <div id="deliveryMap" class="w-full h-32 rounded-lg border border-gray-300 mb-2"></div>
                                    <a id="deliveryDirections" href="#" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                                        <i class="fas fa-directions mr-1"></i>Get Directions
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Verification Codes -->
                <div class="space-y-6">
                    <div class="code-highlight rounded-xl p-6 border-2 border-yellow-300">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-key mr-2 text-yellow-600"></i>Verification Codes
                        </h3>
                        <div class="space-y-4">
                            <div class="text-center">
                                <div class="text-sm text-gray-600 mb-2">Pickup Code</div>
                                <div class="text-3xl font-bold text-gray-800 bg-white rounded-lg p-4 border-2 border-yellow-400" id="pickupCode">P123456</div>
                                <div class="text-xs text-gray-500 mt-2">Show this code to the driver during pickup</div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-gray-600 mb-2">Delivery Code</div>
                                <div class="text-3xl font-bold text-gray-800 bg-white rounded-lg p-4 border-2 border-yellow-400" id="deliveryCode">D789012</div>
                                <div class="text-xs text-gray-500 mt-2">Show this code to the driver during delivery</div>
                            </div>
                        </div>
                    </div>

                    <!-- Next Steps -->
                    <div class="bg-blue-50 rounded-xl p-6 border border-blue-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-list-check mr-2 text-blue-600"></i>What Happens Next?
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center mr-3 mt-0.5">
                                    <span class="text-white text-xs font-bold">1</span>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800">Driver Assignment</div>
                                    <div class="text-sm text-gray-600">A driver will be assigned to your package</div>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center mr-3 mt-0.5">
                                    <span class="text-white text-xs font-bold">2</span>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800">Pickup Notification</div>
                                    <div class="text-sm text-gray-600">You'll receive a notification when pickup is scheduled</div>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center mr-3 mt-0.5">
                                    <span class="text-white text-xs font-bold">3</span>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800">Live Tracking</div>
                                    <div class="text-sm text-gray-600">Track your package in real-time</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center space-y-4">
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="trackPackage()" class="bg-white hover:bg-gray-50 text-gray-800 font-bold py-3 px-6 rounded-xl transition-all duration-300 flex items-center justify-center shadow-lg">
                    <i class="fas fa-map-marked-alt mr-2"></i>
                    Track Package
                </button>
                <button onclick="downloadReceipt()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 flex items-center justify-center shadow-lg">
                    <i class="fas fa-download mr-2"></i>
                    Download Receipt
                </button>
                <button onclick="goHome()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 flex items-center justify-center shadow-lg">
                    <i class="fas fa-home mr-2"></i>
                    Go Home
                </button>
            </div>
        </div>

        <!-- Contact Information -->
        <div class="mt-8 text-center">
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-6">
                <h3 class="text-lg font-semibold text-white mb-4">Need Help?</h3>
                <div class="flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-6 text-white">
                    <div class="flex items-center">
                        <i class="fas fa-phone mr-2"></i>
                        <span>+27 11 123 4567</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-envelope mr-2"></i>
                        <span>support@reliablecarriers.co.za</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-clock mr-2"></i>
                        <span>24/7 Support</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store payment ID globally for receipt download
        let currentPaymentId = null;
        
        // Load customer profile
        async function loadCustomerProfile() {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            if (!token) return null;
            
            try {
                const response = await fetch('/api/customer/profile', {
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const profile = await response.json();
                    return profile;
                }
            } catch (error) {
                console.error('Error loading customer profile:', error);
            }
            return null;
        }

        // Load booking details from URL parameters
        async function loadBookingDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('bookingId');
            const reference = urlParams.get('reference');
            
            // Load customer profile first
            const customerProfile = await loadCustomerProfile();
            
            if (bookingId) {
                try {
                    // Fetch booking details from booking API
                    const response = await fetch(`/api/booking/${bookingId}`, {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        // Handle both direct booking object and wrapped response
                        const booking = result.booking || result;
                        updateBookingDisplay(booking, customerProfile);
                    } else {
                        // Try payment endpoint as fallback
                        const paymentResponse = await fetch(`/api/payment/booking/${bookingId}`, {
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include'
                        });
                        if (paymentResponse.ok) {
                            const data = await paymentResponse.json();
                            // Store payment ID if available
                            if (data.id || data.paymentId) {
                                currentPaymentId = data.id || data.paymentId;
                            }
                            updateBookingDisplay(data, customerProfile);
                        } else {
                            loadFromUrlParams(customerProfile);
                        }
                    }
                } catch (error) {
                    console.error('Error loading booking details:', error);
                    loadFromUrlParams(customerProfile);
                }
            } else if (reference) {
                // Try to get booking from payment reference
                try {
                    const verifyResponse = await fetch(`/api/paystack/verify?reference=${reference}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    if (verifyResponse.ok) {
                        const verifyData = await verifyResponse.json();
                        
                        // If we have bookingId, try to load full booking details
                        if (verifyData.bookingId) {
                            try {
                                const bookingResponse = await fetch(`/api/booking/${verifyData.bookingId}`, {
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    credentials: 'include'
                                });
                                if (bookingResponse.ok) {
                                    const bookingResult = await bookingResponse.json();
                                    const booking = bookingResult.booking || bookingResult;
                                    updateBookingDisplay(booking, customerProfile);
                                    return;
                                }
                            } catch (error) {
                                console.error('Error loading booking from bookingId:', error);
                            }
                        }
                        
                        // Use payment verification data directly if it has shipment details
                        // CRITICAL: Always prioritize tracking number from verifyData, then URL params
                        const trackingFromVerify = verifyData.trackingNumber || verifyData.bookingNumber;
                        const trackingFromUrl = urlParams.get('trackingNumber') || urlParams.get('tracking');
                        const finalTrackingNumber = trackingFromVerify || trackingFromUrl;
                        
                        if (finalTrackingNumber || verifyData.pickupAddress || verifyData.deliveryAddress || verifyData.trackingNumber) {
                            const urlParams = new URLSearchParams(window.location.search);
                            // Map payment verification response to booking display format
                            const displayData = {
                                bookingNumber: finalTrackingNumber || 'RC1234567890',
                                trackingNumber: finalTrackingNumber || verifyData.trackingNumber || verifyData.bookingNumber,
                                customerName: verifyData.customerName || urlParams.get('customerName'),
                                customerFirstName: verifyData.customerName ? verifyData.customerName.split(' ')[0] : null,
                                customerLastName: verifyData.customerName ? verifyData.customerName.split(' ').slice(1).join(' ') : null,
                                serviceType: verifyData.serviceType || urlParams.get('service') || urlParams.get('serviceType') || 'Express Delivery',
                                totalAmount: verifyData.amount || urlParams.get('amount') || urlParams.get('totalAmount'),
                                amount: verifyData.amount || urlParams.get('amount') || urlParams.get('totalAmount'),
                                pickupAddress: verifyData.pickupAddress || urlParams.get('pickupAddress'),
                                pickupCity: verifyData.pickupCity || urlParams.get('pickupCity'),
                                pickupState: verifyData.pickupState || urlParams.get('pickupState'),
                                pickupCountry: verifyData.pickupCountry || urlParams.get('pickupCountry'),
                                deliveryAddress: verifyData.deliveryAddress || urlParams.get('deliveryAddress'),
                                deliveryCity: verifyData.deliveryCity || urlParams.get('deliveryCity'),
                                deliveryState: verifyData.deliveryState || urlParams.get('deliveryState'),
                                deliveryCountry: verifyData.deliveryCountry || urlParams.get('deliveryCountry'),
                                collectionCode: verifyData.collectionCode || urlParams.get('collectionCode'),
                                dropOffCode: verifyData.dropOffCode || urlParams.get('dropOffCode'),
                                pickupCode: verifyData.collectionCode || urlParams.get('collectionCode') || urlParams.get('pickupCode'),
                                deliveryCode: verifyData.dropOffCode || urlParams.get('dropOffCode') || urlParams.get('deliveryCode'),
                                status: verifyData.status || urlParams.get('status') || 'Confirmed',
                                customerEmail: verifyData.customerEmail || urlParams.get('email'),
                                customerPhone: verifyData.customerPhone || urlParams.get('customerPhone')
                            };
                            
                            console.log('Display data from verify response:', displayData);
                            console.log('Tracking number:', displayData.trackingNumber);
                            
                            updateBookingDisplay(displayData, customerProfile);
                            return;
                        }
                        
                        // If we have bookingId but couldn't load booking, reload with bookingId
                        if (verifyData.bookingId) {
                            window.location.href = `/payment-success?bookingId=${verifyData.bookingId}&reference=${reference}`;
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Error verifying payment:', error);
                }
                // Fallback to URL params if verification fails
                loadFromUrlParams(customerProfile);
            } else {
                loadFromUrlParams(customerProfile);
            }
        }

        function loadFromUrlParams(customerProfile) {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Build data object from URL parameters
            const urlData = {
                bookingNumber: urlParams.get('bookingNumber') || urlParams.get('trackingNumber') || urlParams.get('tracking'),
                trackingNumber: urlParams.get('trackingNumber') || urlParams.get('tracking') || urlParams.get('bookingNumber'),
                customerName: urlParams.get('customerName'),
                serviceType: urlParams.get('serviceType') || urlParams.get('service'),
                totalAmount: urlParams.get('totalAmount') || urlParams.get('amount'),
                amount: urlParams.get('amount') || urlParams.get('totalAmount'),
                pickupAddress: urlParams.get('pickupAddress'),
                pickupCity: urlParams.get('pickupCity'),
                pickupState: urlParams.get('pickupState'),
                deliveryAddress: urlParams.get('deliveryAddress'),
                deliveryCity: urlParams.get('deliveryCity'),
                deliveryState: urlParams.get('deliveryState'),
                collectionCode: urlParams.get('collectionCode'),
                dropOffCode: urlParams.get('dropOffCode'),
                pickupCode: urlParams.get('collectionCode'),
                deliveryCode: urlParams.get('dropOffCode'),
                status: urlParams.get('status') || 'Confirmed'
            };
            
            // Use updateBookingDisplay to ensure consistent formatting
            updateBookingDisplay(urlData, customerProfile);
            
            // Fallback for customer name if not in URL data
            if (document.getElementById('customerName') && !urlData.customerName) {
                if (customerProfile && customerProfile.firstName && customerProfile.lastName) {
                    document.getElementById('customerName').textContent = `${customerProfile.firstName} ${customerProfile.lastName}`;
                } else {
                    document.getElementById('customerName').textContent = 'Guest User';
                }
            }
            // Construct full address from URL params if available
            const pickupAddrFromUrl = urlParams.get('pickupAddress');
            const deliveryAddrFromUrl = urlParams.get('deliveryAddress');
            
            if (document.getElementById('pickupAddress')) {
                if (pickupAddrFromUrl) {
                    const parts = [pickupAddrFromUrl];
                    if (urlParams.get('pickupCity')) parts.push(urlParams.get('pickupCity'));
                    if (urlParams.get('pickupState')) parts.push(urlParams.get('pickupState'));
                    if (urlParams.get('pickupPostalCode')) parts.push(urlParams.get('pickupPostalCode'));
                    document.getElementById('pickupAddress').textContent = parts.join(', ');
                } else {
                    document.getElementById('pickupAddress').textContent = 'Address not available';
                }
            }
            if (document.getElementById('deliveryAddress')) {
                if (deliveryAddrFromUrl) {
                    const parts = [deliveryAddrFromUrl];
                    if (urlParams.get('deliveryCity')) parts.push(urlParams.get('deliveryCity'));
                    if (urlParams.get('deliveryState')) parts.push(urlParams.get('deliveryState'));
                    if (urlParams.get('deliveryPostalCode')) parts.push(urlParams.get('deliveryPostalCode'));
                    document.getElementById('deliveryAddress').textContent = parts.join(', ');
                } else {
                    document.getElementById('deliveryAddress').textContent = 'Address not available';
                }
            }
            if (document.getElementById('pickupCode')) {
                document.getElementById('pickupCode').textContent = urlParams.get('pickupCode') || 'P123456';
            }
            if (document.getElementById('deliveryCode')) {
                document.getElementById('deliveryCode').textContent = urlParams.get('deliveryCode') || 'D789012';
            }
            
            // Initialize maps with URL params if available
            // Reuse variables already declared above
            
            // Construct full addresses for maps
            let pickupAddrForMap = '';
            if (pickupAddrFromUrl) {
                const parts = [pickupAddrFromUrl];
                if (urlParams.get('pickupCity')) parts.push(urlParams.get('pickupCity'));
                if (urlParams.get('pickupState')) parts.push(urlParams.get('pickupState'));
                if (urlParams.get('pickupPostalCode')) parts.push(urlParams.get('pickupPostalCode'));
                pickupAddrForMap = parts.join(', ');
            }
            
            let deliveryAddrForMap = '';
            if (deliveryAddrFromUrl) {
                const parts = [deliveryAddrFromUrl];
                if (urlParams.get('deliveryCity')) parts.push(urlParams.get('deliveryCity'));
                if (urlParams.get('deliveryState')) parts.push(urlParams.get('deliveryState'));
                if (urlParams.get('deliveryPostalCode')) parts.push(urlParams.get('deliveryPostalCode'));
                deliveryAddrForMap = parts.join(', ');
            }
            
            const pickupLat = urlParams.get('pickupLatitude');
            const pickupLng = urlParams.get('pickupLongitude');
            const deliveryLat = urlParams.get('deliveryLatitude');
            const deliveryLng = urlParams.get('deliveryLongitude');
            
            // Update directions links from URL params
            const pickupDirectionsLink = document.getElementById('pickupDirections');
            const deliveryDirectionsLink = document.getElementById('deliveryDirections');
            if (pickupDirectionsLink && pickupAddrForMap) {
                pickupDirectionsLink.href = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(pickupAddrForMap)}`;
                pickupDirectionsLink.style.display = 'inline';
            } else if (pickupDirectionsLink) {
                pickupDirectionsLink.style.display = 'none';
            }
            if (deliveryDirectionsLink && deliveryAddrForMap) {
                deliveryDirectionsLink.href = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(deliveryAddrForMap)}`;
                deliveryDirectionsLink.style.display = 'inline';
            } else if (deliveryDirectionsLink) {
                deliveryDirectionsLink.style.display = 'none';
            }
            
            // Only initialize maps if we have actual addresses
            if (typeof google !== 'undefined' && google.maps && (pickupAddrForMap || deliveryAddrForMap)) {
                initializeMaps(pickupAddrForMap, deliveryAddrForMap, pickupLat, pickupLng, deliveryLat, deliveryLng);
            }
        }

        let pickupMap = null;
        let deliveryMap = null;
        let pickupMarker = null;
        let deliveryMarker = null;

        function updateBookingDisplay(data, customerProfile) {
            // CRITICAL: Update booking number - prioritize trackingNumber
            // This is the most important field for the user
            const bookingNumberElement = document.getElementById('bookingNumber');
            if (bookingNumberElement) {
                const trackingNum = data.trackingNumber || data.bookingNumber || data.id;
                if (trackingNum && trackingNum !== 'RC1234567890' && trackingNum !== 'null' && trackingNum !== 'undefined') {
                    bookingNumberElement.textContent = trackingNum;
                    console.log('Updated booking number to:', trackingNum);
                } else {
                    // Try to get from URL params as fallback
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlTracking = urlParams.get('trackingNumber') || urlParams.get('tracking');
                    if (urlTracking && urlTracking !== 'RC1234567890') {
                        bookingNumberElement.textContent = urlTracking;
                        console.log('Updated booking number from URL to:', urlTracking);
                    } else {
                        bookingNumberElement.textContent = 'RC1234567890';
                        console.warn('No valid tracking number found, using placeholder');
                    }
                }
            }
            
            // Update customer name - prioritize logged-in customer profile
            if (document.getElementById('customerName')) {
                if (customerProfile && customerProfile.firstName && customerProfile.lastName) {
                    document.getElementById('customerName').textContent = `${customerProfile.firstName} ${customerProfile.lastName}`;
                } else {
                    document.getElementById('customerName').textContent = data.customerName || (data.customerFirstName && data.customerLastName ? data.customerFirstName + ' ' + data.customerLastName : 'Guest User');
                }
            }
            
            // Update service type - handle enum objects and strings
            if (document.getElementById('serviceType')) {
                let serviceTypeText = data.serviceType;
                if (typeof serviceTypeText === 'object' && serviceTypeText !== null) {
                    if (serviceTypeText.displayName) {
                        serviceTypeText = serviceTypeText.displayName;
                    } else if (serviceTypeText.name) {
                        serviceTypeText = serviceTypeText.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    } else {
                        serviceTypeText = 'Express Delivery';
                    }
                } else if (!serviceTypeText || serviceTypeText === 'null' || serviceTypeText === 'undefined') {
                    serviceTypeText = 'Express Delivery';
                }
                document.getElementById('serviceType').textContent = serviceTypeText;
            }
            
            // Update total amount
            if (document.getElementById('totalAmount')) {
                const amount = data.totalAmount || data.amount || '250.00';
                document.getElementById('totalAmount').textContent = 'R' + parseFloat(amount).toFixed(2);
            }
            
            // Update addresses - construct full address from components
            let pickupAddr = '';
            if (data.pickupAddress) {
                const parts = [data.pickupAddress];
                if (data.pickupCity) parts.push(data.pickupCity);
                if (data.pickupState) parts.push(data.pickupState);
                if (data.pickupPostalCode) parts.push(data.pickupPostalCode);
                pickupAddr = parts.join(', ');
            } else if (data.pickupLocation) {
                pickupAddr = data.pickupLocation;
            }
            
            let deliveryAddr = '';
            if (data.deliveryAddress) {
                const parts = [data.deliveryAddress];
                if (data.deliveryCity) parts.push(data.deliveryCity);
                if (data.deliveryState) parts.push(data.deliveryState);
                if (data.deliveryPostalCode) parts.push(data.deliveryPostalCode);
                deliveryAddr = parts.join(', ');
            } else if (data.deliveryLocation) {
                deliveryAddr = data.deliveryLocation;
            }
            
            // Only use placeholder if no address data at all
            if (!pickupAddr && !deliveryAddr) {
                pickupAddr = pickupAddr || 'Address not available';
                deliveryAddr = deliveryAddr || 'Address not available';
            }
            
            if (document.getElementById('pickupAddress')) {
                document.getElementById('pickupAddress').textContent = pickupAddr || 'Address not available';
            }
            if (document.getElementById('deliveryAddress')) {
                document.getElementById('deliveryAddress').textContent = deliveryAddr || 'Address not available';
            }
            
            // Update codes - use actual codes if available, otherwise show placeholder
            if (document.getElementById('pickupCode')) {
                const pickupCode = data.pickupCode || data.collectionCode;
                document.getElementById('pickupCode').textContent = pickupCode || 'Will be assigned';
            }
            if (document.getElementById('deliveryCode')) {
                const deliveryCode = data.deliveryCode || data.dropOffCode;
                document.getElementById('deliveryCode').textContent = deliveryCode || 'Will be assigned';
            }
            
            // Update status
            if (document.getElementById('status')) {
                document.getElementById('status').textContent = data.status || 'Pending Pickup';
            }
            
            // Update Google Maps directions links
            const pickupDirectionsLink = document.getElementById('pickupDirections');
            const deliveryDirectionsLink = document.getElementById('deliveryDirections');
            if (pickupDirectionsLink && pickupAddr) {
                pickupDirectionsLink.href = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(pickupAddr)}`;
                pickupDirectionsLink.style.display = 'inline';
            } else if (pickupDirectionsLink) {
                pickupDirectionsLink.style.display = 'none';
            }
            if (deliveryDirectionsLink && deliveryAddr) {
                deliveryDirectionsLink.href = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(deliveryAddr)}`;
                deliveryDirectionsLink.style.display = 'inline';
            } else if (deliveryDirectionsLink) {
                deliveryDirectionsLink.style.display = 'none';
            }
            
            // Initialize Google Maps with coordinates (only if we have addresses)
            if (pickupAddr || deliveryAddr) {
                const pickupLat = data.pickupLatitude || data.pickupLat;
                const pickupLng = data.pickupLongitude || data.pickupLng;
                const deliveryLat = data.deliveryLatitude || data.deliveryLat;
                const deliveryLng = data.deliveryLongitude || data.deliveryLng;
                
                if (typeof google !== 'undefined' && google.maps) {
                    initializeMaps(pickupAddr, deliveryAddr, pickupLat, pickupLng, deliveryLat, deliveryLng);
                } else {
                    // Wait for Google Maps to load
                    window.initMapsCallback = function() {
                        initializeMaps(pickupAddr, deliveryAddr, pickupLat, pickupLng, deliveryLat, deliveryLng);
                    };
                }
            }
        }

        function initializeMaps(pickupAddr, deliveryAddr, pickupLat, pickupLng, deliveryLat, deliveryLng) {
            // Initialize pickup map
            const pickupMapElement = document.getElementById('pickupMap');
            if (pickupMapElement && !pickupMap) {
                const pickupCenter = pickupLat && pickupLng 
                    ? { lat: parseFloat(pickupLat), lng: parseFloat(pickupLng) }
                    : { lat: -26.2041, lng: 28.0473 }; // Default to Johannesburg
                
                pickupMap = new google.maps.Map(pickupMapElement, {
                    zoom: 15,
                    center: pickupCenter,
                    mapTypeControl: false,
                    streetViewControl: false
                });
                
                // Use Geocoder to get coordinates if not provided
                if (!pickupLat || !pickupLng) {
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ address: pickupAddr }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            pickupMap.setCenter(results[0].geometry.location);
                            pickupMarker = new google.maps.Marker({
                                map: pickupMap,
                                position: results[0].geometry.location,
                                title: 'Pickup Location',
                                icon: {
                                    url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                                }
                            });
                        }
                    });
                } else {
                    pickupMarker = new google.maps.Marker({
                        map: pickupMap,
                        position: pickupCenter,
                        title: 'Pickup Location',
                        icon: {
                            url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                        }
                    });
                }
            }
            
            // Initialize delivery map
            const deliveryMapElement = document.getElementById('deliveryMap');
            if (deliveryMapElement && !deliveryMap) {
                const deliveryCenter = deliveryLat && deliveryLng 
                    ? { lat: parseFloat(deliveryLat), lng: parseFloat(deliveryLng) }
                    : { lat: -25.7479, lng: 28.2293 }; // Default to Pretoria
                
                deliveryMap = new google.maps.Map(deliveryMapElement, {
                    zoom: 15,
                    center: deliveryCenter,
                    mapTypeControl: false,
                    streetViewControl: false
                });
                
                // Use Geocoder to get coordinates if not provided
                if (!deliveryLat || !deliveryLng) {
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ address: deliveryAddr }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            deliveryMap.setCenter(results[0].geometry.location);
                            deliveryMarker = new google.maps.Marker({
                                map: deliveryMap,
                                position: results[0].geometry.location,
                                title: 'Delivery Location',
                                icon: {
                                    url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                                }
                            });
                        }
                    });
                } else {
                    deliveryMarker = new google.maps.Marker({
                        map: deliveryMap,
                        position: deliveryCenter,
                        title: 'Delivery Location',
                        icon: {
                            url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                        }
                    });
                }
            }
        }

        // Action functions
        function trackPackage() {
            const bookingNumber = document.getElementById('bookingNumber').textContent;
            if (bookingNumber && bookingNumber !== 'RC1234567890') {
                // Check if user is logged in
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                if (token) {
                    window.location.href = `/customer/track/${bookingNumber}`;
                } else {
                    window.location.href = `/customer/track?trackingNumber=${bookingNumber}`;
                }
            } else {
                alert('Booking number not available');
            }
        }

        async function downloadReceipt() {
            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('bookingId');
            const reference = urlParams.get('reference');
            const bookingNumber = document.getElementById('bookingNumber').textContent;
            
            if (!bookingId && !reference) {
                alert('Booking information not available for receipt download');
                return;
            }
            
            try {
                // Try to get payment ID from booking
                let paymentId = null;
                
                if (bookingId) {
                    // Try to get payment from booking
                    const response = await fetch(`/api/payment/booking/${bookingId}`, {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        paymentId = data.id || data.paymentId;
                    }
                }
                
                // Use stored payment ID if available, otherwise use fetched one
                const finalPaymentId = currentPaymentId || paymentId;
                
                // If we have payment ID, download receipt
                if (finalPaymentId) {
                    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    if (token) {
                        headers['Authorization'] = 'Bearer ' + token;
                    }
                    
                    const receiptResponse = await fetch(`/api/customer/payments/${finalPaymentId}/receipt`, {
                        headers: headers,
                        credentials: 'include'
                    });
                    
                    if (receiptResponse.ok) {
                        const blob = await receiptResponse.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `receipt_${bookingNumber || finalPaymentId}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } else {
                        alert('Receipt not available yet. Please try again later.');
                    }
                } else {
                    alert('Payment information not found. Receipt will be available after payment is processed.');
                }
            } catch (error) {
                console.error('Error downloading receipt:', error);
                alert('Error downloading receipt. Please try again later.');
            }
        }

        function goHome() {
            // Check if user is logged in
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            if (token) {
                window.location.href = '/customer/dashboard';
            } else {
                window.location.href = '/';
            }
        }

        // Create confetti animation
        function createConfetti() {
            const confettiContainer = document.getElementById('confetti');
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.borderRadius = '50%';
                confetti.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
                
                confettiContainer.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }

        // Add CSS for confetti animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fall {
                to {
                    transform: translateY(100vh) rotate(360deg);
                }
            }
        `;
        document.head.appendChild(style);

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadBookingDetails();
            createConfetti();
        });
    </script>
</body>
</html>