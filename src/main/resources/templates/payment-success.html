<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Reliable Carriers</title>
    <link href="/css/tailwind-production.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
        }
        .receipt-container {
            max-width: 600px;
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="flex-shrink-0 flex items-center">
                        <img class="h-8 w-auto" src="/images/logo.png" alt="Reliable Carriers">
                        <span class="ml-2 text-xl font-bold text-gray-900">Reliable Carriers</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">Home</a>
                    <a href="/tracking" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">Track Package</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Success Content -->
    <div class="min-h-screen py-12 px-4 sm:px-6 lg:px-8">
        <div class="receipt-container">
            <!-- Success Header -->
            <div class="text-center mb-8">
                <!-- Success Icon -->
                <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-green-100 mb-6">
                    <i class="fas fa-check text-4xl text-green-600"></i>
                </div>
                
                <!-- Success Message -->
                <h1 class="text-4xl font-bold text-gray-900 mb-4">Payment Successful!</h1>
                <p class="text-lg text-gray-600 mb-8">
                    Your payment has been processed successfully. Your shipment is being prepared for dispatch.
                </p>
            </div>

            <!-- Digital Receipt -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-8" id="digitalReceipt">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Digital Receipt</h2>
                    <p class="text-gray-600">Reliable Carriers</p>
                    <p class="text-sm text-gray-500" id="receiptDate">Receipt Date: Loading...</p>
                </div>

                <!-- Payment Information -->
                <div class="border-b border-gray-200 pb-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment Information</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Reference Number:</p>
                            <p class="font-mono font-medium" id="paymentReference">Loading...</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Payment Date:</p>
                            <p class="font-medium" id="paymentDate">Loading...</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Amount Paid:</p>
                            <p class="font-bold text-xl text-green-600" id="paymentAmount">Loading...</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Payment Method:</p>
                            <p class="font-medium">Credit Card (Paystack)</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Status:</p>
                            <p class="font-medium text-green-600">âœ“ Completed</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Service Type:</p>
                            <p class="font-medium" id="serviceType">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Package Information -->
                <div class="border-b border-gray-200 pb-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Package Information</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Tracking Number:</p>
                            <p class="font-mono font-bold text-xl text-blue-600" id="trackingNumber">Loading...</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Package Status:</p>
                            <p class="font-medium text-orange-600">Preparing for Dispatch</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-sm text-gray-600">Estimated Delivery:</p>
                            <p class="font-medium" id="estimatedDelivery">Calculating...</p>
                        </div>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="border-b border-gray-200 pb-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Customer Information</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Customer Email:</p>
                            <p class="font-medium" id="customerEmail">Loading...</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Contact Phone:</p>
                            <p class="font-medium" id="customerPhone">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Shipping Details -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Shipping Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium text-gray-900 mb-2">Pickup Address</h4>
                            <div class="text-sm text-gray-600">
                                <p id="pickupAddress">Loading...</p>
                                <p id="pickupCity">Loading...</p>
                                <p id="pickupCountry">Loading...</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900 mb-2">Delivery Address</h4>
                            <div class="text-sm text-gray-600">
                                <p id="deliveryAddress">Loading...</p>
                                <p id="deliveryCity">Loading...</p>
                                <p id="deliveryCountry">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Receipt Footer -->
                <div class="text-center text-sm text-gray-500 border-t border-gray-200 pt-6">
                    <p>Thank you for choosing Reliable Carriers!</p>
                    <p>For support, contact us at support@reliablecarriers.com</p>
                    <p>This is your official receipt. Please save this page for your records.</p>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="space-y-4 no-print">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button onclick="trackPackage()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 transition duration-200">
                        <i class="fas fa-search mr-2"></i>
                        Track Package
                    </button>
                    <button onclick="printReceipt()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-green-700 transition duration-200">
                        <i class="fas fa-print mr-2"></i>
                        Print Receipt
                    </button>
                    <button onclick="goHome()" class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-gray-700 transition duration-200">
                        <i class="fas fa-home mr-2"></i>
                        Return Home
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <p class="text-gray-400">&copy; 2024 Reliable Carriers. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Global variables to store payment data
        let paymentData = {};
        
        // Get payment details from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const reference = urlParams.get('reference');
        const tracking = urlParams.get('tracking');
        const amount = urlParams.get('amount');
        const service = urlParams.get('service');
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const now = new Date();
            document.getElementById('receiptDate').textContent = `Receipt Date: ${now.toLocaleDateString()}`;
            document.getElementById('paymentDate').textContent = now.toLocaleDateString();
            
            // Set reference if available
            if (reference) {
                document.getElementById('paymentReference').textContent = reference;
                paymentData.reference = reference;
                // Fetch detailed payment information
                fetchPaymentDetails(reference);
            } else {
                document.getElementById('paymentReference').textContent = 'Not available';
            }
            
            // Set tracking number if available from URL
            if (tracking) {
                document.getElementById('trackingNumber').textContent = tracking;
                paymentData.trackingNumber = tracking;
            }
            
            // Set amount if available from URL
            if (amount) {
                document.getElementById('paymentAmount').textContent = `R${amount}`;
                paymentData.amount = amount;
            }
            
            // Set service type if available from URL
            if (service) {
                document.getElementById('serviceType').textContent = service;
                paymentData.serviceType = service;
            }
            
            // Calculate estimated delivery
            calculateEstimatedDelivery();
        });
        
        async function fetchPaymentDetails(reference) {
            try {
                const response = await fetch(`/api/paystack/verify?reference=${reference}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Update payment information
                    paymentData = { ...paymentData, ...data };
                    
                    // Update amount if not set from URL
                    if (!amount && data.amount) {
                        document.getElementById('paymentAmount').textContent = `R${data.amount}`;
                    }
                    
                    // Update tracking number if not set from URL
                    if (!tracking && data.trackingNumber) {
                        document.getElementById('trackingNumber').textContent = data.trackingNumber;
                    }
                    
                    // Update service type if not set from URL
                    if (!service && data.serviceType) {
                        document.getElementById('serviceType').textContent = data.serviceType;
                    }
                    
                    // Update customer information
                    if (data.customerEmail) {
                        document.getElementById('customerEmail').textContent = data.customerEmail;
                    }
                    
                    // Update shipping details if available
                    if (data.pickupAddress) {
                        document.getElementById('pickupAddress').textContent = data.pickupAddress;
                    }
                    if (data.pickupCity) {
                        document.getElementById('pickupCity').textContent = data.pickupCity;
                    }
                    if (data.pickupCountry) {
                        document.getElementById('pickupCountry').textContent = data.pickupCountry;
                    }
                    if (data.deliveryAddress) {
                        document.getElementById('deliveryAddress').textContent = data.deliveryAddress;
                    }
                    if (data.deliveryCity) {
                        document.getElementById('deliveryCity').textContent = data.deliveryCity;
                    }
                    if (data.deliveryCountry) {
                        document.getElementById('deliveryCountry').textContent = data.deliveryCountry;
                    }
                    
                } else {
                    console.warn('Payment verification failed:', data.message);
                    // Set default values
                    setDefaultValues();
                }
            } catch (error) {
                console.error('Error fetching payment details:', error);
                // Set default values
                setDefaultValues();
            }
        }
        
        function setDefaultValues() {
            // Set default customer information
            document.getElementById('customerEmail').textContent = 'customer@example.com';
            document.getElementById('customerPhone').textContent = 'Not provided';
            
            // Set default shipping details
            document.getElementById('pickupAddress').textContent = 'Pickup Address';
            document.getElementById('pickupCity').textContent = 'Pickup City';
            document.getElementById('pickupCountry').textContent = 'South Africa';
            document.getElementById('deliveryAddress').textContent = 'Delivery Address';
            document.getElementById('deliveryCity').textContent = 'Delivery City';
            document.getElementById('deliveryCountry').textContent = 'South Africa';
        }
        
        function calculateEstimatedDelivery() {
            const serviceType = paymentData.serviceType || document.getElementById('serviceType').textContent;
            const now = new Date();
            let deliveryDays = 3; // Default
            
            // Calculate based on service type
            switch (serviceType) {
                case 'OVERNIGHT':
                case 'EXPRESS':
                    deliveryDays = 1;
                    break;
                case 'SAME_DAY':
                    deliveryDays = 0;
                    break;
                case 'ECONOMY':
                case 'STANDARD':
                    deliveryDays = 3;
                    break;
                case 'INTERNATIONAL':
                    deliveryDays = 7;
                    break;
            }
            
            const deliveryDate = new Date(now.getTime() + (deliveryDays * 24 * 60 * 60 * 1000));
            const deliveryText = deliveryDays === 0 ? 'Same day delivery' : 
                               deliveryDays === 1 ? 'Next business day' : 
                               `${deliveryDays} business days`;
            
            document.getElementById('estimatedDelivery').textContent = `${deliveryText} (${deliveryDate.toLocaleDateString()})`;
        }
        
        function trackPackage() {
            const trackingNumber = paymentData.trackingNumber || document.getElementById('trackingNumber').textContent;
            if (trackingNumber && trackingNumber !== 'Loading...') {
                window.location.href = `/tracking/${trackingNumber}`;
            } else {
                window.location.href = '/tracking';
            }
        }
        
        function printReceipt() {
            window.print();
        }
        
        function goHome() {
            window.location.href = '/';
        }
        
        // Handle the payment data from your JSON
        function processPaymentData(data) {
            if (data.reference) paymentData.reference = data.reference;
            if (data.trackingNumber) paymentData.trackingNumber = data.trackingNumber;
            if (data.amount) paymentData.amount = data.amount;
            if (data.serviceType) paymentData.serviceType = data.serviceType;
            if (data.message) paymentData.message = data.message;
            if (data.paymentStatus) paymentData.paymentStatus = data.paymentStatus;
            
            // Update the page with the data
            updatePageWithPaymentData();
        }
        
        function updatePageWithPaymentData() {
            if (paymentData.reference) {
                document.getElementById('paymentReference').textContent = paymentData.reference;
            }
            if (paymentData.trackingNumber) {
                document.getElementById('trackingNumber').textContent = paymentData.trackingNumber;
            }
            if (paymentData.amount) {
                document.getElementById('paymentAmount').textContent = `R${paymentData.amount}`;
            }
            if (paymentData.serviceType) {
                document.getElementById('serviceType').textContent = paymentData.serviceType;
                calculateEstimatedDelivery();
            }
        }
        
        // Auto-process payment data if available in URL parameters
        if (reference && tracking && amount && service) {
            processPaymentData({
                "reference": reference,
                "serviceType": service,
                "amount": amount,
                "message": "Payment verification completed",
                "trackingNumber": tracking,
                "paymentStatus": "COMPLETED",
                "status": "success"
            });
        }
        
        // Example usage with your JSON data:
        // processPaymentData({
        //     "reference": "PAY_1636BDED-633",
        //     "serviceType": "OVERNIGHT",
        //     "amount": 150.00,
        //     "message": "Payment verification completed",
        //     "trackingNumber": "RC1760780229388924",
        //     "paymentStatus": "COMPLETED",
        //     "status": "success"
        // });
    </script>
</body>
</html>