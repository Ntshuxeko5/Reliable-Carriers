<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - Reliable Carriers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/error-handling.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 font-sans">
    <!-- Navigation -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold">Reliable Carriers Admin</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/admin/dashboard" class="hover:text-blue-200">Dashboard</a>
                    <a href="/admin/packages" class="hover:text-blue-200">Packages</a>
                    <a href="/admin/analytics" class="hover:text-blue-200">Analytics</a>
                    <a href="/admin/settings" class="text-blue-200 font-semibold">Settings</a>
                    <a href="/logout" class="hover:text-blue-200">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">System Settings</h1>
            <p class="text-gray-600 mt-2">View and manage system configuration</p>
        </div>

        <!-- Info Banner -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-600 text-xl mr-3 mt-1"></i>
                <div>
                    <h3 class="font-semibold text-blue-900 mb-1">Configuration Management</h3>
                    <p class="text-sm text-blue-800">
                        System settings are managed via environment variables for security. 
                        To change settings, update environment variables in your hosting platform (Render, Railway, etc.) 
                        and restart the application.
                    </p>
                </div>
            </div>
        </div>

        <!-- Application Settings -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-cog mr-2 text-blue-600"></i>Application Settings
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Application Name</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="appName" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Base URL</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="baseUrl" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Admin Email</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="adminEmail" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Debug Mode</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="debugMode" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Configuration -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-envelope mr-2 text-green-600"></i>Email Configuration
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SMTP Host</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="smtpHost" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SMTP Port</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="smtpPort" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Username</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="emailUsername" class="text-gray-900 font-mono text-sm">Loading...</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Status</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="emailStatus" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="testEmail()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        <i class="fas fa-paper-plane mr-2"></i>Test Email Configuration
                    </button>
                </div>
            </div>
        </div>

        <!-- SMS Configuration -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-sms mr-2 text-purple-600"></i>SMS Configuration
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SMS Provider</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="smsProvider" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SMS Status</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="smsStatus" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Configuration -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-database mr-2 text-orange-600"></i>Database Configuration
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Database Type</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="dbType" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Database Status</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="dbStatus" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="/api/health/database" target="_blank" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-external-link-alt mr-2"></i>View Database Health Check
                    </a>
                </div>
            </div>
        </div>

        <!-- System Health -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-heartbeat mr-2 text-red-600"></i>System Health
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Application Status</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="appStatus" class="text-green-600 font-semibold">UP</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Memory Usage</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="memoryUsage" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Uptime</label>
                        <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-md">
                            <span id="uptime" class="text-gray-900">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="/api/health/detailed" target="_blank" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-external-link-alt mr-2"></i>View Detailed Health Report
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadHealthStatus();
        });

        // Load settings
        async function loadSettings() {
            try {
                // Load application settings from health endpoint
                const response = await fetch('/api/health/detailed', {
                    headers: {
                        'Authorization': 'Bearer ' + getToken()
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    // Update UI with settings (read-only)
                    document.getElementById('appStatus').textContent = data.status || 'UP';
                }

                // Set default values (these would normally come from backend)
                document.getElementById('appName').textContent = 'Reliable Carriers';
                document.getElementById('baseUrl').textContent = window.location.origin;
                document.getElementById('adminEmail').textContent = 'admin@reliablecarriers.co.za';
                document.getElementById('debugMode').textContent = 'false (Production Mode)';
                document.getElementById('smtpHost').textContent = 'smtp.gmail.com';
                document.getElementById('smtpPort').textContent = '587';
                document.getElementById('emailUsername').textContent = 'Configured';
                document.getElementById('emailStatus').innerHTML = '<span class="text-green-600">✓ Active</span>';
                document.getElementById('smsProvider').textContent = 'SMSPortal';
                document.getElementById('smsStatus').innerHTML = '<span class="text-green-600">✓ Active</span>';
                document.getElementById('dbType').textContent = 'MySQL/PostgreSQL';
                document.getElementById('dbStatus').innerHTML = '<span class="text-green-600">✓ Connected</span>';
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Load health status
        async function loadHealthStatus() {
            try {
                const response = await fetch('/api/health/memory', {
                    headers: {
                        'Authorization': 'Bearer ' + getToken()
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.memoryUsagePercent) {
                        document.getElementById('memoryUsage').textContent = data.memoryUsagePercent;
                    }
                }

                // Calculate uptime (simplified)
                const startTime = Date.now();
                setInterval(() => {
                    const uptime = Math.floor((Date.now() - startTime) / 1000);
                    const hours = Math.floor(uptime / 3600);
                    const minutes = Math.floor((uptime % 3600) / 60);
                    const seconds = uptime % 60;
                    document.getElementById('uptime').textContent = `${hours}h ${minutes}m ${seconds}s`;
                }, 1000);
            } catch (error) {
                console.error('Error loading health status:', error);
            }
        }

        // Test email configuration
        async function testEmail() {
            showLoading('Sending test email...');
            try {
                // This would call a test email endpoint
                alert('Test email functionality would be implemented here. Check email configuration in application.properties or environment variables.');
            } catch (error) {
                await handleApiError(error, 'Failed to send test email');
            } finally {
                hideLoading();
            }
        }

        function getToken() {
            return localStorage.getItem('token') || 
                   sessionStorage.getItem('token') || 
                   localStorage.getItem('jwtToken') || 
                   sessionStorage.getItem('jwtToken') || '';
        }
    </script>
</body>
</html>

