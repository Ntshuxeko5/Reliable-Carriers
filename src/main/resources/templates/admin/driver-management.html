<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Management - Admin Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'reliable': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Maps API -->
    <script th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapsApiKey} + '&libraries=places&callback=initMap'" 
            async 
            defer
            onerror="console.error('Failed to load Google Maps API script'); document.getElementById('mapError')?.classList.remove('hidden');"></script>
    
    <!-- Admin Utilities -->
    <script src="/js/admin-utils.js"></script>
    <script src="/js/currency-utils.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-reliable-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-users-cog text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Driver Management</h1>
                        <p class="text-sm text-gray-600">Monitor drivers and assign packages</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button onclick="refreshData()" class="bg-reliable-600 hover:bg-reliable-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button onclick="window.location.href='/admin/dashboard'" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-white/20">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Drivers</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalDrivers">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-white/20">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-user-check text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Active Drivers</p>
                        <p class="text-2xl font-bold text-gray-900" id="activeDrivers">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-white/20">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-boxes text-yellow-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Available Packages</p>
                        <p class="text-2xl font-bold text-gray-900" id="availablePackages">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-white/20">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-truck text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">In Transit</p>
                        <p class="text-2xl font-bold text-gray-900" id="inTransitPackages">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Driver Locations Map -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg border border-white/20">
                    <div class="p-4 border-b border-gray-200">
                        <h2 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-map-marker-alt text-reliable-600 mr-2"></i> Driver Locations
                        </h2>
                    </div>
                    <div class="p-0 relative">
                        <div id="mapLoading" class="absolute inset-0 flex items-center justify-center bg-gray-100 rounded-b-2xl z-10">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-3xl text-reliable-600 mb-2"></i>
                                <p class="text-gray-600">Loading map...</p>
                            </div>
                        </div>
                        <div id="driverMap" class="h-96 rounded-b-2xl" style="width: 100%; height: 384px; min-height: 384px;"></div>
                        <div id="mapError" class="hidden text-center text-red-500 py-4">
                            <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                            <p>Map failed to load. Please check your Google Maps API key.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Driver List -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-lg border border-white/20">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-list text-reliable-600 mr-2"></i> Drivers
                        </h3>
                    </div>
                    <div class="p-4">
                        <div id="driverList" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-spinner fa-spin text-xl"></i>
                                <p class="mt-2">Loading drivers...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Package Assignment Section -->
        <div class="mt-6">
            <div class="bg-white rounded-2xl shadow-lg border border-white/20">
                <div class="p-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-tasks text-reliable-600 mr-2"></i> Package Assignment
                    </h3>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
                        <!-- Available Packages -->
                        <div>
                            <h4 class="text-md font-semibold text-gray-700 mb-3">Available Packages</h4>
                            <div id="availablePackagesList" class="space-y-2 max-h-64 overflow-y-auto">
                                <div class="text-center text-gray-500 py-4">
                                    <i class="fas fa-spinner fa-spin text-xl"></i>
                                    <p class="mt-2">Loading packages...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Assignment Controls -->
                        <div>
                            <h4 class="text-md font-semibold text-gray-700 mb-3">Assignment Controls</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Driver</label>
                                    <select id="driverSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-reliable-500">
                                        <option value="">Choose a driver...</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Selected Packages</label>
                                    <div id="selectedPackages" class="border border-gray-300 rounded-lg p-3 min-h-20 bg-gray-50">
                                        <p class="text-gray-500 text-sm">No packages selected</p>
                                    </div>
                                </div>
                                
                                <div class="flex space-x-3">
                                    <button onclick="assignSelectedPackages()" class="flex-1 bg-reliable-600 hover:bg-reliable-700 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                                        <i class="fas fa-check mr-2"></i>Assign Packages
                                    </button>
                                    <button onclick="clearSelection()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                                        <i class="fas fa-times mr-2"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let driverMarkers = {};
        let selectedPackages = new Set();
        let infoWindows = {};
        
        // Initialize Google Maps
        function initMap() {
            const mapElement = document.getElementById('driverMap');
            const errorElement = document.getElementById('mapError');
            const loadingElement = document.getElementById('mapLoading');
            
            if (!mapElement) {
                console.error('Map element not found');
                if (loadingElement) loadingElement.classList.add('hidden');
                if (errorElement) {
                    errorElement.classList.remove('hidden');
                }
                return;
            }
            
            // Check if Google Maps API is loaded
            if (typeof google === 'undefined' || !google.maps) {
                console.error('Google Maps API not loaded');
                // Try to initialize again after a delay
                setTimeout(() => {
                    if (typeof google !== 'undefined' && google.maps) {
                        initMap();
                    } else {
                        // Show error after timeout
                        if (loadingElement) loadingElement.classList.add('hidden');
                        if (errorElement) {
                            errorElement.classList.remove('hidden');
                            errorElement.innerHTML = `
                                <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                                <p>Google Maps API failed to load.</p>
                                <p class="text-sm mt-2">Please check your API key and network connection.</p>
                            `;
                        }
                    }
                }, 2000);
                return;
            }
            
            try {
                // Hide loading and error messages
                if (loadingElement) loadingElement.classList.add('hidden');
                if (errorElement) {
                    errorElement.classList.add('hidden');
                }
                
                map = new google.maps.Map(mapElement, {
                    zoom: 10,
                    center: { lat: -26.2041, lng: 28.0473 }, // Johannesburg
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    disableDefaultUI: false,
                    zoomControl: true,
                    mapTypeControl: true,
                    scaleControl: true,
                    streetViewControl: true,
                    rotateControl: true,
                    fullscreenControl: true
                });
                
                console.log('Map initialized successfully');
                
                // Load drivers once map is initialized
                // Note: Drivers are also loaded on DOMContentLoaded, so this is just for refresh
                if (map) {
                    // Small delay to ensure map is fully ready
                    setTimeout(() => {
                        loadDriverLocations();
                    }, 100);
                }
            } catch (error) {
                console.error('Error initializing map:', error);
                if (loadingElement) loadingElement.classList.add('hidden');
                if (errorElement) {
                    errorElement.classList.remove('hidden');
                    errorElement.innerHTML = `
                        <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                        <p>Map failed to load: ${error.message}</p>
                        <p class="text-sm mt-2">Please check your Google Maps API key and console for details.</p>
                    `;
                }
            }
        }
        
        // Make initMap available globally for Google Maps callback
        window.initMap = initMap;
        
        // Fallback: Try to initialize map if callback doesn't fire
        function initializeMapFallback() {
            if (typeof google !== 'undefined' && google.maps && !map) {
                console.log('Initializing map via fallback method');
                initMap();
            }
        }
        
        // Load driver locations
        async function loadDriverLocations() {
            const container = document.getElementById('driverList');
            
            try {
                console.log('Loading driver locations...');
                const token = getToken();
                console.log('Token available:', token ? 'Yes' : 'No');
                
                const headers = {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                };
                
                // Add Authorization header if token is available
                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                    console.log('Added Authorization header');
                } else {
                    console.warn('No token found, using cookie-based authentication');
                }
                
                const apiUrl = '/api/admin/drivers/tracking/all';
                console.log('Fetching from:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: headers,
                    credentials: 'include' // Include cookies for authentication
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Driver locations response:', result);
                
                // Handle different response formats
                let drivers = [];
                if (result.success && result.data) {
                    drivers = result.data;
                } else if (Array.isArray(result)) {
                    drivers = result;
                } else if (result.data && Array.isArray(result.data)) {
                    drivers = result.data;
                } else if (result.drivers && Array.isArray(result.drivers)) {
                    drivers = result.drivers;
                }
                
                console.log(`Loaded ${drivers.length} drivers`);
                
                // Always update the driver list, even if empty
                updateDriverList(drivers);
                updateStatistics(drivers);
                
                // Only update map if it's initialized
                try {
                    updateDriverMap(drivers);
                } catch (mapError) {
                    console.warn('Error updating driver map:', mapError);
                    // Continue even if map update fails
                }
                
                // Show error if result indicates an error
                if (result.error || (result.message && !result.success)) {
                    throw new Error(result.error || result.message || 'Failed to load drivers');
                }
                
            } catch (error) {
                console.error('Error loading driver locations:', error);
                if (container) {
                    let errorMessage = 'Error loading drivers';
                    let errorDetails = 'Please try refreshing the page';
                    
                    if (error.message) {
                        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                            errorMessage = 'Network Error';
                            errorDetails = 'Unable to connect to the server. Please check your internet connection and try again.';
                        } else if (error.message.includes('HTTP error')) {
                            errorMessage = 'Server Error';
                            errorDetails = error.message;
                        } else {
                            errorDetails = error.message;
                        }
                    }
                    
                    container.innerHTML = `
                        <div class="text-center text-red-500 py-4">
                            <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                            <p class="font-semibold">${errorMessage}</p>
                            <p class="text-sm mt-2">${errorDetails}</p>
                            <button onclick="loadDriverLocations()" class="mt-3 bg-reliable-600 hover:bg-reliable-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 text-sm">
                                <i class="fas fa-redo mr-2"></i>Retry
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // Update driver list
        function updateDriverList(drivers) {
            const container = document.getElementById('driverList');
            
            if (!container) {
                console.error('Driver list container not found');
                return;
            }
            
            // Update driver select dropdown (always, even if empty)
            const driverSelect = document.getElementById('driverSelect');
            if (driverSelect) {
                driverSelect.innerHTML = '<option value="">Choose a driver...</option>' + 
                    (drivers && drivers.length > 0 ? drivers.map(driver => {
                        const driverName = `${driver.firstName || ''} ${driver.lastName || ''}`.trim();
                        return `<option value="${driver.driverId}">${driverName} (${driver.activeBookingsCount || 0} active)</option>`;
                    }).join('') : '');
            }
            
            if (!drivers || drivers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-users text-2xl mb-2"></i>
                        <p>No drivers found</p>
                    </div>
                `;
                return;
            }
            
            const getStatusColor = (status, isOnline) => {
                if (!isOnline) return 'bg-gray-100 text-gray-800';
                switch(status) {
                    case 'ONLINE': return 'bg-green-100 text-green-800';
                    case 'EN_ROUTE': return 'bg-blue-100 text-blue-800';
                    case 'ON_DELIVERY': return 'bg-yellow-100 text-yellow-800';
                    case 'ASSIGNED': return 'bg-purple-100 text-purple-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
            
            const getStatusIcon = (status) => {
                switch(status) {
                    case 'ONLINE': return 'fa-circle';
                    case 'EN_ROUTE': return 'fa-route';
                    case 'ON_DELIVERY': return 'fa-truck';
                    case 'ASSIGNED': return 'fa-clipboard-list';
                    default: return 'fa-circle';
                }
            };
            
            container.innerHTML = drivers.map(driver => {
                const driverName = `${driver.firstName || ''} ${driver.lastName || ''}`.trim();
                const status = driver.status || (driver.isOnline ? 'ONLINE' : 'OFFLINE');
                const isOnline = driver.isOnline && driver.latitude && driver.longitude;
                
                return `
                <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition-colors duration-200 border-l-4 ${
                    isOnline ? 'border-green-500' : 'border-gray-300'
                }" 
                     onclick="selectDriver(${driver.driverId})">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 text-sm">${driverName}</h4>
                            <p class="text-xs text-gray-600">${driver.phone || 'N/A'}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-box mr-1"></i>${driver.activeBookingsCount || 0} active deliveries
                            </p>
                            ${driver.vehicleMake ? `<p class="text-xs text-gray-500"><i class="fas fa-car mr-1"></i>${driver.vehicleMake} ${driver.vehicleModel || ''}</p>` : ''}
                        </div>
                        <div class="text-right ml-2">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(status, isOnline)}">
                                <i class="fas ${getStatusIcon(status)} mr-1"></i>
                                ${status.replace('_', ' ')}
                            </span>
                            ${driver.lastLocationUpdate ? `
                                <p class="text-xs text-gray-500 mt-1">
                                    ${formatTimeAgo(new Date(driver.lastLocationUpdate))}
                                </p>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }
        
        // Update driver map
        function updateDriverMap(drivers) {
            // Check if map is initialized
            if (!map) {
                console.warn('Map not initialized yet, skipping map update');
                return;
            }
            
            // Clear existing markers
            Object.values(driverMarkers).forEach(marker => marker.setMap(null));
            Object.values(infoWindows).forEach(infoWindow => infoWindow.close());
            driverMarkers = {};
            infoWindows = {};
            
            const bounds = new google.maps.LatLngBounds();
            let hasMarkers = false;
            
            drivers.forEach(driver => {
                // Only show online drivers with locations
                if (driver.isOnline && driver.latitude && driver.longitude) {
                    const driverName = `${driver.firstName || ''} ${driver.lastName || ''}`.trim();
                    const status = driver.status || 'ONLINE';
                    
                    // Color based on status
                    let markerColor = '#3b82f6'; // default blue
                    switch(status) {
                        case 'ONLINE': markerColor = '#10b981'; break; // green
                        case 'EN_ROUTE': markerColor = '#3b82f6'; break; // blue
                        case 'ON_DELIVERY': markerColor = '#f59e0b'; break; // yellow
                        case 'ASSIGNED': markerColor = '#8b5cf6'; break; // purple
                        default: markerColor = '#6b7280'; // gray
                    }
                    
                    // Handle BigDecimal or number types
                    const lat = typeof driver.latitude === 'object' && driver.latitude !== null 
                        ? parseFloat(driver.latitude) : parseFloat(driver.latitude || 0);
                    const lng = typeof driver.longitude === 'object' && driver.longitude !== null 
                        ? parseFloat(driver.longitude) : parseFloat(driver.longitude || 0);
                    
                    const position = { lat: lat, lng: lng };
                    
                    // Create custom marker icon
                    const icon = {
                        url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                            <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="15" cy="15" r="12" fill="${markerColor}" stroke="white" stroke-width="3"/>
                                <text x="15" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">ðŸšš</text>
                            </svg>
                        `)}`,
                        scaledSize: new google.maps.Size(30, 30),
                        anchor: new google.maps.Point(15, 15)
                    };
                    
                    const marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: driverName,
                        icon: icon
                    });
                    
                    // Build info window content
                    let infoContent = `
                        <div class="p-3" style="min-width: 200px;">
                            <h3 class="font-bold text-gray-900 mb-2">${driverName}</h3>
                            <div class="space-y-1 text-sm">
                                <p class="text-gray-600"><i class="fas fa-phone mr-2"></i>${driver.phone || 'N/A'}</p>
                                <p class="text-gray-600"><i class="fas fa-box mr-2"></i>${driver.activeBookingsCount || 0} active deliveries</p>
                                ${driver.vehicleMake ? `<p class="text-gray-600"><i class="fas fa-car mr-2"></i>${driver.vehicleMake} ${driver.vehicleModel || ''}</p>` : ''}
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${driver.lastLocationUpdate ? formatTimeAgo(new Date(driver.lastLocationUpdate)) : 'No recent update'}
                                </p>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusColorClass(status)} mt-2">
                                    ${status.replace('_', ' ')}
                                </span>
                            </div>
                        </div>
                    `;
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: infoContent
                    });
                    
                    marker.addListener('click', () => {
                        // Close all other info windows
                        Object.values(infoWindows).forEach(iw => iw.close());
                        infoWindow.open(map, marker);
                        selectDriver(driver.driverId);
                    });
                    
                    driverMarkers[driver.driverId] = marker;
                    infoWindows[driver.driverId] = infoWindow;
                    bounds.extend(position);
                    hasMarkers = true;
                }
            });
            
            // Fit map to show all markers if any exist
            if (hasMarkers) {
                map.fitBounds(bounds);
            }
        }
        
        function getStatusColorClass(status) {
            switch(status) {
                case 'ONLINE': return 'bg-green-100 text-green-800';
                case 'EN_ROUTE': return 'bg-blue-100 text-blue-800';
                case 'ON_DELIVERY': return 'bg-yellow-100 text-yellow-800';
                case 'ASSIGNED': return 'bg-purple-100 text-purple-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Update statistics
        function updateStatistics(drivers) {
            document.getElementById('totalDrivers').textContent = drivers.length;
            const onlineDrivers = drivers.filter(d => d.isOnline && d.latitude && d.longitude);
            document.getElementById('activeDrivers').textContent = onlineDrivers.length;
            
            // Count drivers by status
            const enRouteCount = drivers.filter(d => d.status === 'EN_ROUTE').length;
            const onDeliveryCount = drivers.filter(d => d.status === 'ON_DELIVERY').length;
            
            // Update in-transit count
            document.getElementById('inTransitPackages').textContent = enRouteCount + onDeliveryCount;
        }
        
        // Auto-refresh driver locations every 10 seconds
        let refreshInterval;
        
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                loadDriverLocations();
            }, 10000); // Refresh every 10 seconds
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }
        
        function refreshData() {
            loadDriverLocations();
            loadAvailablePackages();
        }
        
        // Load available packages
        async function loadAvailablePackages() {
            const container = document.getElementById('availablePackagesList');
            
            try {
                console.log('Loading available packages...');
                const token = getToken();
                const headers = {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                };
                
                // Add Authorization header if token is available
                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }
                
                const apiUrl = '/api/admin/drivers/available-packages';
                console.log('Fetching packages from:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: headers,
                    credentials: 'include' // Include cookies for authentication
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                
                const packages = await response.json();
                console.log('Available packages response:', packages);
                
                // Handle both array and wrapped response
                let packageList = [];
                if (Array.isArray(packages)) {
                    packageList = packages;
                } else if (packages.data && Array.isArray(packages.data)) {
                    packageList = packages.data;
                } else if (packages.packages && Array.isArray(packages.packages)) {
                    packageList = packages.packages;
                } else if (packages.success && packages.data && Array.isArray(packages.data)) {
                    packageList = packages.data;
                }
                
                console.log(`Loaded ${packageList.length} available packages`);
                
                updateAvailablePackagesList(packageList);
                if (document.getElementById('availablePackages')) {
                    document.getElementById('availablePackages').textContent = packageList.length;
                }
                
                // Show error if result indicates an error
                if (packages.error || (packages.message && !packages.success)) {
                    throw new Error(packages.error || packages.message || 'Failed to load packages');
                }
                
            } catch (error) {
                console.error('Error loading available packages:', error);
                if (container) {
                    let errorMessage = 'Error loading packages';
                    let errorDetails = 'Please try refreshing the page';
                    
                    if (error.message) {
                        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                            errorMessage = 'Network Error';
                            errorDetails = 'Unable to connect to the server. Please check your internet connection and try again.';
                        } else if (error.message.includes('HTTP error')) {
                            errorMessage = 'Server Error';
                            errorDetails = error.message;
                        } else {
                            errorDetails = error.message;
                        }
                    }
                    
                    container.innerHTML = `
                        <div class="text-center text-red-500 py-4">
                            <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                            <p class="font-semibold">${errorMessage}</p>
                            <p class="text-sm mt-2">${errorDetails}</p>
                            <button onclick="loadAvailablePackages()" class="mt-3 bg-reliable-600 hover:bg-reliable-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 text-sm">
                                <i class="fas fa-redo mr-2"></i>Retry
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // Update available packages list
        function updateAvailablePackagesList(packages) {
            const container = document.getElementById('availablePackagesList');
            
            if (!container) {
                console.error('Available packages list container not found');
                return;
            }
            
            if (!packages || packages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-box-open text-2xl mb-2"></i>
                        <p>No available packages</p>
                    </div>
                `;
                return;
            }
            
            // Helper function to escape HTML and prevent XSS
            const escapeHtml = (text) => {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            container.innerHTML = packages.map(pkg => {
                const trackingNumber = escapeHtml(pkg.trackingNumber || 'N/A');
                const recipientName = escapeHtml(pkg.recipientName || 'N/A');
                const deliveryCity = escapeHtml(pkg.deliveryCity || '');
                const deliveryState = escapeHtml(pkg.deliveryState || '');
                const packageId = pkg.id || pkg.packageId || 0;
                const isSelected = selectedPackages.has(packageId);
                
                return `
                <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition-colors duration-200" 
                     onclick="togglePackageSelection(${packageId}, '${trackingNumber.replace(/'/g, "\\'")}')">
                    <div class="flex items-center">
                        <input type="checkbox" id="pkg-${packageId}" class="mr-3" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation();">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 text-sm">${trackingNumber}</h4>
                            <p class="text-xs text-gray-600">${recipientName}</p>
                            ${deliveryCity || deliveryState ? `<p class="text-xs text-gray-500">${deliveryCity}${deliveryCity && deliveryState ? ', ' : ''}${deliveryState}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        // Toggle package selection
        function togglePackageSelection(packageId, trackingNumber) {
            if (selectedPackages.has(packageId)) {
                selectedPackages.delete(packageId);
            } else {
                selectedPackages.add(packageId);
            }
            
            updateSelectedPackagesDisplay();
        }
        
        // Update selected packages display
        function updateSelectedPackagesDisplay() {
            const container = document.getElementById('selectedPackages');
            
            if (selectedPackages.size === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No packages selected</p>';
                return;
            }
            
            container.innerHTML = Array.from(selectedPackages).map(id => 
                `<span class="inline-block bg-reliable-100 text-reliable-800 text-xs px-2 py-1 rounded mr-2 mb-2">${id}</span>`
            ).join('');
        }
        
        // Select driver
        function selectDriver(driverId) {
            // Focus map on selected driver
            if (driverMarkers[driverId]) {
                const marker = driverMarkers[driverId];
                map.setCenter(marker.getPosition());
                map.setZoom(15);
                
                // Close all info windows first
                Object.values(infoWindows).forEach(iw => iw.close());
                
                // Open info window for selected driver
                if (infoWindows[driverId]) {
                    infoWindows[driverId].open(map, marker);
                }
            }
            
            // Also update dropdown
            document.getElementById('driverSelect').value = driverId;
        }
        
        // Assign selected packages
        async function assignSelectedPackages() {
            const driverId = document.getElementById('driverSelect').value;
            
            if (!driverId) {
                alert('Please select a driver');
                return;
            }
            
            if (selectedPackages.size === 0) {
                alert('Please select packages to assign');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/drivers/bulk-assign-packages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify({
                        driverId: parseInt(driverId),
                        packageIds: Array.from(selectedPackages).map(id => parseInt(id))
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    alert('Error: ' + response.status + ' - ' + errorText);
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Packages assigned successfully!');
                    clearSelection();
                    loadDriverLocations();
                    loadAvailablePackages();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error assigning packages:', error);
                alert('Error assigning packages');
            }
        }
        
        // Clear selection
        function clearSelection() {
            selectedPackages.clear();
            updateSelectedPackagesDisplay();
            document.getElementById('driverSelect').value = '';
            
            // Uncheck all checkboxes
            document.querySelectorAll('#availablePackagesList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }
        
        // Refresh data
        function refreshData() {
            loadDriverLocations();
            loadAvailablePackages();
        }
        
        // Initialize on page load
        // Note: initMap is called by Google Maps API callback
        // If map is not initialized, wait for it
        function checkMapInitialized() {
            // Try fallback initialization if map isn't initialized yet
            if (typeof google !== 'undefined' && google.maps && !map) {
                initializeMapFallback();
            }
            
            // Load drivers immediately, don't wait for map
            loadDriverLocations();
            loadAvailablePackages();
            
            if (typeof google !== 'undefined' && google.maps && map) {
                startAutoRefresh();
            } else if (typeof google !== 'undefined' && google.maps) {
                // Google Maps is loaded but map not initialized yet, try again
                setTimeout(checkMapInitialized, 500);
            } else {
                // Google Maps not loaded yet, wait a bit longer
                setTimeout(checkMapInitialized, 1000);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Load drivers immediately
            loadDriverLocations();
            loadAvailablePackages();
            
            // Check for map initialization with fallback
            // Wait a bit for Google Maps API to load
            setTimeout(() => {
                checkMapInitialized();
            }, 500);
            
            // Also set up a periodic check in case callback fails
            let mapInitAttempts = 0;
            const maxAttempts = 10;
            const mapInitInterval = setInterval(() => {
                mapInitAttempts++;
                if (map) {
                    clearInterval(mapInitInterval);
                } else if (typeof google !== 'undefined' && google.maps) {
                    initializeMapFallback();
                    if (map) {
                        clearInterval(mapInitInterval);
                    }
                } else if (mapInitAttempts >= maxAttempts) {
                    clearInterval(mapInitInterval);
                    console.error('Failed to initialize map after multiple attempts');
                }
            }, 1000);
            
            window.addEventListener('beforeunload', stopAutoRefresh);
        });

        function getToken() {
            return (
                localStorage.getItem('token') ||
                sessionStorage.getItem('token') ||
                localStorage.getItem('jwtToken') ||
                sessionStorage.getItem('jwtToken')
            );
        }
    </script>
</body>
</html>
