<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Driver Management</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'reliable': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-map-marker-alt text-reliable-500 mr-2"></i>
                        Tracking Manager
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/tracking-manager/dashboard" class="text-gray-600 hover:text-gray-800 font-medium">
                        <i class="fas fa-tachometer-alt mr-1"></i> Dashboard
                    </a>
                    <a href="/tracking-manager/packages" class="text-gray-600 hover:text-gray-800 font-medium">
                        <i class="fas fa-box mr-1"></i> Packages
                    </a>
                    <a href="/tracking-manager/drivers" class="text-reliable-600 hover:text-reliable-800 font-medium">
                        <i class="fas fa-users mr-1"></i> Drivers
                    </a>
                    <a href="/tracking-manager/live-tracking" class="text-gray-600 hover:text-gray-800 font-medium">
                        <i class="fas fa-map mr-1"></i> Live Tracking
                    </a>
                    <a href="/tracking-manager/analytics" class="text-gray-600 hover:text-gray-800 font-medium">
                        <i class="fas fa-chart-bar mr-1"></i> Analytics
                    </a>
                    <a href="/logout" class="text-red-600 hover:text-red-800 font-medium">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Driver Management</h2>
            <p class="text-gray-600 mt-2">Monitor driver performance and manage assignments</p>
        </div>

        <!-- Driver Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Drivers</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalDrivers">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-circle text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Online Drivers</p>
                        <p class="text-2xl font-bold text-gray-900" id="onlineDrivers">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <i class="fas fa-circle text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Offline Drivers</p>
                        <p class="text-2xl font-bold text-gray-900" id="offlineDrivers">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        <i class="fas fa-box text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Avg Packages/Driver</p>
                        <p class="text-2xl font-bold text-gray-900" id="avgPackagesPerDriver">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Driver Performance Chart -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Driver Performance Overview</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <canvas id="performanceChart" width="400" height="200"></canvas>
                </div>
                <div id="performanceStats">
                    <!-- Performance stats will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Drivers Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">All Drivers</h3>
                    <button onclick="refreshDrivers()" class="text-reliable-600 hover:text-reliable-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Driver
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Vehicle
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Assigned Packages
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Delivery Rate
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Last Activity
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="driversTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Drivers will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Driver Details Modal -->
    <div id="driverModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Driver Details</h3>
                        <button onclick="closeDriverModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div id="driverModalContent" class="p-6">
                    <!-- Driver details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Packages Modal -->
    <div id="assignModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Assign Packages to Driver</h3>
                </div>
                <div class="p-6">
                    <form id="assignForm">
                        <input type="hidden" id="assignDriverId">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Packages</label>
                            <div id="availablePackages" class="max-h-64 overflow-y-auto border border-gray-300 rounded-md p-3">
                                <!-- Available packages will be loaded here -->
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="closeAssignModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 bg-reliable-600 text-white rounded-md hover:bg-reliable-700">
                                Assign Packages
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let drivers = [];
        let allPackages = [];

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadDrivers();
            loadDriverStatistics();
            loadPackages();
        });

        // Load drivers
        async function loadDrivers() {
            try {
                const response = await fetch('/tracking-manager/api/drivers');
                drivers = await response.json();
                updateDriversTable();
            } catch (error) {
                console.error('Error loading drivers:', error);
            }
        }

        // Load driver statistics
        async function loadDriverStatistics() {
            try {
                const response = await fetch('/tracking-manager/api/driver-statistics');
                const stats = await response.json();
                
                document.getElementById('totalDrivers').textContent = stats.totalDrivers || 0;
                document.getElementById('onlineDrivers').textContent = stats.onlineDrivers || 0;
                document.getElementById('offlineDrivers').textContent = stats.offlineDrivers || 0;
                document.getElementById('avgPackagesPerDriver').textContent = Math.round(stats.averagePackagesPerDriver || 0);
                
                updatePerformanceChart(stats.driverPerformance || {});
            } catch (error) {
                console.error('Error loading driver statistics:', error);
            }
        }

        // Load packages for assignment
        async function loadPackages() {
            try {
                const response = await fetch('/tracking-manager/api/packages?size=100');
                const data = await response.json();
                allPackages = data.packages || [];
            } catch (error) {
                console.error('Error loading packages:', error);
            }
        }

        // Update drivers table
        function updateDriversTable() {
            const tbody = document.getElementById('driversTableBody');
            tbody.innerHTML = '';
            
            drivers.forEach(driver => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusColor = driver.isOnline ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const vehicleInfo = driver.vehicle ? `${driver.vehicle.make} ${driver.vehicle.model} (${driver.vehicle.plate})` : 'No vehicle assigned';
                const deliveryRate = calculateDeliveryRate(driver);
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                    <i class="fas fa-user text-gray-600"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${driver.name}</div>
                                <div class="text-sm text-gray-500">${driver.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                            <i class="fas fa-circle mr-1 ${driver.isOnline ? 'text-green-400' : 'text-red-400'}"></i>
                            ${driver.isOnline ? 'Online' : 'Offline'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${vehicleInfo}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="flex space-x-2">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                Total: ${driver.assignedPackages || 0}
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                Pending: ${driver.pendingPackages || 0}
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                In Transit: ${driver.inTransitPackages || 0}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="flex items-center">
                            <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: ${deliveryRate}%"></div>
                            </div>
                            <span class="text-sm font-medium">${deliveryRate}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${driver.lastActivity || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewDriverDetails(${driver.id})" class="text-reliable-600 hover:text-reliable-900 mr-3">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="assignPackagesToDriver(${driver.id})" class="text-yellow-600 hover:text-yellow-900 mr-3">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button onclick="viewDriverLocation(${driver.id})" class="text-green-600 hover:text-green-900">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Calculate delivery rate
        function calculateDeliveryRate(driver) {
            const total = driver.assignedPackages || 0;
            const delivered = driver.deliveredPackages || 0;
            return total > 0 ? Math.round((delivered / total) * 100) : 0;
        }

        // Update performance chart
        function updatePerformanceChart(performanceData) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            const driverNames = Object.keys(performanceData).map(key => performanceData[key].name);
            const deliveryRates = Object.keys(performanceData).map(key => performanceData[key].deliveryRate);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: driverNames,
                    datasets: [{
                        label: 'Delivery Rate (%)',
                        data: deliveryRates,
                        backgroundColor: 'rgba(14, 165, 233, 0.5)',
                        borderColor: 'rgba(14, 165, 233, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // View driver details
        async function viewDriverDetails(driverId) {
            try {
                const driver = drivers.find(d => d.id === driverId);
                if (!driver) return;
                
                const modalContent = document.getElementById('driverModalContent');
                modalContent.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Driver Information</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Name</label>
                                        <p class="text-sm text-gray-900">${driver.name}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Email</label>
                                        <p class="text-sm text-gray-900">${driver.email}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Phone</label>
                                        <p class="text-sm text-gray-900">${driver.phone || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Status</label>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${driver.isOnline ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${driver.isOnline ? 'Online' : 'Offline'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Vehicle Information</h4>
                                ${driver.vehicle ? `
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Make & Model</label>
                                            <p class="text-sm text-gray-900">${driver.vehicle.make} ${driver.vehicle.model}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">License Plate</label>
                                            <p class="text-sm text-gray-900">${driver.vehicle.plate}</p>
                                        </div>
                                    </div>
                                ` : '<p class="text-sm text-gray-500">No vehicle assigned</p>'}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Performance Statistics</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center p-4 bg-blue-50 rounded-lg">
                                    <p class="text-2xl font-bold text-blue-600">${driver.assignedPackages || 0}</p>
                                    <p class="text-sm text-gray-600">Total Packages</p>
                                </div>
                                <div class="text-center p-4 bg-green-50 rounded-lg">
                                    <p class="text-2xl font-bold text-green-600">${driver.deliveredPackages || 0}</p>
                                    <p class="text-sm text-gray-600">Delivered</p>
                                </div>
                                <div class="text-center p-4 bg-purple-50 rounded-lg">
                                    <p class="text-2xl font-bold text-purple-600">${calculateDeliveryRate(driver)}%</p>
                                    <p class="text-sm text-gray-600">Delivery Rate</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('driverModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading driver details:', error);
            }
        }

        // Assign packages to driver
        function assignPackagesToDriver(driverId) {
            document.getElementById('assignDriverId').value = driverId;
            
            // Load available packages (unassigned or pending)
            const availablePackages = allPackages.filter(pkg => 
                !pkg.assignedDriver || pkg.status === 'PENDING'
            );
            
            const container = document.getElementById('availablePackages');
            container.innerHTML = '';
            
            availablePackages.forEach(pkg => {
                const packageDiv = document.createElement('div');
                packageDiv.className = 'flex items-center space-x-3 p-2 hover:bg-gray-50 rounded';
                packageDiv.innerHTML = `
                    <input type="checkbox" class="package-checkbox" value="${pkg.id}">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${pkg.trackingNumber}</p>
                        <p class="text-sm text-gray-500">${pkg.recipientName || 'N/A'} - ${pkg.status}</p>
                    </div>
                `;
                container.appendChild(packageDiv);
            });
            
            document.getElementById('assignModal').classList.remove('hidden');
        }

        // View driver location
        function viewDriverLocation(driverId) {
            // Redirect to live tracking with driver filter
            window.location.href = `/tracking-manager/live-tracking?driverId=${driverId}`;
        }

        // Close driver modal
        function closeDriverModal() {
            document.getElementById('driverModal').classList.add('hidden');
        }

        // Close assign modal
        function closeAssignModal() {
            document.getElementById('assignModal').classList.add('hidden');
        }

        // Refresh drivers
        function refreshDrivers() {
            loadDrivers();
            loadDriverStatistics();
        }

        // Handle assign form submission
        document.getElementById('assignForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const driverId = document.getElementById('assignDriverId').value;
            const selectedPackages = Array.from(document.querySelectorAll('.package-checkbox:checked'))
                .map(checkbox => parseInt(checkbox.value));
            
            if (selectedPackages.length === 0) {
                alert('Please select at least one package');
                return;
            }
            
            try {
                // Assign each package to the driver
                for (const packageId of selectedPackages) {
                    await fetch(`/tracking-manager/api/packages/${packageId}/assign-driver`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ driverId: parseInt(driverId) })
                    });
                }
                
                closeAssignModal();
                loadDrivers();
                loadPackages();
                alert('Packages assigned successfully');
            } catch (error) {
                console.error('Error assigning packages:', error);
                alert('Error assigning packages');
            }
        });
    </script>
</body>
</html>
