<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver Dashboard - Reliable Carriers</title>
    
    <!-- Tailwind CSS -->
    <link href="/css/tailwind-production.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Currency Utils -->
    <script src="/js/currency-utils.js"></script>
    
    <!-- Google Maps API -->
    <script th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapsApiKey} + '&libraries=places&callback=initMap'" async defer></script>
    
    <style>
        body { margin: 0; padding: 0; overflow-x: hidden; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .status-online { background: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
        .status-offline { background: #6b7280; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .pulse-online { animation: pulse 2s infinite; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20">
    
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg sticky top-0 z-50">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                        <i class="fas fa-truck text-blue-600 text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">Reliable Carriers</h1>
                        <p class="text-xs text-blue-100" id="driverName">Driver</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="text-right">
                        <div class="text-xs text-blue-100">Status</div>
                        <div class="flex items-center space-x-2">
                            <span class="status-indicator status-offline" id="statusDot"></span>
                            <span class="text-sm font-medium" id="statusText">Offline</span>
                        </div>
                    </div>
                    <button id="toggleStatusBtn" onclick="toggleStatus()" 
                            class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium text-sm">
                        Go Online
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Quick Stats -->
    <div class="px-4 py-3 bg-white shadow-sm">
        <div class="grid grid-cols-3 gap-3">
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600" id="todayEarnings">R0</div>
                <div class="text-xs text-gray-600">Today</div>
            </div>
            <div class="text-center border-x border-gray-200">
                <div class="text-2xl font-bold text-green-600" id="totalDeliveries">0</div>
                <div class="text-xs text-gray-600">Deliveries</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600" id="rating">0.0</div>
                <div class="text-xs text-gray-600">Rating</div>
            </div>
        </div>
    </div>

    <!-- Available Requests -->
    <div id="requestsSection" class="px-4 py-3" style="display: none;">
        <h2 class="font-bold text-gray-800 mb-3">
            <i class="fas fa-bell text-yellow-500 mr-2"></i>New Delivery Requests
        </h2>
        <div id="requestsList" class="space-y-3"></div>
    </div>

    <!-- Active Deliveries -->
    <div class="px-4 py-3">
        <h2 class="font-bold text-gray-800 mb-3">
            <i class="fas fa-clipboard-list text-blue-600 mr-2"></i>Active Deliveries
        </h2>
        <div id="deliveriesList" class="space-y-3">
            <div class="bg-gray-100 rounded-lg p-4 text-center text-gray-500">
                <i class="fas fa-inbox text-3xl mb-2"></i>
                <p>No active deliveries</p>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
        <div class="grid grid-cols-4 gap-1">
            <button onclick="showHome()" class="nav-item flex flex-col items-center py-2 text-blue-600">
                <i class="fas fa-home text-xl mb-1"></i>
                <span class="text-xs">Home</span>
            </button>
            <button onclick="showRequests()" class="nav-item flex flex-col items-center py-2 text-gray-400">
                <i class="fas fa-bell text-xl mb-1"></i>
                <span class="text-xs">Requests</span>
            </button>
            <button onclick="showEarnings()" class="nav-item flex flex-col items-center py-2 text-gray-400">
                <i class="fas fa-wallet text-xl mb-1"></i>
                <span class="text-xs">Earnings</span>
            </button>
            <button onclick="showProfile()" class="nav-item flex flex-col items-center py-2 text-gray-400">
                <i class="fas fa-user text-xl mb-1"></i>
                <span class="text-xs">Profile</span>
            </button>
        </div>
    </nav>

    <!-- Earnings Modal -->
    <div id="earningsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl p-6 slide-up max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Earnings</h2>
                <button onclick="closeEarnings()" class="text-gray-500">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="text-sm text-gray-600">Total Earnings</div>
                    <div class="text-3xl font-bold text-blue-600" id="totalEarnings">R0.00</div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-gray-50 rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-600">Today</div>
                        <div class="font-bold" id="modalTodayEarnings">R0</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-600">This Week</div>
                        <div class="font-bold" id="weekEarnings">R0</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-600">This Month</div>
                        <div class="font-bold" id="monthEarnings">R0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let isOnline = false;
        let locationWatchId = null;
        let refreshInterval = null;

        // Initialize Google Maps
        function initMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const center = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map = new google.maps.Map(document.createElement('div'), {
                        zoom: 15,
                        center: center
                    });
                });
            }
        }

        // Load driver data
        async function loadDriverData() {
            try {
                // Load earnings
                const earningsRes = await fetch('/api/driver/uber/earnings');
                if (earningsRes.ok) {
                    const earningsData = await earningsRes.json();
                    if (earningsData.success) {
                        const data = earningsData.data;
                        document.getElementById('todayEarnings').textContent = formatZARCompact(data.todayEarnings || 0);
                        document.getElementById('totalDeliveries').textContent = data.totalDeliveries || 0;
                        document.getElementById('rating').textContent = (data.driverRating || 0).toFixed(1);
                        document.getElementById('modalTodayEarnings').textContent = formatZARCompact(data.todayEarnings || 0);
                        document.getElementById('weekEarnings').textContent = formatZARCompact(data.weekEarnings || 0);
                        document.getElementById('monthEarnings').textContent = formatZARCompact(data.monthEarnings || 0);
                        document.getElementById('totalEarnings').textContent = formatZAR(data.totalEarnings || 0);
                    }
                }

                // Load deliveries
                const deliveriesRes = await fetch('/api/driver/uber/deliveries?status=ASSIGNED');
                if (deliveriesRes.ok) {
                    const deliveriesData = await deliveriesRes.json();
                    if (deliveriesData.success) {
                        updateDeliveriesList(deliveriesData.data);
                    }
                }

                // Load requests if online
                if (isOnline) {
                    loadRequests();
                }
            } catch (error) {
                console.error('Error loading driver data:', error);
            }
        }

        // Load delivery requests
        async function loadRequests() {
            try {
                if (!navigator.geolocation) return;
                
                navigator.geolocation.getCurrentPosition(async position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    const response = await fetch(`/api/driver/uber/requests?latitude=${lat}&longitude=${lng}&radiusKm=20`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.data && data.data.length > 0) {
                            updateRequestsList(data.data);
                            document.getElementById('requestsSection').style.display = 'block';
                        } else {
                            document.getElementById('requestsSection').style.display = 'none';
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

        // Update requests list
        function updateRequestsList(requests) {
            const container = document.getElementById('requestsList');
            container.innerHTML = requests.map(req => `
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-gray-900">${req.pickupAddress || 'Pickup Location'}</div>
                            <div class="text-sm text-gray-600">→ ${req.deliveryAddress || 'Delivery Location'}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-blue-600">${formatZARCompact(req.totalAmount || 0)}</div>
                            ${req.distanceKm ? `<div class="text-xs text-gray-500">${req.distanceKm.toFixed(1)} km</div>` : ''}
                        </div>
                    </div>
                    <button onclick="acceptRequest(${req.bookingId})" 
                            class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium mt-2">
                        Accept Delivery
                    </button>
                </div>
            `).join('');
        }

        // Update deliveries list
        function updateDeliveriesList(deliveries) {
            const container = document.getElementById('deliveriesList');
            if (deliveries.length === 0) {
                container.innerHTML = `
                    <div class="bg-gray-100 rounded-lg p-4 text-center text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-2"></i>
                        <p>No active deliveries</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = deliveries.map(delivery => `
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-gray-900">${delivery.bookingNumber || 'N/A'}</div>
                            <div class="text-sm text-gray-600">${delivery.pickupAddress || ''}</div>
                            <div class="text-sm text-gray-600">→ ${delivery.deliveryAddress || ''}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-600">${formatZARCompact(delivery.totalAmount || 0)}</div>
                            <div class="text-xs text-gray-500 capitalize">${(delivery.status || '').replace('_', ' ')}</div>
                        </div>
                    </div>
                    <button onclick="viewDelivery(${delivery.bookingId})" 
                            class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium mt-2">
                        View Details
                    </button>
                </div>
            `).join('');
        }

        // Toggle online/offline status
        async function toggleStatus() {
            try {
                const newStatus = !isOnline;
                const response = await fetch('/api/driver/uber/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isOnline: newStatus })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        isOnline = result.isOnline;
                        updateStatusUI();
                        
                        if (isOnline) {
                            startLocationTracking();
                            loadRequests();
                            refreshInterval = setInterval(() => {
                                loadRequests();
                                loadDriverData();
                            }, 10000); // Refresh every 10 seconds
                        } else {
                            stopLocationTracking();
                            if (refreshInterval) {
                                clearInterval(refreshInterval);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error toggling status:', error);
            }
        }

        // Update status UI
        function updateStatusUI() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const toggleBtn = document.getElementById('toggleStatusBtn');
            
            if (isOnline) {
                statusDot.className = 'status-indicator status-online pulse-online';
                statusText.textContent = 'Online';
                toggleBtn.textContent = 'Go Offline';
                toggleBtn.className = 'bg-red-500 text-white px-4 py-2 rounded-lg font-medium text-sm';
            } else {
                statusDot.className = 'status-indicator status-offline';
                statusText.textContent = 'Offline';
                toggleBtn.textContent = 'Go Online';
                toggleBtn.className = 'bg-white text-blue-600 px-4 py-2 rounded-lg font-medium text-sm';
            }
        }

        // Start location tracking
        function startLocationTracking() {
            if (!navigator.geolocation) return;
            
            locationWatchId = navigator.geolocation.watchPosition(
                position => {
                    updateLocation(position.coords.latitude, position.coords.longitude);
                },
                error => console.error('Geolocation error:', error),
                { enableHighAccuracy: true, maximumAge: 5000 }
            );
            
            // Also update immediately
            navigator.geolocation.getCurrentPosition(position => {
                updateLocation(position.coords.latitude, position.coords.longitude);
            });
        }

        // Stop location tracking
        function stopLocationTracking() {
            if (locationWatchId !== null) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
        }

        // Update location on server
        async function updateLocation(lat, lng) {
            try {
                await fetch('/api/driver/uber/location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lng })
                });
            } catch (error) {
                console.error('Error updating location:', error);
            }
        }

        // Accept delivery request
        async function acceptRequest(bookingId) {
            try {
                const response = await fetch(`/api/driver/uber/accept/${bookingId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Delivery request accepted!');
                        loadDriverData();
                        loadRequests();
                    } else {
                        alert(result.error || 'Failed to accept request');
                    }
                }
            } catch (error) {
                console.error('Error accepting request:', error);
                alert('Error accepting request. Please try again.');
            }
        }

        // View delivery details
        function viewDelivery(bookingId) {
            window.location.href = `/driver/workboard?bookingId=${bookingId}`;
        }

        // Navigation functions
        function showHome() { window.location.reload(); }
        function showRequests() { document.getElementById('requestsSection').scrollIntoView(); }
        function showEarnings() { document.getElementById('earningsModal').classList.remove('hidden'); }
        function closeEarnings() { document.getElementById('earningsModal').classList.add('hidden'); }
        function showProfile() { window.location.href = '/driver/dashboard'; }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDriverData();
            
            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(i => {
                        i.classList.remove('text-blue-600');
                        i.classList.add('text-gray-400');
                    });
                    this.classList.remove('text-gray-400');
                    this.classList.add('text-blue-600');
                });
            });
        });
    </script>
</body>
</html>





