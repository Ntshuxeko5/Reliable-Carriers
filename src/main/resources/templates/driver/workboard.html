<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Workboard - Reliable Carriers</title>
    
    <!-- Tailwind CSS with custom colors -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'reliable': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Signature Pad -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-reliable-50 to-reliable-100 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-lg border-b border-reliable-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-reliable-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-clipboard-list text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Driver Workboard</h1>
                        <p class="text-sm text-gray-600">Manage your packages and deliveries</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-sm text-gray-600">Current Time</p>
                        <p class="font-semibold text-gray-900" id="currentTime"></p>
                    </div>
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <button onclick="window.location.href='/driver/dashboard'" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- Workboard Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-white/20">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-boxes text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Packages</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalPackages">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-white/20">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-hand-holding-box text-yellow-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">To Pickup</p>
                        <p class="text-2xl font-bold text-gray-900" id="packagesToPickup">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-white/20">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-truck text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">In Vehicle</p>
                        <p class="text-2xl font-bold text-gray-900" id="packagesInVehicle">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-white/20">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-money-bill-wave text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Today's Earnings</p>
                        <p class="text-2xl font-bold text-gray-900" id="todayEarnings">$0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Workboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Map Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg border border-white/20">
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-map text-reliable-600 mr-2"></i> Delivery Route
                            </h2>
                            <div class="flex space-x-2">
                                <button onclick="getCurrentLocation()" class="bg-reliable-600 hover:bg-reliable-700 text-white px-3 py-1 rounded-lg text-sm transition-colors duration-200">
                                    <i class="fas fa-location-arrow mr-1"></i>My Location
                                </button>
                                <button onclick="refreshWorkboard()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded-lg text-sm transition-colors duration-200">
                                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-0">
                        <div id="map" class="h-96 rounded-b-2xl"></div>
                    </div>
                </div>
            </div>
            
            <!-- Package Management Section -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Available Packages -->
                <div class="bg-white rounded-2xl shadow-lg border border-white/20">
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-plus-circle text-green-500 mr-2"></i>Available Packages
                            </h3>
                            <div class="flex space-x-2">
                                <input type="text" id="packageSearch" placeholder="Search packages..." 
                                       class="text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-reliable-500">
                                <select id="packageFilter" class="text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-reliable-500">
                                    <option value="">All</option>
                                    <option value="nearby">Nearby</option>
                                    <option value="urgent">Urgent</option>
                                    <option value="heavy">Heavy</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div id="availablePackages" class="space-y-3 max-h-64 overflow-y-auto">
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-spinner fa-spin text-xl"></i>
                                <p class="mt-2">Loading available packages...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Assigned Packages -->
                <div class="bg-white rounded-2xl shadow-lg border border-white/20">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-clipboard-check text-blue-500 mr-2"></i>My Packages
                        </h3>
                    </div>
                    <div class="p-4">
                        <div id="assignedPackages" class="space-y-3 max-h-64 overflow-y-auto">
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-spinner fa-spin text-xl"></i>
                                <p class="mt-2">Loading assigned packages...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="bg-white rounded-2xl shadow-lg border border-white/20">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-bolt text-yellow-500 mr-2"></i>Quick Actions
                        </h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <button onclick="showNearbyPackages()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg text-sm transition-colors duration-200">
                            <i class="fas fa-search-location mr-2"></i>Find Nearby Packages
                        </button>
                        <button onclick="showOptimizedRoute()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm transition-colors duration-200">
                            <i class="fas fa-route mr-2"></i>Optimized Route
                        </button>
                        <button onclick="showTodaySummary()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg text-sm transition-colors duration-200">
                            <i class="fas fa-chart-bar mr-2"></i>Today's Summary
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Signature Modal -->
    <div id="signatureModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Capture Signature</h3>
                <button onclick="closeSignatureModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Customer Signature</label>
                <div class="border-2 border-gray-300 rounded-lg">
                    <canvas id="signatureCanvas" width="400" height="200" class="w-full h-48 cursor-crosshair"></canvas>
                </div>
            </div>
            
            <div class="flex space-x-3 mb-4">
                <button onclick="clearSignature()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                    <i class="fas fa-eraser mr-2"></i>Clear
                </button>
                <button onclick="saveSignature()" class="flex-1 bg-reliable-600 hover:bg-reliable-700 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                    <i class="fas fa-save mr-2"></i>Save
                </button>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Capture Photo</h3>
                <button onclick="closePhotoModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Package Photo</label>
                <div class="border-2 border-gray-300 rounded-lg p-4">
                    <video id="photoVideo" class="w-full h-48 bg-gray-100 rounded-lg hidden"></video>
                    <canvas id="photoCanvas" class="w-full h-48 bg-gray-100 rounded-lg hidden"></canvas>
                    <div id="photoPlaceholder" class="w-full h-48 bg-gray-100 rounded-lg flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Click to capture photo</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3">
                <button onclick="startCamera()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                    <i class="fas fa-camera mr-2"></i>Start Camera
                </button>
                <button onclick="capturePhoto()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                    <i class="fas fa-camera-retro mr-2"></i>Capture
                </button>
                <button onclick="savePhoto()" class="flex-1 bg-reliable-600 hover:bg-reliable-700 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                    <i class="fas fa-save mr-2"></i>Save
                </button>
            </div>
        </div>
    </div>

    <!-- Pickup Modal -->
    <div id="pickupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Package Pickup</h3>
                <button onclick="closePickupModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="pickupForm" class="space-y-4">
                <input type="hidden" id="pickupPackageId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Package Details</label>
                    <div id="pickupPackageDetails" class="bg-gray-50 p-3 rounded-lg">
                        <!-- Package details will be populated here -->
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pickup Notes</label>
                    <textarea id="pickupNotes" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-reliable-500"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Customer Signature</label>
                        <button type="button" onclick="openSignatureModal('pickup')" class="w-full border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-reliable-500 transition-colors duration-200">
                            <i class="fas fa-signature text-2xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600">Click to capture signature</p>
                        </button>
                        <div id="pickupSignaturePreview" class="mt-2 hidden">
                            <img id="pickupSignatureImage" class="w-full h-16 border border-gray-300 rounded-lg" alt="Signature">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Package Photo</label>
                        <button type="button" onclick="openPhotoModal('pickup')" class="w-full border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-reliable-500 transition-colors duration-200">
                            <i class="fas fa-camera text-2xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600">Click to capture photo</p>
                        </button>
                        <div id="pickupPhotoPreview" class="mt-2 hidden">
                            <img id="pickupPhotoImage" class="w-full h-16 border border-gray-300 rounded-lg object-cover" alt="Package Photo">
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closePickupModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 bg-reliable-600 hover:bg-reliable-700 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                        <i class="fas fa-check mr-2"></i>Confirm Pickup
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delivery Modal -->
    <div id="deliveryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Package Delivery</h3>
                <button onclick="closeDeliveryModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="deliveryForm" class="space-y-4">
                <input type="hidden" id="deliveryPackageId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Package Details</label>
                    <div id="deliveryPackageDetails" class="bg-gray-50 p-3 rounded-lg">
                        <!-- Package details will be populated here -->
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Recipient Name</label>
                        <input type="text" id="recipientName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-reliable-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Recipient Phone</label>
                        <input type="tel" id="recipientPhone" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-reliable-500" required>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Recipient ID Number</label>
                    <input type="text" id="recipientIdNumber" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-reliable-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Method</label>
                    <select id="deliveryMethod" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-reliable-500" required>
                        <option value="">Select delivery method</option>
                        <option value="HAND_TO_RECIPIENT">Hand to Recipient</option>
                        <option value="LEAVE_AT_DOOR">Leave at Door</option>
                        <option value="SECURITY_DESK">Security Desk</option>
                        <option value="MAILBOX">Mailbox</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Notes</label>
                    <textarea id="deliveryNotes" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-reliable-500"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Recipient Signature</label>
                        <button type="button" onclick="openSignatureModal('delivery')" class="w-full border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-reliable-500 transition-colors duration-200">
                            <i class="fas fa-signature text-2xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600">Click to capture signature</p>
                        </button>
                        <div id="deliverySignaturePreview" class="mt-2 hidden">
                            <img id="deliverySignatureImage" class="w-full h-16 border border-gray-300 rounded-lg" alt="Signature">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Photo</label>
                        <button type="button" onclick="openPhotoModal('delivery')" class="w-full border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-reliable-500 transition-colors duration-200">
                            <i class="fas fa-camera text-2xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600">Click to capture photo</p>
                        </button>
                        <div id="deliveryPhotoPreview" class="mt-2 hidden">
                            <img id="deliveryPhotoImage" class="w-full h-16 border border-gray-300 rounded-lg object-cover" alt="Delivery Photo">
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeDeliveryModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 bg-reliable-600 hover:bg-reliable-700 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                        <i class="fas fa-check mr-2"></i>Confirm Delivery
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        let map;
        let currentLocation = null;
        let signaturePad;
        let currentModal = null;
        let currentPackageId = null;
        let capturedSignature = null;
        let capturedPhoto = null;
        let stream = null;
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([-26.2041, 28.0473], 10); // Default to Johannesburg
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
        }
        
        // Signature Pad functionality
        function initSignaturePad() {
            const canvas = document.getElementById('signatureCanvas');
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)'
            });
        }
        
        function clearSignature() {
            signaturePad.clear();
        }
        
        function saveSignature() {
            if (signaturePad.isEmpty()) {
                alert('Please provide a signature');
                return;
            }
            
            capturedSignature = signaturePad.toDataURL();
            closeSignatureModal();
            
            // Update preview based on current modal
            if (currentModal === 'pickup') {
                document.getElementById('pickupSignatureImage').src = capturedSignature;
                document.getElementById('pickupSignaturePreview').classList.remove('hidden');
            } else if (currentModal === 'delivery') {
                document.getElementById('deliverySignatureImage').src = capturedSignature;
                document.getElementById('deliverySignaturePreview').classList.remove('hidden');
            }
        }
        
        // Photo capture functionality
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                
                const video = document.getElementById('photoVideo');
                video.srcObject = stream;
                video.play();
                
                document.getElementById('photoVideo').classList.remove('hidden');
                document.getElementById('photoPlaceholder').classList.add('hidden');
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Unable to access camera. Please check permissions.');
            }
        }
        
        function capturePhoto() {
            if (!stream) {
                alert('Please start camera first');
                return;
            }
            
            const video = document.getElementById('photoVideo');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            capturedPhoto = canvas.toDataURL('image/jpeg');
            
            // Show captured photo
            canvas.classList.remove('hidden');
            video.classList.add('hidden');
            
            // Stop camera stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }
        
        function savePhoto() {
            if (!capturedPhoto) {
                alert('Please capture a photo first');
                return;
            }
            
            closePhotoModal();
            
            // Update preview based on current modal
            if (currentModal === 'pickup') {
                document.getElementById('pickupPhotoImage').src = capturedPhoto;
                document.getElementById('pickupPhotoPreview').classList.remove('hidden');
            } else if (currentModal === 'delivery') {
                document.getElementById('deliveryPhotoImage').src = capturedPhoto;
                document.getElementById('deliveryPhotoPreview').classList.remove('hidden');
            }
        }
        
        // Modal management
        function openSignatureModal(modalType) {
            currentModal = modalType;
            document.getElementById('signatureModal').classList.remove('hidden');
            initSignaturePad();
        }
        
        function closeSignatureModal() {
            document.getElementById('signatureModal').classList.add('hidden');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }
        
        function openPhotoModal(modalType) {
            currentModal = modalType;
            document.getElementById('photoModal').classList.remove('hidden');
            
            // Reset photo elements
            document.getElementById('photoVideo').classList.add('hidden');
            document.getElementById('photoCanvas').classList.add('hidden');
            document.getElementById('photoPlaceholder').classList.remove('hidden');
            capturedPhoto = null;
        }
        
        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }
        
        function openPickupModal(packageId) {
            currentPackageId = packageId;
            document.getElementById('pickupPackageId').value = packageId;
            
            // Load package details
            loadPackageDetails(packageId, 'pickup');
            
            // Reset form
            document.getElementById('pickupForm').reset();
            document.getElementById('pickupSignaturePreview').classList.add('hidden');
            document.getElementById('pickupPhotoPreview').classList.add('hidden');
            capturedSignature = null;
            capturedPhoto = null;
            
            document.getElementById('pickupModal').classList.remove('hidden');
        }
        
        function closePickupModal() {
            document.getElementById('pickupModal').classList.add('hidden');
        }
        
        function openDeliveryModal(packageId) {
            currentPackageId = packageId;
            document.getElementById('deliveryPackageId').value = packageId;
            
            // Load package details
            loadPackageDetails(packageId, 'delivery');
            
            // Reset form
            document.getElementById('deliveryForm').reset();
            document.getElementById('deliverySignaturePreview').classList.add('hidden');
            document.getElementById('deliveryPhotoPreview').classList.add('hidden');
            capturedSignature = null;
            capturedPhoto = null;
            
            document.getElementById('deliveryModal').classList.remove('hidden');
        }
        
        function closeDeliveryModal() {
            document.getElementById('deliveryModal').classList.add('hidden');
        }
        
        // Load package details
        async function loadPackageDetails(packageId, modalType) {
            try {
                const response = await fetch(`/api/driver/workboard/packages/${packageId}/details`);
                const packageData = await response.json();
                
                const detailsHtml = `
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="font-medium">Tracking:</span>
                            <span>${packageData.trackingNumber || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Recipient:</span>
                            <span>${packageData.recipientName || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Address:</span>
                            <span>${packageData.deliveryAddress || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Status:</span>
                            <span class="px-2 py-1 rounded text-xs ${packageData.status === 'IN_TRANSIT' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${packageData.status || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Weight:</span>
                            <span>${packageData.weight || 'N/A'} kg</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Description:</span>
                            <span>${packageData.description || 'N/A'}</span>
                        </div>
                    </div>
                `;
                
                if (modalType === 'pickup') {
                    document.getElementById('pickupPackageDetails').innerHTML = detailsHtml;
                } else {
                    document.getElementById('deliveryPackageDetails').innerHTML = detailsHtml;
                }
            } catch (error) {
                console.error('Error loading package details:', error);
            }
        }
        
        // Form submissions
        document.getElementById('pickupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('driverId', getCurrentDriverId());
            formData.append('packageId', document.getElementById('pickupPackageId').value);
            formData.append('pickupNotes', document.getElementById('pickupNotes').value);
            
            if (capturedSignature) {
                // Convert base64 to blob
                const signatureBlob = await fetch(capturedSignature).then(r => r.blob());
                formData.append('signaturePhoto', signatureBlob, 'signature.jpg');
            }
            
            if (capturedPhoto) {
                // Convert base64 to blob
                const photoBlob = await fetch(capturedPhoto).then(r => r.blob());
                formData.append('packagePhoto', photoBlob, 'package.jpg');
            }
            
            if (currentLocation) {
                formData.append('pickupLat', currentLocation.lat);
                formData.append('pickupLng', currentLocation.lng);
            }
            
            try {
                const response = await fetch(`/api/driver/workboard/packages/${document.getElementById('pickupPackageId').value}/pickup`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    alert('Package picked up successfully!');
                    closePickupModal();
                    loadWorkboardData();
                } else {
                    const error = await response.text();
                    alert('Error picking up package: ' + error);
                }
            } catch (error) {
                console.error('Error picking up package:', error);
                alert('Error picking up package');
            }
        });
        
        document.getElementById('deliveryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('driverId', getCurrentDriverId());
            formData.append('packageId', document.getElementById('deliveryPackageId').value);
            formData.append('recipientName', document.getElementById('recipientName').value);
            formData.append('recipientPhone', document.getElementById('recipientPhone').value);
            formData.append('recipientIdNumber', document.getElementById('recipientIdNumber').value);
            formData.append('deliveryMethod', document.getElementById('deliveryMethod').value);
            formData.append('deliveryNotes', document.getElementById('deliveryNotes').value);
            
            if (capturedSignature) {
                // Convert base64 to blob
                const signatureBlob = await fetch(capturedSignature).then(r => r.blob());
                formData.append('signaturePhoto', signatureBlob, 'signature.jpg');
            }
            
            if (capturedPhoto) {
                // Convert base64 to blob
                const photoBlob = await fetch(capturedPhoto).then(r => r.blob());
                formData.append('deliveryPhoto', photoBlob, 'delivery.jpg');
            }
            
            if (currentLocation) {
                formData.append('deliveryLat', currentLocation.lat);
                formData.append('deliveryLng', currentLocation.lng);
            }
            
            try {
                const response = await fetch(`/api/driver/workboard/packages/${document.getElementById('deliveryPackageId').value}/deliver`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    alert('Package delivered successfully!');
                    closeDeliveryModal();
                    loadWorkboardData();
                } else {
                    const error = await response.text();
                    alert('Error delivering package: ' + error);
                }
            } catch (error) {
                console.error('Error delivering package:', error);
                alert('Error delivering package');
            }
        });
        
        // Get current driver ID (you'll need to implement this based on your auth system)
        function getCurrentDriverId() {
            // This should return the current driver's ID from your authentication system
            // For now, returning a placeholder - you'll need to implement this
            return 1; // Replace with actual driver ID from session/auth
        }
        
        // Get current location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Update map view
                        map.setView([currentLocation.lat, currentLocation.lng], 15);
                        
                        // Add current location marker
                        L.marker([currentLocation.lat, currentLocation.lng], {
                            icon: L.divIcon({
                                className: 'current-location-marker',
                                html: '<div style="background-color: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map);
                        
                        // Update location on server
                        updateLocationOnServer(currentLocation.lat, currentLocation.lng);
                        
                        // Load workboard data
                        loadWorkboardData();
                    },
                    function(error) {
                        console.error('Error getting location:', error);
                        showNotification('Unable to get your location. Please enable location services.', 'error');
                    }
                );
            } else {
                showNotification('Geolocation is not supported by this browser.', 'error');
            }
        }
        
        // Update location on server
        async function updateLocationOnServer(lat, lng) {
            try {
                const response = await fetch('/api/driver/workboard/location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `lat=${lat}&lng=${lng}`
                });
                
                if (response.ok) {
                    console.log('Location updated successfully');
                } else {
                    console.error('Failed to update location');
                }
            } catch (error) {
                console.error('Error updating location:', error);
            }
        }
        
        // Load workboard data
        async function loadWorkboardData() {
            try {
                const params = new URLSearchParams();
                if (currentLocation) {
                    params.append('currentLat', currentLocation.lat);
                    params.append('currentLng', currentLocation.lng);
                }
                
                // Load workboard stats
                const statsResponse = await fetch(`/api/driver/workboard/stats?${params}`);
                const stats = await statsResponse.json();
                updateWorkboardStats(stats);
                
                // Load available packages
                const availableResponse = await fetch(`/api/driver/workboard/available-packages?${params}`);
                const availablePackages = await availableResponse.json();
                updateAvailablePackages(availablePackages);
                
                // Load assigned packages
                const assignedResponse = await fetch(`/api/driver/workboard/assigned-packages?${params}`);
                const assignedPackages = await assignedResponse.json();
                updateAssignedPackages(assignedPackages);
                
            } catch (error) {
                console.error('Error loading workboard data:', error);
            }
        }
        
        // Update workboard statistics
        function updateWorkboardStats(stats) {
            document.getElementById('totalPackages').textContent = stats.totalPackages || 0;
            document.getElementById('packagesToPickup').textContent = stats.packagesToPickup || 0;
            document.getElementById('packagesInVehicle').textContent = stats.packagesInVehicle || 0;
            document.getElementById('todayEarnings').textContent = `$${stats.todayEarnings || 0}`;
        }
        
        // Update available packages
        function updateAvailablePackages(packages) {
            const container = document.getElementById('availablePackages');
            
            if (packages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-box-open text-2xl mb-2"></i>
                        <p>No available packages</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = packages.map(pkg => `
                <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition-colors duration-200" 
                     onclick="requestPackagePickup(${pkg.id})"
                     data-tracking="${pkg.trackingNumber}"
                     data-recipient="${pkg.recipientName}"
                     data-weight="${pkg.weight}"
                     data-distance="${pkg.distanceFromCurrentLocation || 0}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 text-sm">${pkg.trackingNumber}</h4>
                            <p class="text-xs text-gray-600">${pkg.recipientName}</p>
                            <p class="text-xs text-gray-500">${pkg.deliveryCity}, ${pkg.deliveryState}</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="text-xs text-gray-400">
                                    <i class="fas fa-weight-hanging mr-1"></i>${pkg.weight || 0} kg
                                </span>
                                ${pkg.distanceFromCurrentLocation ? `
                                    <span class="text-xs text-gray-400">
                                        <i class="fas fa-map-marker-alt mr-1"></i>${pkg.distanceFromCurrentLocation.toFixed(1)} km
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Available
                            </span>
                            ${pkg.deliveryPriority ? `
                                <div class="mt-1">
                                    <span class="inline-flex items-center px-1 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                        Priority ${pkg.deliveryPriority}
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Update assigned packages
        function updateAssignedPackages(packages) {
            const container = document.getElementById('assignedPackages');
            
            if (packages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-clipboard text-2xl mb-2"></i>
                        <p>No assigned packages</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = packages.map(pkg => `
                <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition-colors duration-200" 
                     onclick="showPackageActions(${pkg.id})"
                     data-tracking="${pkg.trackingNumber}"
                     data-recipient="${pkg.recipientName}"
                     data-status="${pkg.status}"
                     data-weight="${pkg.weight}"
                     data-distance="${pkg.distanceFromCurrentLocation || 0}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 text-sm">${pkg.trackingNumber}</h4>
                            <p class="text-xs text-gray-600">${pkg.recipientName}</p>
                            <p class="text-xs text-gray-500">${pkg.deliveryCity}, ${pkg.deliveryState}</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="text-xs text-gray-400">
                                    <i class="fas fa-weight-hanging mr-1"></i>${pkg.weight || 0} kg
                                </span>
                                ${pkg.distanceFromCurrentLocation ? `
                                    <span class="text-xs text-gray-400">
                                        <i class="fas fa-map-marker-alt mr-1"></i>${pkg.distanceFromCurrentLocation.toFixed(1)} km
                                    </span>
                                ` : ''}
                                ${pkg.estimatedTimeMinutes ? `
                                    <span class="text-xs text-gray-400">
                                        <i class="fas fa-clock mr-1"></i>${pkg.estimatedTimeMinutes} min
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                pkg.status === 'IN_TRANSIT' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${pkg.status === 'IN_TRANSIT' ? 'In Vehicle' : 'To Pickup'}
                            </span>
                            ${pkg.deliveryPriority ? `
                                <div class="mt-1">
                                    <span class="inline-flex items-center px-1 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                        Priority ${pkg.deliveryPriority}
                                    </span>
                                </div>
                            ` : ''}
                            ${pkg.status === 'ASSIGNED' ? `
                                <div class="mt-2 flex space-x-1">
                                    <button onclick="acceptPackage(${pkg.id})" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs transition-colors duration-200">
                                        <i class="fas fa-check mr-1"></i>Accept
                                    </button>
                                    <button onclick="rejectPackage(${pkg.id})" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs transition-colors duration-200">
                                        <i class="fas fa-times mr-1"></i>Reject
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Request package pickup
        async function requestPackagePickup(packageId) {
            try {
                const response = await fetch(`/api/driver/workboard/packages/${packageId}/request-pickup`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Pickup request submitted successfully!');
                    loadWorkboardData();
                } else {
                    alert('Error requesting pickup');
                }
            } catch (error) {
                console.error('Error requesting pickup:', error);
                alert('Error requesting pickup');
            }
        }
        
        // Show package actions
        function showPackageActions(packageId) {
            const action = confirm('Choose action:\nOK = Pickup Package\nCancel = Deliver Package');
            if (action) {
                openPickupModal(packageId);
            } else {
                openDeliveryModal(packageId);
            }
        }
        
        // Quick action functions
        async function showNearbyPackages() {
            if (!currentLocation) {
                alert('Please enable location services to find nearby packages');
                return;
            }
            
            try {
                const response = await fetch(`/api/driver/workboard/nearby-packages?currentLat=${currentLocation.lat}&currentLng=${currentLocation.lng}&radius=5.0`);
                const packages = await response.json();
                
                if (packages.length === 0) {
                    alert('No nearby packages found within 5km radius');
                    return;
                }
                
                // Show nearby packages in a modal or update the available packages section
                updateAvailablePackages(packages);
                showNotification(`Found ${packages.length} nearby packages`, 'success');
            } catch (error) {
                console.error('Error fetching nearby packages:', error);
                showNotification('Error fetching nearby packages', 'error');
            }
        }
        
        async function showOptimizedRoute() {
            try {
                const params = new URLSearchParams();
                if (currentLocation) {
                    params.append('currentLat', currentLocation.lat);
                    params.append('currentLng', currentLocation.lng);
                }
                
                const response = await fetch(`/api/driver/workboard/optimized-route?${params}`);
                const route = await response.json();
                
                if (route.length === 0) {
                    alert('No packages assigned for route optimization');
                    return;
                }
                
                // Display optimized route on map
                displayOptimizedRoute(route);
                showNotification(`Optimized route with ${route.length} stops`, 'success');
            } catch (error) {
                console.error('Error fetching optimized route:', error);
                showNotification('Error fetching optimized route', 'error');
            }
        }
        
        async function showTodaySummary() {
            try {
                const response = await fetch('/api/driver/workboard/today-summary');
                const summary = await response.json();
                
                // Display summary in a modal
                showTodaySummaryModal(summary);
            } catch (error) {
                console.error('Error fetching today summary:', error);
                showNotification('Error fetching today summary', 'error');
            }
        }
        
        // Display optimized route on map
        function displayOptimizedRoute(route) {
            // Clear existing route markers
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker && layer.options.title !== 'Current Location') {
                    map.removeLayer(layer);
                }
            });
            
            // Add route markers
            route.forEach((pkg, index) => {
                const marker = L.marker([pkg.deliveryLat || -26.2041, pkg.deliveryLng || 28.0473], {
                    icon: L.divIcon({
                        className: 'route-marker',
                        html: `<div style="background-color: #3b82f6; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;">${index + 1}</div>`,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    })
                }).addTo(map);
                
                marker.bindPopup(`
                    <div class="text-sm">
                        <strong>Stop ${index + 1}</strong><br>
                        <strong>${pkg.trackingNumber}</strong><br>
                        ${pkg.recipientName}<br>
                        ${pkg.deliveryAddress}<br>
                        <span class="text-xs text-gray-500">${pkg.formattedStatus}</span>
                    </div>
                `);
            });
            
            // Fit map to show all markers
            if (route.length > 0) {
                const group = new L.featureGroup(route.map(pkg => 
                    L.marker([pkg.deliveryLat || -26.2041, pkg.deliveryLng || 28.0473])
                ));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Show today summary modal
        function showTodaySummaryModal(summary) {
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white rounded-2xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-900">Today's Summary</h3>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-blue-800">Packages Delivered</h4>
                                    <p class="text-2xl font-bold text-blue-600">${summary.packagesDelivered || 0}</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-green-800">Packages Picked Up</h4>
                                    <p class="text-2xl font-bold text-green-600">${summary.packagesPickedUp || 0}</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-yellow-800">Total Distance</h4>
                                    <p class="text-2xl font-bold text-yellow-600">${summary.totalDistance || 0} km</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-purple-800">Today's Earnings</h4>
                                    <p class="text-2xl font-bold text-purple-600">$${summary.todayEarnings || 0}</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">Performance Metrics</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>On-time Deliveries:</span>
                                        <span class="font-semibold">${summary.onTimeDeliveries || 0}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Average Delivery Time:</span>
                                        <span class="font-semibold">${summary.averageDeliveryTime || 0} min</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Customer Satisfaction:</span>
                                        <span class="font-semibold">${summary.customerSatisfactionScore || 0}/5</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
            } animate-slide-up`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Refresh workboard
        function refreshWorkboard() {
            loadWorkboardData();
        }
        
        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }
        
        // Accept package
        async function acceptPackage(packageId) {
            try {
                const response = await fetch(`/api/driver/workboard/packages/${packageId}/accept`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getToken(),
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Package accepted successfully!', 'success');
                    refreshWorkboard();
                } else {
                    showNotification(result.message || 'Failed to accept package', 'error');
                }
            } catch (error) {
                console.error('Error accepting package:', error);
                showNotification('Error accepting package', 'error');
            }
        }

        // Reject package
        async function rejectPackage(packageId) {
            const reason = prompt('Please provide a reason for rejecting this package:');
            if (!reason) return;
            
            try {
                const response = await fetch(`/api/driver/workboard/packages/${packageId}/reject?reason=${encodeURIComponent(reason)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getToken(),
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Package rejected successfully!', 'success');
                    refreshWorkboard();
                } else {
                    showNotification(result.message || 'Failed to reject package', 'error');
                }
            } catch (error) {
                console.error('Error rejecting package:', error);
                showNotification('Error rejecting package', 'error');
            }
        }

        // Get auth token
        function getToken() {
            return localStorage.getItem('jwtToken') || sessionStorage.getItem('jwtToken');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            getCurrentLocation();
            
            // Update time every second
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Refresh data every 30 seconds
            setInterval(refreshWorkboard, 30000);
            
            // Add event listeners for search and filter
            document.getElementById('packageSearch').addEventListener('input', filterPackages);
            document.getElementById('packageFilter').addEventListener('change', filterPackages);
        });
        
        // Filter packages based on search and filter criteria
        function filterPackages() {
            const searchTerm = document.getElementById('packageSearch').value.toLowerCase();
            const filterValue = document.getElementById('packageFilter').value;
            const packageElements = document.querySelectorAll('#availablePackages > div');
            
            packageElements.forEach(element => {
                const packageText = element.textContent.toLowerCase();
                const matchesSearch = packageText.includes(searchTerm);
                const matchesFilter = filterValue === '' || matchesFilterCriteria(element, filterValue);
                
                if (matchesSearch && matchesFilter) {
                    element.style.display = 'block';
                } else {
                    element.style.display = 'none';
                }
            });
        }
        
        // Check if package matches filter criteria
        function matchesFilterCriteria(element, filterValue) {
            // This is a simplified implementation - you might want to add data attributes to make this more robust
            const packageText = element.textContent.toLowerCase();
            
            switch (filterValue) {
                case 'nearby':
                    return packageText.includes('nearby') || packageText.includes('close');
                case 'urgent':
                    return packageText.includes('urgent') || packageText.includes('priority');
                case 'heavy':
                    return packageText.includes('heavy') || packageText.includes('large');
                default:
                    return true;
            }
        }
    </script>
</body>
</html>
