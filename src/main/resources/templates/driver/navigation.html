<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Navigation - Reliable Carriers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapsApiKey} + '&libraries=places&callback=initMap'" async defer></script>
    <style>
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
        .hover-lift { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .gradient-text { background: linear-gradient(135deg, #3b82f6, #1e40af); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        #map { height: 400px; width: 100%; border-radius: 12px; }
        .status-badge { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600; 
            text-transform: uppercase;
        }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-picked-up { background: #dbeafe; color: #1e40af; }
        .status-in-transit { background: #f3e8ff; color: #7c3aed; }
        .status-delivered { background: #d1fae5; color: #065f46; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-blue-600 to-blue-800 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/driver/dashboard" class="flex items-center">
                        <i class="fas fa-shipping-fast text-3xl text-yellow-400 mr-3"></i>
                        <span class="text-2xl font-bold text-white">Driver Portal</span>
                    </a>
                </div>
                
                <div class="hidden md:flex items-center space-x-8">
                    <a href="/driver/dashboard" class="text-white hover:text-yellow-300 transition-colors duration-300 font-medium">Dashboard</a>
                    <a href="/driver/workboard" class="text-white hover:text-yellow-300 transition-colors duration-300 font-medium">Workboard</a>
                    <a href="/driver/navigation" class="text-yellow-300 font-medium">Navigation</a>
                    <a href="/driver/profile" class="text-white hover:text-yellow-300 transition-colors duration-300 font-medium">Profile</a>
                    <a href="/logout" class="text-white hover:text-yellow-300 transition-colors duration-300 font-medium">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-route mr-3 gradient-text"></i>Driver Navigation
            </h1>
            <p class="text-gray-600">Real-time navigation and package tracking for drivers</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Package List -->
            <div class="lg:col-span-1">
                <div class="glass-effect rounded-2xl p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-boxes mr-2 text-blue-600"></i>Today's Packages
                    </h2>
                    
                    <div id="packageList" class="space-y-4">
                        <!-- Package items will be populated by JavaScript -->
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Loading packages...</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <button onclick="startNavigation()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300 flex items-center justify-center">
                            <i class="fas fa-play mr-2"></i>Start Navigation
                        </button>
                        <button onclick="markAsPickedUp()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition-colors duration-300 flex items-center justify-center">
                            <i class="fas fa-check mr-2"></i>Mark as Picked Up
                        </button>
                        <button onclick="markAsDelivered()" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-purple-700 transition-colors duration-300 flex items-center justify-center">
                            <i class="fas fa-truck mr-2"></i>Mark as Delivered
                        </button>
                    </div>
                </div>
            </div>

            <!-- Map and Navigation -->
            <div class="lg:col-span-2">
                <div class="glass-effect rounded-2xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-map mr-2 text-green-600"></i>Navigation Map
                        </h2>
                        <div class="flex items-center space-x-2">
                            <span id="currentLocation" class="text-sm text-gray-600">
                                <i class="fas fa-map-marker-alt mr-1"></i>Getting location...
                            </span>
                        </div>
                    </div>
                    
                    <div id="map"></div>
                    
                    <div class="mt-4 flex items-center justify-between">
                        <div id="routeInfo" class="text-sm text-gray-600">
                            <span id="distance">-</span> â€¢ <span id="duration">-</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="centerOnCurrentLocation()" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                                <i class="fas fa-crosshairs mr-1"></i>My Location
                            </button>
                            <button onclick="toggleTraffic()" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                                <i class="fas fa-car mr-1"></i>Traffic
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Navigation Instructions -->
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-list-ol mr-2 text-purple-600"></i>Turn-by-Turn Directions
                    </h3>
                    <div id="directionsPanel" class="space-y-2">
                        <div class="text-center text-gray-500 py-4">
                            <i class="fas fa-route text-2xl mb-2"></i>
                            <p>Select a package to start navigation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map, directionsService, directionsRenderer, geocoder;
        let currentLocation = null;
        let selectedPackage = null;
        let trafficLayer = null;
        let watchId = null;

        // Sample package data (in real app, this would come from the backend)
        const packages = [
            {
                id: 1,
                trackingNumber: 'RC001234567',
                pickupAddress: '123 Main Street, Johannesburg, South Africa',
                deliveryAddress: '456 Oak Avenue, Pretoria, South Africa',
                status: 'pending',
                customerName: 'John Smith',
                customerPhone: '+27 82 123 4567',
                packageType: 'Parcel',
                weight: '2.5 kg',
                specialInstructions: 'Call before delivery',
                estimatedTime: '2h 15m',
                distance: '45 km'
            },
            {
                id: 2,
                trackingNumber: 'RC001234568',
                pickupAddress: '789 Pine Street, Cape Town, South Africa',
                deliveryAddress: '321 Elm Street, Durban, South Africa',
                status: 'picked-up',
                customerName: 'Sarah Johnson',
                customerPhone: '+27 83 987 6543',
                packageType: 'Document',
                weight: '0.5 kg',
                specialInstructions: 'Leave at reception',
                estimatedTime: '1h 45m',
                distance: '38 km'
            }
        ];

        function initMap() {
            // Initialize map centered on Johannesburg
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 10,
                center: { lat: -26.2041, lng: 28.0473 }, // Johannesburg
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            // Initialize services
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                draggable: true,
                map: map,
                panel: document.getElementById('directionsPanel')
            });
            geocoder = new google.maps.Geocoder();

            // Initialize traffic layer
            trafficLayer = new google.maps.TrafficLayer();

            // Get current location
            getCurrentLocation();

            // Load packages
            loadPackages();
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Update location display
                        document.getElementById('currentLocation').innerHTML = 
                            `<i class="fas fa-map-marker-alt mr-1"></i>Location found`;
                        
                        // Center map on current location
                        map.setCenter(currentLocation);
                        
                        // Add marker for current location
                        new google.maps.Marker({
                            position: currentLocation,
                            map: map,
                            title: 'Your Location',
                            icon: {
                                url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                            }
                        });

                        // Start watching location
                        startLocationTracking();
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        document.getElementById('currentLocation').innerHTML = 
                            `<i class="fas fa-exclamation-triangle mr-1"></i>Location access denied`;
                    }
                );
            }
        }

        function startLocationTracking() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Update map center if no route is active
                        if (!directionsRenderer.getDirections()) {
                            map.setCenter(currentLocation);
                        }
                    },
                    (error) => {
                        console.error('Location tracking error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }

        function loadPackages() {
            const packageList = document.getElementById('packageList');
            packageList.innerHTML = packages.map(pkg => `
                <div class="package-item p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors ${pkg.status === 'pending' ? 'border-blue-300 bg-blue-50' : ''}" 
                     onclick="selectPackage(${pkg.id})" data-package-id="${pkg.id}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-semibold text-gray-900">${pkg.trackingNumber}</div>
                        <span class="status-badge status-${pkg.status}">${pkg.status.replace('-', ' ')}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <div><strong>Customer:</strong> ${pkg.customerName}</div>
                        <div><strong>Package:</strong> ${pkg.packageType} (${pkg.weight})</div>
                    </div>
                    <div class="text-xs text-gray-500">
                        <div><strong>Pickup:</strong> ${pkg.pickupAddress}</div>
                        <div><strong>Delivery:</strong> ${pkg.deliveryAddress}</div>
                    </div>
                    <div class="mt-2 flex items-center justify-between text-xs text-gray-500">
                        <span><i class="fas fa-clock mr-1"></i>${pkg.estimatedTime}</span>
                        <span><i class="fas fa-route mr-1"></i>${pkg.distance}</span>
                    </div>
                </div>
            `).join('');
        }

        function selectPackage(packageId) {
            // Remove previous selection
            document.querySelectorAll('.package-item').forEach(item => {
                item.classList.remove('border-blue-500', 'bg-blue-100');
                item.classList.add('border-gray-200');
            });

            // Add selection to clicked package
            const selectedItem = document.querySelector(`[data-package-id="${packageId}"]`);
            selectedItem.classList.remove('border-gray-200');
            selectedItem.classList.add('border-blue-500', 'bg-blue-100');

            // Set selected package
            selectedPackage = packages.find(pkg => pkg.id === packageId);
            
            // Show package details and start navigation
            showPackageDetails(selectedPackage);
        }

        function showPackageDetails(pkg) {
            // Clear previous directions
            directionsRenderer.setDirections({ routes: [] });
            document.getElementById('directionsPanel').innerHTML = `
                <div class="text-center text-gray-500 py-4">
                    <i class="fas fa-route text-2xl mb-2"></i>
                    <p>Calculating route to ${pkg.pickupAddress}...</p>
                </div>
            `;

            // Calculate route
            calculateRoute(pkg);
        }

        function calculateRoute(pkg) {
            if (!currentLocation) {
                alert('Current location not available. Please enable location services.');
                return;
            }

            const destination = pkg.status === 'pending' ? pkg.pickupAddress : pkg.deliveryAddress;
            
            directionsService.route({
                origin: currentLocation,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING,
                avoidHighways: false,
                avoidTolls: false
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    // Update route info
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    document.getElementById('distance').textContent = leg.distance.text;
                    document.getElementById('duration').textContent = leg.duration.text;
                    
                    // Update directions panel
                    updateDirectionsPanel(result);
                } else {
                    console.error('Directions request failed:', status);
                    alert('Could not calculate route. Please check addresses.');
                }
            });
        }

        function updateDirectionsPanel(result) {
            const directionsPanel = document.getElementById('directionsPanel');
            const route = result.routes[0];
            const leg = route.legs[0];
            
            directionsPanel.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-blue-900 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>Route Summary
                    </h4>
                    <div class="text-sm text-blue-800">
                        <div><strong>Distance:</strong> ${leg.distance.text}</div>
                        <div><strong>Duration:</strong> ${leg.duration.text}</div>
                        <div><strong>Destination:</strong> ${leg.end_address}</div>
                    </div>
                </div>
                <div class="space-y-2">
                    ${leg.steps.map((step, index) => `
                        <div class="flex items-start space-x-3 p-2 rounded-lg hover:bg-gray-50">
                            <div class="flex-shrink-0 w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-semibold">
                                ${index + 1}
                            </div>
                            <div class="text-sm text-gray-700">${step.instructions}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function startNavigation() {
            if (!selectedPackage) {
                alert('Please select a package first');
                return;
            }
            
            // In a real app, this would start turn-by-turn navigation
            alert(`Starting navigation to ${selectedPackage.pickupAddress}`);
        }

        function markAsPickedUp() {
            if (!selectedPackage) {
                alert('Please select a package first');
                return;
            }
            
            if (confirm(`Mark package ${selectedPackage.trackingNumber} as picked up?`)) {
                selectedPackage.status = 'picked-up';
                loadPackages();
                alert('Package marked as picked up!');
            }
        }

        function markAsDelivered() {
            if (!selectedPackage) {
                alert('Please select a package first');
                return;
            }
            
            if (confirm(`Mark package ${selectedPackage.trackingNumber} as delivered?`)) {
                selectedPackage.status = 'delivered';
                loadPackages();
                alert('Package marked as delivered!');
            }
        }

        function centerOnCurrentLocation() {
            if (currentLocation) {
                map.setCenter(currentLocation);
                map.setZoom(15);
            } else {
                getCurrentLocation();
            }
        }

        function toggleTraffic() {
            if (trafficLayer.getMap()) {
                trafficLayer.setMap(null);
            } else {
                trafficLayer.setMap(map);
            }
        }

        // Clean up location tracking when page unloads
        window.addEventListener('beforeunload', () => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
    </script>
</body>
</html>
