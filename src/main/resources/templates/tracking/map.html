<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Real-Time Driver Map</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'reliable': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        'reliable-yellow': {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            200: '#fed7aa',
                            300: '#fdba74',
                            400: '#fb923c',
                            500: '#f97316',
                            600: '#ea580c',
                            700: '#c2410c',
                            800: '#9a3412',
                            900: '#7c2d12',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'bounce-gentle': 'bounceGentle 2s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        bounceGentle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Maps API -->
    <script th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapsApiKey} + '&libraries=places,geometry&callback=initMap'" async defer></script>
    <!-- Unified Google Maps Utility -->
    <script th:src="@{/js/unified-google-maps.js}"></script>
</head>
<body class="h-screen w-screen relative overflow-hidden">
    <div class="h-full w-full relative">
        <!-- Map Container -->
        <div id="map" style="height: 100%; width: 100%;"></div>
        
        <!-- Map Info Panel -->
        <div class="absolute top-5 left-5 z-50 bg-white/95 backdrop-blur-md rounded-2xl p-4 shadow-lg max-w-xs">
            <h5 class="text-lg font-bold text-gray-800 mb-3">
                <i class="fas fa-map-marker-alt text-reliable-600 mr-2"></i>
                Real-Time Tracking
            </h5>
            
            <div class="mb-3">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Active Drivers:</span>
                    <span class="text-2xl font-bold text-reliable-600" id="activeDriverCount">0</span>
                </div>
            </div>
            
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Total Drivers:</span>
                    <span id="totalDriverCount">0</span>
                </div>
            </div>
            
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Last Update:</span>
                    <span id="lastUpdate">--</span>
                </div>
            </div>
            
            <div class="d-grid gap-2">
                <button class="control-btn" onclick="refreshMapData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="control-btn" id="realTimeBtn" onclick="toggleRealTime()">
                    <i class="fas fa-play"></i> <span id="realTimeText">Start Real-time</span>
                </button>
            </div>
        </div>
        
        <!-- Map Controls -->
        <div class="absolute top-5 right-5 z-50 bg-white/95 backdrop-blur-md rounded-2xl p-4 shadow-lg">
            <h6 class="text-sm font-bold text-gray-800 mb-3">Map Controls</h6>
            
            <div class="space-y-2">
                <button class="w-full bg-gradient-to-r from-reliable-600 to-reliable-700 hover:from-reliable-700 hover:to-reliable-800 text-white font-medium py-2 px-3 rounded-xl transition-all duration-300 transform hover:scale-105 text-sm" onclick="fitAllMarkers()">
                    <i class="fas fa-expand mr-1"></i> Fit All
                </button>
                <button class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-medium py-2 px-3 rounded-xl transition-all duration-300 transform hover:scale-105 text-sm" onclick="clearMap()">
                    <i class="fas fa-trash mr-1"></i> Clear
                </button>
                <button class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-medium py-2 px-3 rounded-xl transition-all duration-300 transform hover:scale-105 text-sm" onclick="toggleHeatmap()">
                    <i class="fas fa-fire mr-1"></i> Heatmap
                </button>
                <button class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-medium py-2 px-3 rounded-xl transition-all duration-300 transform hover:scale-105 text-sm" onclick="exportMapData()">
                    <i class="fas fa-download mr-1"></i> Export
                </button>
            </div>
            
            <hr class="my-3 border-gray-300">
            
            <div class="flex items-center mb-2">
                <input class="w-4 h-4 text-reliable-600 border-gray-300 rounded focus:ring-reliable-500" type="checkbox" id="showOnlineDrivers" checked>
                <label class="ml-2 text-sm text-gray-700" for="showOnlineDrivers">
                    Show Online Drivers
                </label>
            </div>
            
            <div class="flex items-center mb-2">
                <input class="w-4 h-4 text-reliable-600 border-gray-300 rounded focus:ring-reliable-500" type="checkbox" id="showOfflineDrivers">
                <label class="ml-2 text-sm text-gray-700" for="showOfflineDrivers">
                    Show Offline Drivers
                </label>
            </div>
            
            <div class="flex items-center mb-2">
                <input class="w-4 h-4 text-reliable-600 border-gray-300 rounded focus:ring-reliable-500" type="checkbox" id="showTrails">
                <label class="ml-2 text-sm text-gray-700" for="showTrails">
                    Show Movement Trails
                </label>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-reliable-600"></div>
        </div>
    </div>

    <script>
        let map;
        let unifiedMap;
        let markers = {};
        let infoWindows = {};
        let driverTrails = {};
        let polylines = [];
        let realTimeInterval;
        let isRealTimeActive = false;
        let heatmapLayer = null;
        
        // Initialize Google Maps
        function initMap() {
            unifiedMap = new UnifiedGoogleMaps('map', {
                center: { lat: -26.2041, lng: 28.0473 }, // Johannesburg
                zoom: 10,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                fullscreenControl: true,
                scaleControl: true
            });
            map = unifiedMap.init();
            
            // Load map data after initialization
            loadMapData();
        }
        
        // Load map data
        async function loadMapData() {
            try {
                showLoading(true);
                const response = await fetch('/api/tracking/active-drivers');
                const drivers = await response.json();
                
                updateMapMarkers(drivers);
                updateMapInfo(drivers);
                showLoading(false);
                
            } catch (error) {
                console.error('Error loading map data:', error);
                showLoading(false);
            }
        }
        
        // Update map markers
        function updateMapMarkers(drivers) {
            if (!unifiedMap || !map) return;
            
            // Clear existing markers
            unifiedMap.clearMarkers();
            markers = {};
            infoWindows = {};
            
            // Filter drivers based on checkboxes
            const showOnline = document.getElementById('showOnlineDrivers')?.checked !== false;
            const showOffline = document.getElementById('showOfflineDrivers')?.checked || false;
            
            const filteredDrivers = drivers.filter(driver => {
                if (driver.isOnline && showOnline) return true;
                if (!driver.isOnline && showOffline) return true;
                return false;
            });
            
            filteredDrivers.forEach(driver => {
                if (driver.latitude && driver.longitude) {
                    const marker = createDriverMarker(driver);
                    markers[driver.driverId] = marker;
                    
                    // Add to trail if enabled
                    if (document.getElementById('showTrails')?.checked) {
                        addToTrail(driver);
                    }
                }
            });
            
            // Fit bounds to show all markers
            unifiedMap.fitBounds();
        }
        
        // Create driver marker
        function createDriverMarker(driver) {
            // Determine marker icon color based on status
            let iconColor = '#4285F4'; // Default blue
            if (driver.isOnline || driver.status === 'ONLINE' || driver.status === 'IN_TRANSIT') {
                iconColor = '#34A853'; // Green
            } else if (!driver.isOnline || driver.status === 'OFFLINE') {
                iconColor = '#EA4335'; // Red
            }
            
            const markerIcon = {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 12,
                fillColor: iconColor,
                fillOpacity: 1,
                strokeColor: '#FFFFFF',
                strokeWeight: 2
            };
            
            const infoContent = `
                <div style="min-width: 200px;">
                    <h6 style="font-weight: bold; margin-bottom: 8px;">${driver.driverName || 'Driver'}</h6>
                    <p style="margin: 4px 0;"><strong>Vehicle:</strong> ${driver.vehicleModel || 'N/A'}</p>
                    <p style="margin: 4px 0;"><strong>Plate:</strong> ${driver.vehiclePlate || 'N/A'}</p>
                    <p style="margin: 4px 0;"><strong>Status:</strong> <span style="color: ${iconColor};">${driver.status || 'Unknown'}</span></p>
                    <p style="margin: 4px 0;"><strong>Last Update:</strong> ${driver.formattedTimestamp || 'N/A'}</p>
                    <button onclick="showDriverDetails(${driver.driverId})" style="margin-top: 8px; padding: 6px 12px; background: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        View Details
                    </button>
                </div>
            `;
            
            return unifiedMap.addMarker(driver.driverId, {
                lat: driver.latitude,
                lng: driver.longitude
            }, {
                title: driver.driverName || 'Driver',
                icon: markerIcon,
                content: infoContent
            });
        }
        
        // Update map info
        function updateMapInfo(drivers) {
            const activeDrivers = drivers.filter(d => d.isOnline).length;
            const totalDrivers = drivers.length;
            
            document.getElementById('activeDriverCount').textContent = activeDrivers;
            document.getElementById('totalDriverCount').textContent = totalDrivers;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }
        
        // Refresh map data
        function refreshMapData() {
            loadMapData();
        }
        
        // Toggle real-time updates
        function toggleRealTime() {
            if (isRealTimeActive) {
                stopRealTime();
            } else {
                startRealTime();
            }
        }
        
        // Start real-time updates
        function startRealTime() {
            isRealTimeActive = true;
            realTimeInterval = setInterval(loadMapData, 30000); // 30 seconds
            updateRealTimeButton(true);
        }
        
        // Stop real-time updates
        function stopRealTime() {
            isRealTimeActive = false;
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
                realTimeInterval = null;
            }
            updateRealTimeButton(false);
        }
        
        // Update real-time button
        function updateRealTimeButton(isActive) {
            const btn = document.getElementById('realTimeBtn');
            const text = document.getElementById('realTimeText');
            if (btn && text) {
                if (isActive) {
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-danger');
                    text.textContent = 'Stop Real-time';
                } else {
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-primary');
                    text.textContent = 'Start Real-time';
                }
            }
        }
        
        // Fit all markers to view
        function fitAllMarkers() {
            if (unifiedMap) {
                unifiedMap.fitBounds();
            }
        }
        
        // Clear map
        function clearMap() {
            if (unifiedMap) {
                unifiedMap.clearMarkers();
            }
            driverTrails = {};
            polylines.forEach(polyline => polyline.setMap(null));
            polylines = [];
        }
        
        // Toggle heatmap (Google Maps Heatmap Layer)
        function toggleHeatmap() {
            if (!map) return;
            
            if (!heatmapLayer) {
                // Create heatmap data from markers
                const heatmapData = Object.values(markers).map(marker => {
                    const position = marker.getPosition();
                    return new google.maps.LatLng(position.lat(), position.lng());
                });
                
                heatmapLayer = new google.maps.visualization.HeatmapLayer({
                    data: heatmapData,
                    map: map
                });
            } else {
                heatmapLayer.setMap(null);
                heatmapLayer = null;
            }
        }
        
        // Export map data
        function exportMapData() {
            const data = {
                timestamp: new Date().toISOString(),
                drivers: Object.entries(markers).map(([driverId, marker]) => {
                    const position = marker.getPosition();
                    return {
                        driverId: driverId,
                        lat: position.lat(),
                        lng: position.lng()
                    };
                })
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `map-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Add to driver trail
        function addToTrail(driver) {
            if (!driverTrails[driver.driverId]) {
                driverTrails[driver.driverId] = [];
            }
            
            driverTrails[driver.driverId].push({ lat: driver.latitude, lng: driver.longitude });
            
            // Keep only last 20 points
            if (driverTrails[driver.driverId].length > 20) {
                driverTrails[driver.driverId].shift();
            }
            
            // Draw trail using Google Maps Polyline
            if (driverTrails[driver.driverId].length > 1) {
                const color = driver.isOnline ? '#34A853' : '#EA4335';
                const polyline = unifiedMap.addPolyline(driverTrails[driver.driverId], {
                    strokeColor: color,
                    strokeWeight: 3,
                    strokeOpacity: 0.7
                });
                polylines.push(polyline);
            }
        }
        
        // Show driver details
        function showDriverDetails(driverId) {
            // Navigate to driver details page
            window.location.href = `/tracking/driver/${driverId}`;
        }
        
        // Show loading
        function showLoading(show) {
            const loadingElement = document.getElementById('loadingIndicator');
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }
        
        // Initialize on page load
        // Note: initMap is called by Google Maps API callback
        function checkMapInitialized() {
            if (typeof google !== 'undefined' && google.maps && map) {
                // Map already initialized by callback
            } else {
                setTimeout(checkMapInitialized, 100);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            checkMapInitialized();
        });
    </script>
</body>
</html>
